{"nodes":[{"pos":[17,159],"content":"You can use both Windows.Networking.Sockets and Winsock to communicate with other devices as a Universal Windows Platform (UWP) app developer.","needQuote":true,"needEscape":true,"nodes":[{"content":"You can use both Windows.Networking.Sockets and Winsock to communicate with other devices as a Universal Windows Platform (UWP) app developer.","pos":[0,142]}]},{"pos":[167,174],"content":"Sockets","needQuote":true,"needEscape":true,"nodes":[{"content":"Sockets","pos":[0,7]}]},{"content":"Sockets","pos":[231,238]},{"content":"\\[ Updated for UWP apps on Windows 10.","pos":[240,278]},{"content":"For Windows 8.x articles, see the <bpt id=\"p1\">[</bpt>archive<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=619132)</ept> \\]","pos":[279,374],"source":" For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]"},{"content":"Important APIs","pos":[378,392]},{"content":"Windows.Networking.Sockets","pos":[403,429]},{"content":"Winsock","pos":[496,503]},{"content":"You can use both <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>Windows.Networking.Sockets<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226960)</ept> and <bpt id=\"p3\">[</bpt>Winsock<ept id=\"p3\">](https://msdn.microsoft.com/library/windows/desktop/ms737523)</ept> to communicate with other devices as a Universal Windows Platform (UWP) app developer.","pos":[567,836],"source":"You can use both [**Windows.Networking.Sockets**](https://msdn.microsoft.com/library/windows/apps/br226960) and [Winsock](https://msdn.microsoft.com/library/windows/desktop/ms737523) to communicate with other devices as a Universal Windows Platform (UWP) app developer."},{"content":"This topic provides in-depth guidance on using the <bpt id=\"p1\">**</bpt>Windows.Networking.Sockets<ept id=\"p1\">**</ept> namespace to perform networking operations.","pos":[837,962],"source":" This topic provides in-depth guidance on using the **Windows.Networking.Sockets** namespace to perform networking operations."},{"content":"Basic TCP socket operations","pos":[967,994]},{"content":"A TCP socket provides low-level network data transfers in either direction for long-lived connections.","pos":[996,1098]},{"content":"TCP sockets are the underlying feature used by most of the network protocols used on the Internet.","pos":[1099,1197]},{"content":"This section shows how to enable a UWP app to send and receive data with a TCP stream socket using the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>StreamSocket<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226882)</ept> and <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>StreamSocketListener<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/br226906)</ept> classes as part of the <bpt id=\"p5\">[</bpt><bpt id=\"p6\">**</bpt>Windows.Networking.Sockets<ept id=\"p6\">**</ept><ept id=\"p5\">](https://msdn.microsoft.com/library/windows/apps/br226960)</ept> namespace.","pos":[1198,1591],"source":" This section shows how to enable a UWP app to send and receive data with a TCP stream socket using the [**StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882) and [**StreamSocketListener**](https://msdn.microsoft.com/library/windows/apps/br226906) classes as part of the [**Windows.Networking.Sockets**](https://msdn.microsoft.com/library/windows/apps/br226960) namespace."},{"content":"For this section, we will be creating a very simple app that will function as an echo server and client to demonstrate basic TCP operations.","pos":[1592,1732]},{"content":"Creating a TCP echo server","pos":[1736,1762]},{"pos":[1766,1963],"content":"The following code example demonstrates how to create a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>StreamSocketListener<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226906)</ept> object and start listening for incoming TCP connections.","source":"The following code example demonstrates how to create a [**StreamSocketListener**](https://msdn.microsoft.com/library/windows/apps/br226906) object and start listening for incoming TCP connections."},{"content":"The following code example implements the SocketListener\\_ConnectionReceived event handler that was attached to the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>StreamSocketListener.ConnectionReceived<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/hh701494)</ept> event in the above example.","pos":[2568,2815],"source":"The following code example implements the SocketListener\\_ConnectionReceived event handler that was attached to the [**StreamSocketListener.ConnectionReceived**](https://msdn.microsoft.com/library/windows/apps/hh701494) event in the above example."},{"content":"This event handler is called by the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>StreamSocketListener<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226906)</ept> class every time a remote client has established a connection with the echo server.","pos":[2816,3020],"source":" This event handler is called by the [**StreamSocketListener**](https://msdn.microsoft.com/library/windows/apps/br226906) class every time a remote client has established a connection with the echo server."},{"content":"Creating a TCP echo client","pos":[3696,3722]},{"pos":[3726,3951],"content":"The following code example demonstrates how to create a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>StreamSocket<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226882)</ept> object, establish a connection to the remote server, send a request, and receive a response.","source":"The following code example demonstrates how to create a [**StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882) object, establish a connection to the remote server, send a request, and receive a response."},{"content":"Basic UDP socket operations","pos":[5235,5262]},{"content":"A UDP socket provides low-level network data transfers in either direction for network communication that does not require an established connection.","pos":[5264,5413]},{"content":"Because UDP sockets do not maintain connection on both endpoints they provide fast and simple solution for networking between remote machines.","pos":[5414,5556]},{"content":"However, UDP sockets do not ensure integrity of the network packets or whether they make it to the remote destination at all.","pos":[5557,5682]},{"content":"Some examples of applications that use UDP sockets are local network discovery and local chat clients.","pos":[5683,5785]},{"content":"This section demonstrates the use of the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>DatagramSocket<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br241319)</ept> class to sending and receiving UDP messages by creating a simple echo server and client.","pos":[5786,5994],"source":" This section demonstrates the use of the [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319) class to sending and receiving UDP messages by creating a simple echo server and client."},{"content":"Creating a UDP echo server","pos":[5998,6024]},{"pos":[6028,6250],"content":"The following code example demonstrates how to create a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>DatagramSocket<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br241319)</ept> object and bind it to a specific port so that you can listen for incoming UDP messages.","source":"The following code example demonstrates how to create a [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319) object and bind it to a specific port so that you can listen for incoming UDP messages."},{"pos":[6681,6846],"content":"The following code example implements the <bpt id=\"p1\">**</bpt>Socket\\_MessageReceived<ept id=\"p1\">**</ept> event handler to read a message that was received from a client and send the same message back.","source":"The following code example implements the **Socket\\_MessageReceived** event handler to read a message that was received from a client and send the same message back."},{"content":"Creating a UDP echo client","pos":[7833,7859]},{"pos":[7863,8131],"content":"The following code example demonstrates how to create a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>DatagramSocket<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br241319)</ept> object and bind it to a specific port so that you can listen for incoming UDP messages and send a UDP message to the UDP echo server.","source":"The following code example demonstrates how to create a [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319) object and bind it to a specific port so that you can listen for incoming UDP messages and send a UDP message to the UDP echo server."},{"pos":[9352,9497],"content":"The following code example implements the <bpt id=\"p1\">**</bpt>Socket\\_MessageReceived<ept id=\"p1\">**</ept> event handler to read a message that was received from the UDP echo server.","source":"The following code example implements the **Socket\\_MessageReceived** event handler to read a message that was received from the UDP echo server."},{"content":"Background operations and the socket broker","pos":[9924,9967]},{"content":"If your app receives connections or data on sockets, then you must be prepared to perform those operations properly while your app is not in the foreground.","pos":[9969,10125]},{"content":"To do so, you use the socket broker.","pos":[10126,10162]},{"content":"For more information on how to use the socket broker, see <bpt id=\"p1\">[</bpt>Network communications in the background<ept id=\"p1\">](network-communications-in-the-background.md)</ept>.","pos":[10163,10309],"source":" For more information on how to use the socket broker, see [Network communications in the background](network-communications-in-the-background.md)."},{"content":"Batched sends","pos":[10314,10327]},{"content":"Starting with Windows 10, Windows.Networking.Sockets supports batched sends, a way for you to send multiple buffers of data together with much lower context-switching overhead than if you send each of the buffers separately.","pos":[10329,10553]},{"content":"This is especially useful if your app is doing VoIP, VPN, or other tasks which involve moving a lot of data as efficiently as possible.","pos":[10554,10689]},{"content":"Each call to WriteAsync on a socket triggers a kernel transition to reach the network stack.","pos":[10691,10783]},{"content":"When an app writes many buffers at a time, each write incurs a separate kernel transition, and this creates substantial overhead.","pos":[10784,10913]},{"content":"The new batched sends pattern optimizes the frequency of kernel transitions.","pos":[10914,10990]},{"content":"This functionality is currently limited to <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>StreamSocket<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226882)</ept> and connected <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>DatagramSocket<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/br241319)</ept> instances.","pos":[10991,11214],"source":" This functionality is currently limited to [**StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882) and connected [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319) instances."},{"content":"Here is an example of how an app would send a large number of buffers in a non-optimal way.","pos":[11216,11307]},{"content":"This example shows a more efficient way to send a large number of buffers.","pos":[11682,11756]},{"content":"Because this technique uses features unique to the C# language, it is only available to C# programmers.","pos":[11757,11860]},{"content":"By sending multiple packets at a time, this example enables the system to batch sends, and thus optimize kernel transitions for improved performance.","pos":[11861,12010]},{"content":"This example shows another way to send a large number of buffers in a way that's compatible with batched sends.","pos":[12646,12757]},{"content":"And since it doesn't use any C#-specific features, it is applicable for all languages (though it is demonstrated here in C#).","pos":[12758,12883]},{"content":"Instead, it uses changed behavior in the <bpt id=\"p1\">**</bpt>OutputStream<ept id=\"p1\">**</ept> member of the <bpt id=\"p2\">[</bpt><bpt id=\"p3\">**</bpt>StreamSocket<ept id=\"p3\">**</ept><ept id=\"p2\">](https://msdn.microsoft.com/library/windows/apps/br226882)</ept> and <bpt id=\"p4\">[</bpt><bpt id=\"p5\">**</bpt>DatagramSocket<ept id=\"p5\">**</ept><ept id=\"p4\">](https://msdn.microsoft.com/library/windows/apps/br241319)</ept> classes that is new in Windows 10.","pos":[12884,13150],"source":" Instead, it uses changed behavior in the **OutputStream** member of the [**StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882) and [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319) classes that is new in Windows 10."},{"content":"In earlier versions of Windows, <bpt id=\"p1\">**</bpt>FlushAsync<ept id=\"p1\">**</ept> returned immediately, and did not guarantee that all operations on the stream had completed yet.","pos":[13780,13923],"source":"In earlier versions of Windows, **FlushAsync** returned immediately, and did not guarantee that all operations on the stream had completed yet."},{"content":"In Windows 10, the behavior has changed.","pos":[13924,13964]},{"content":"<bpt id=\"p1\">**</bpt>FlushAsync<ept id=\"p1\">**</ept> is now guaranteed to return after all operations on the output stream have completed.","pos":[13965,14065],"source":"**FlushAsync** is now guaranteed to return after all operations on the output stream have completed."},{"content":"There are some important limitations imposed by using batched writes in your code.","pos":[14067,14149]},{"pos":[14155,14270],"content":"You cannot modify the contents of the <bpt id=\"p1\">**</bpt>IBuffer<ept id=\"p1\">**</ept> instances being written until the asynchronous write is complete.","source":"You cannot modify the contents of the **IBuffer** instances being written until the asynchronous write is complete."},{"pos":[14275,14382],"content":"The <bpt id=\"p1\">**</bpt>FlushAsync<ept id=\"p1\">**</ept> pattern only works on <bpt id=\"p2\">**</bpt>StreamSocket.OutputStream<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>DatagramSocket.OutputStream<ept id=\"p3\">**</ept>.","source":"The **FlushAsync** pattern only works on **StreamSocket.OutputStream** and **DatagramSocket.OutputStream**."},{"pos":[14387,14450],"content":"The <bpt id=\"p1\">**</bpt>FlushAsync<ept id=\"p1\">**</ept> pattern only works in Windows 10 and onward.","source":"The **FlushAsync** pattern only works in Windows 10 and onward."},{"pos":[14455,14530],"content":"In other cases, use <bpt id=\"p1\">**</bpt>Task.WaitAll<ept id=\"p1\">**</ept> instead of the <bpt id=\"p2\">**</bpt>FlushAsync<ept id=\"p2\">**</ept> pattern.","source":"In other cases, use **Task.WaitAll** instead of the **FlushAsync** pattern."},{"content":"Port sharing for DatagramSocket","pos":[14535,14566]},{"pos":[14568,14934],"content":"Windows 10 introduces a new <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>DatagramSocketControl<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/hh701190)</ept> property, <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>MulticastOnly<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn895368)</ept>, which enables you to specify that the <bpt id=\"p5\">**</bpt>DatagramSocket<ept id=\"p5\">**</ept> in question is able to coexist with other Win32 or WinRT multicast sockets bound to the same address/port.","source":"Windows 10 introduces a new [**DatagramSocketControl**](https://msdn.microsoft.com/library/windows/apps/hh701190) property, [**MulticastOnly**](https://msdn.microsoft.com/library/windows/apps/dn895368), which enables you to specify that the **DatagramSocket** in question is able to coexist with other Win32 or WinRT multicast sockets bound to the same address/port."},{"content":"Providing a client certificate with the StreamSocket class","pos":[14939,14997]},{"content":"The <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>Windows.Networking.StreamSocket<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226882)</ept> class supports using SSL/TLS to authenticate the server the app is talking to.","pos":[14999,15177],"source":"The [**Windows.Networking.StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882) class supports using SSL/TLS to authenticate the server the app is talking to."},{"content":"In certain cases, the app also needs to authenticate itself to the server using a TLS client certificate.","pos":[15178,15283]},{"content":"In Windows 10, you can provide a client certificate on the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>StreamSocket.Control<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226893)</ept> object (this must be set before the TLS handshake is started).","pos":[15284,15490],"source":" In Windows 10, you can provide a client certificate on the [**StreamSocket.Control**](https://msdn.microsoft.com/library/windows/apps/br226893) object (this must be set before the TLS handshake is started)."},{"content":"If the server requests the client certificate, Windows will respond with the certificate provided.","pos":[15491,15589]},{"content":"Here is a code snippet showing how to implement this:","pos":[15591,15644]},{"content":"Exceptions in Windows.Networking.Sockets","pos":[15906,15946]},{"content":"The constructor for the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>HostName<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br207113)</ept> class used with sockets can throw an exception if the string passed is not a valid hostname (contains characters that are not allowed in a host name).","pos":[15948,16195],"source":"The constructor for the [**HostName**](https://msdn.microsoft.com/library/windows/apps/br207113) class used with sockets can throw an exception if the string passed is not a valid hostname (contains characters that are not allowed in a host name)."},{"content":"If an app gets input from the user for the <bpt id=\"p1\">**</bpt>HostName<ept id=\"p1\">**</ept>, the constructor should be in a try/catch block.","pos":[16196,16300],"source":" If an app gets input from the user for the **HostName**, the constructor should be in a try/catch block."},{"content":"If an exception is thrown, the app can notify the user and request a new hostname.","pos":[16301,16383]},{"content":"The <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>Windows.Networking.Sockets<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226960)</ept> namespace has convenient helper methods and enumerations for handling errors when using sockets and WebSockets.","pos":[16385,16591],"source":"The [**Windows.Networking.Sockets**](https://msdn.microsoft.com/library/windows/apps/br226960) namespace has convenient helper methods and enumerations for handling errors when using sockets and WebSockets."},{"content":"This can be useful for handling specific network exceptions differently in your app.","pos":[16592,16676]},{"content":"An error encountered on <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>DatagramSocket<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br241319)</ept>, <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>StreamSocket<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/br226882)</ept>, or <bpt id=\"p5\">[</bpt><bpt id=\"p6\">**</bpt>StreamSocketListener<ept id=\"p6\">**</ept><ept id=\"p5\">](https://msdn.microsoft.com/library/windows/apps/br226906)</ept> operation is returned as an <bpt id=\"p7\">**</bpt>HRESULT<ept id=\"p7\">**</ept> value.","pos":[16678,16994],"source":"An error encountered on [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319), [**StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882), or [**StreamSocketListener**](https://msdn.microsoft.com/library/windows/apps/br226906) operation is returned as an **HRESULT** value."},{"content":"The <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SocketError.GetStatus<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/hh701462)</ept> method is used to convert a network error from a socket operation to a <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SocketErrorStatus<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/hh701457)</ept> enumeration value.","pos":[16995,17256],"source":" The [**SocketError.GetStatus**](https://msdn.microsoft.com/library/windows/apps/hh701462) method is used to convert a network error from a socket operation to a [**SocketErrorStatus**](https://msdn.microsoft.com/library/windows/apps/hh701457) enumeration value."},{"content":"Most of the <bpt id=\"p1\">**</bpt>SocketErrorStatus<ept id=\"p1\">**</ept> enumeration values correspond to an error returned by the native Windows sockets operation.","pos":[17257,17382],"source":" Most of the **SocketErrorStatus** enumeration values correspond to an error returned by the native Windows sockets operation."},{"content":"An app can filter on specific <bpt id=\"p1\">**</bpt>SocketErrorStatus<ept id=\"p1\">**</ept> enumeration values to modify app behavior depending on the cause of the exception.","pos":[17383,17517],"source":" An app can filter on specific **SocketErrorStatus** enumeration values to modify app behavior depending on the cause of the exception."},{"content":"An error encountered on a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>MessageWebSocket<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226842)</ept> or <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>StreamWebSocket<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/br226923)</ept> operation is returned as an <bpt id=\"p5\">**</bpt>HRESULT<ept id=\"p5\">**</ept> value.","pos":[17519,17755],"source":"An error encountered on a [**MessageWebSocket**](https://msdn.microsoft.com/library/windows/apps/br226842) or [**StreamWebSocket**](https://msdn.microsoft.com/library/windows/apps/br226923) operation is returned as an **HRESULT** value."},{"content":"The <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>WebSocketError.GetStatus<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/hh701529)</ept> method is used to convert a network error from a WebSocket operation to a <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>WebErrorStatus<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/hh747818)</ept> enumeration value.","pos":[17756,18020],"source":" The [**WebSocketError.GetStatus**](https://msdn.microsoft.com/library/windows/apps/hh701529) method is used to convert a network error from a WebSocket operation to a [**WebErrorStatus**](https://msdn.microsoft.com/library/windows/apps/hh747818) enumeration value."},{"content":"Most of the <bpt id=\"p1\">**</bpt>WebErrorStatus<ept id=\"p1\">**</ept> enumeration values correspond to an error returned by the native HTTP client operation.","pos":[18021,18139],"source":" Most of the **WebErrorStatus** enumeration values correspond to an error returned by the native HTTP client operation."},{"content":"An app can filter on specific <bpt id=\"p1\">**</bpt>WebErrorStatus<ept id=\"p1\">**</ept> enumeration values to modify app behavior depending on the cause of the exception.","pos":[18140,18271],"source":" An app can filter on specific **WebErrorStatus** enumeration values to modify app behavior depending on the cause of the exception."},{"content":"For parameter validation errors, an app can also use the <bpt id=\"p1\">**</bpt>HRESULT<ept id=\"p1\">**</ept> from the exception to learn more detailed information on the error that caused the exception.","pos":[18273,18435],"source":"For parameter validation errors, an app can also use the **HRESULT** from the exception to learn more detailed information on the error that caused the exception."},{"content":"Possible <bpt id=\"p1\">**</bpt>HRESULT<ept id=\"p1\">**</ept> values are listed in the <bpt id=\"p2\">*</bpt>Winerror.h<ept id=\"p2\">*</ept> header file.","pos":[18436,18507],"source":" Possible **HRESULT** values are listed in the *Winerror.h* header file."},{"content":"For most parameter validation errors, the <bpt id=\"p1\">**</bpt>HRESULT<ept id=\"p1\">**</ept> returned is <bpt id=\"p2\">**</bpt>E\\_INVALIDARG<ept id=\"p2\">**</ept>.","pos":[18508,18592],"source":" For most parameter validation errors, the **HRESULT** returned is **E\\_INVALIDARG**."},{"content":"The Winsock API","pos":[18597,18612]},{"content":"You can use <bpt id=\"p1\">[</bpt>Winsock<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/ms740673)</ept> in your UWP app, as well.","pos":[18614,18722],"source":"You can use [Winsock](https://msdn.microsoft.com/library/windows/desktop/ms740673) in your UWP app, as well."},{"content":"The supported Winsock API is based on that of Windows Phone 8.1Microsoft Silverlight and continues to support most of the types, properties and methods (some APIs that are considered obsolete have been removed).","pos":[18723,18934]},{"content":"You can find more information on Winsock programming <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/ms740673)</ept>.","pos":[18935,19056],"source":" You can find more information on Winsock programming [here](https://msdn.microsoft.com/library/windows/desktop/ms740673)."}],"content":"---\ndescription: You can use both Windows.Networking.Sockets and Winsock to communicate with other devices as a Universal Windows Platform (UWP) app developer.\ntitle: Sockets\nms.assetid: 23B10A3C-E33F-4CD6-92CB-0FFB491472D6\n---\n\n# Sockets\n\n\\[ Updated for UWP apps on Windows 10. For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]\n\n**Important APIs**\n\n-   [**Windows.Networking.Sockets**](https://msdn.microsoft.com/library/windows/apps/br226960)\n-   [Winsock](https://msdn.microsoft.com/library/windows/desktop/ms740673)\n\nYou can use both [**Windows.Networking.Sockets**](https://msdn.microsoft.com/library/windows/apps/br226960) and [Winsock](https://msdn.microsoft.com/library/windows/desktop/ms737523) to communicate with other devices as a Universal Windows Platform (UWP) app developer. This topic provides in-depth guidance on using the **Windows.Networking.Sockets** namespace to perform networking operations.\n\n## Basic TCP socket operations\n\nA TCP socket provides low-level network data transfers in either direction for long-lived connections. TCP sockets are the underlying feature used by most of the network protocols used on the Internet. This section shows how to enable a UWP app to send and receive data with a TCP stream socket using the [**StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882) and [**StreamSocketListener**](https://msdn.microsoft.com/library/windows/apps/br226906) classes as part of the [**Windows.Networking.Sockets**](https://msdn.microsoft.com/library/windows/apps/br226960) namespace. For this section, we will be creating a very simple app that will function as an echo server and client to demonstrate basic TCP operations.\n\n**Creating a TCP echo server**\n\nThe following code example demonstrates how to create a [**StreamSocketListener**](https://msdn.microsoft.com/library/windows/apps/br226906) object and start listening for incoming TCP connections.\n\n```csharp\ntry\n{\n    //Create a StreamSocketListener to start listening for TCP connections.\n    Windows.Networking.Sockets.StreamSocketListener socketListener = new Windows.Networking.Sockets.StreamSocketListener();\n\n    //Hook up an event handler to call when connections are received.\n    socketListener.ConnectionReceived += SocketListener_ConnectionReceived;\n\n    //Start listening for incoming TCP connections on the specified port. You can specify any port that' s not currently in use.\n    await socketListener.BindServiceNameAsync(\"1337\");\n}\ncatch (Exception e)\n{\n    //Handle exception.\n}\n```\n\nThe following code example implements the SocketListener\\_ConnectionReceived event handler that was attached to the [**StreamSocketListener.ConnectionReceived**](https://msdn.microsoft.com/library/windows/apps/hh701494) event in the above example. This event handler is called by the [**StreamSocketListener**](https://msdn.microsoft.com/library/windows/apps/br226906) class every time a remote client has established a connection with the echo server.\n\n```csharp\nprivate async void SocketListener_ConnectionReceived(Windows.Networking.Sockets.StreamSocketListener sender, \n    Windows.Networking.Sockets.StreamSocketListenerConnectionReceivedEventArgs args)\n{\n    //Read line from the remote client.\n    Stream inStream = args.Socket.InputStream.AsStreamForRead();\n    StreamReader reader = new StreamReader(inStream);\n    string request = await reader.ReadLineAsync();\n    \n    //Send the line back to the remote client.\n    Stream outStream = args.Socket.OutputStream.AsStreamForWrite();\n    StreamWriter writer = new StreamWriter(outStream);\n    await writer.WriteLineAsync(request);\n    await writer.FlushAsync();\n}\n```\n\n**Creating a TCP echo client**\n\nThe following code example demonstrates how to create a [**StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882) object, establish a connection to the remote server, send a request, and receive a response.\n\n```csharp\ntry\n{\n    //Create the StreamSocket and establish a connection to the echo server.\n    Windows.Networking.Sockets.StreamSocket socket = new Windows.Networking.Sockets.StreamSocket();\n    \n    //The server hostname that we will be establishing a connection to. We will be running the server and client locally,\n    //so we will use localhost as the hostname.\n    Windows.Networking.HostName serverHost = new Windows.Networking.HostName(\"localhost\");\n    \n    //Every protocol typically has a standard port number. For example HTTP is typically 80, FTP is 20 and 21, etc.\n    //For the echo server/client application we will use a random port 1337.\n    string serverPort = \"1337\";\n    await socket.ConnectAsync(serverHost, serverPort);\n\n    //Write data to the echo server.\n    Stream streamOut = socket.OutputStream.AsStreamForWrite();\n    StreamWriter writer = new StreamWriter(streamOut);\n    string request = \"test\";\n    await writer.WriteLineAsync(request);\n    await writer.FlushAsync();\n\n    //Read data from the echo server.\n    Stream streamIn = socket.InputStream.AsStreamForRead();\n    StreamReader reader = new StreamReader(streamIn);\n    string response = await reader.ReadLineAsync();\n}\ncatch (Exception e)\n{\n    //Handle exception here.            \n}\n```\n\n## Basic UDP socket operations\n\nA UDP socket provides low-level network data transfers in either direction for network communication that does not require an established connection. Because UDP sockets do not maintain connection on both endpoints they provide fast and simple solution for networking between remote machines. However, UDP sockets do not ensure integrity of the network packets or whether they make it to the remote destination at all. Some examples of applications that use UDP sockets are local network discovery and local chat clients. This section demonstrates the use of the [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319) class to sending and receiving UDP messages by creating a simple echo server and client.\n\n**Creating a UDP echo server**\n\nThe following code example demonstrates how to create a [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319) object and bind it to a specific port so that you can listen for incoming UDP messages.\n\n```csharp\nWindows.Networking.Sockets.DatagramSocket socket = new Windows.Networking.Sockets.DatagramSocket();\n\nsocket.MessageReceived += Socket_MessageReceived;\n\n//You can use any port that is not currently in use already on the machine.\nstring serverPort = \"1337\";\n\n//Bind the socket to the serverPort so that we can start listening for UDP messages from the UDP echo client.\nawait socket.BindServiceNameAsync(serverPort);\n```\n\nThe following code example implements the **Socket\\_MessageReceived** event handler to read a message that was received from a client and send the same message back.\n\n```csharp\nprivate async void Socket_MessageReceived(Windows.Networking.Sockets.DatagramSocket sender, Windows.Networking.Sockets.DatagramSocketMessageReceivedEventArgs args)\n{\n    //Read the message that was received from the UDP echo client.\n    Stream streamIn = args.GetDataStream().AsStreamForRead();\n    StreamReader reader = new StreamReader(streamIn);\n    string message = await reader.ReadLineAsync();\n\n    //Create a new socket to send the same message back to the UDP echo client.\n    Windows.Networking.Sockets.DatagramSocket socket = new Windows.Networking.Sockets.DatagramSocket();\n    \n    //Use a separate port number for the UDP echo client because both will be unning on the same machine.\n    string clientPort = \"1338\"\n    Stream streamOut = (await socket.GetOutputStreamAsync(args.RemoteAddress, clientPort)).AsStreamForWrite();\n    StreamWriter writer = new StreamWriter(streamOut);\n    await writer.WriteLineAsync(message);\n    await writer.FlushAsync();\n}\n```\n\n**Creating a UDP echo client**\n\nThe following code example demonstrates how to create a [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319) object and bind it to a specific port so that you can listen for incoming UDP messages and send a UDP message to the UDP echo server.\n\n```csharp\nprivate async void testUdpSocketServer()\n{\n    Windows.Networking.Sockets.DatagramSocket socket = new Windows.Networking.Sockets.DatagramSocket();\n    \n    socket.MessageReceived += Socket_MessageReceived;\n    \n    //You can use any port that is not currently in use already on the machine. We will be using two separate and random \n    //ports for the client and server because both the will be running on the same machine.\n    string serverPort = \"1337\";\n    string clientPort = \"1338\";\n    \n    //Because we will be running the client and server on the same machine, we will use localhost as the hostname.\n    Windows.Networking.HostName serverHost = new Windows.Networking.HostName(\"localhost\");\n    \n    //Bind the socket to the clientPort so that we can start listening for UDP messages from the UDP echo server.\n    await socket.BindServiceNameAsync(clientPort);\n                \n    //Write a message to the UDP echo server.\n    Stream streamOut = (await socket.GetOutputStreamAsync(serverHost, serverPort)).AsStreamForWrite();\n    StreamWriter writer = new StreamWriter(streamOut);\n    string message = \"Hello, world!\";\n    await writer.WriteLineAsync(message);\n    await writer.FlushAsync();\n}\n```\n\nThe following code example implements the **Socket\\_MessageReceived** event handler to read a message that was received from the UDP echo server.\n\n```csharp\nprivate async void Socket_MessageReceived(Windows.Networking.Sockets.DatagramSocket sender, \n    Windows.Networking.Sockets.DatagramSocketMessageReceivedEventArgs args)\n{\n    //Read the message that was received from the UDP echo server.\n    Stream streamIn = args.GetDataStream().AsStreamForRead();\n    StreamReader reader = new StreamReader(streamIn);\n    string message = await reader.ReadLineAsync();\n}\n```\n\n## Background operations and the socket broker\n\nIf your app receives connections or data on sockets, then you must be prepared to perform those operations properly while your app is not in the foreground. To do so, you use the socket broker. For more information on how to use the socket broker, see [Network communications in the background](network-communications-in-the-background.md).\n\n## Batched sends\n\nStarting with Windows 10, Windows.Networking.Sockets supports batched sends, a way for you to send multiple buffers of data together with much lower context-switching overhead than if you send each of the buffers separately. This is especially useful if your app is doing VoIP, VPN, or other tasks which involve moving a lot of data as efficiently as possible.\n\nEach call to WriteAsync on a socket triggers a kernel transition to reach the network stack. When an app writes many buffers at a time, each write incurs a separate kernel transition, and this creates substantial overhead. The new batched sends pattern optimizes the frequency of kernel transitions. This functionality is currently limited to [**StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882) and connected [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319) instances.\n\nHere is an example of how an app would send a large number of buffers in a non-optimal way.\n\n```csharp\n// Send a set of packets inefficiently, one packet at a time.\n// This is not recommended if you have many packets to send\nIList<IBuffer> packetsToSend = PreparePackets();\nvar outputStream = stream.OutputStream;\n\nforeach (IBuffer packet in packetsToSend)\n{\n    // Incurs kernel transition overhead for each packet\n    await outputStream.WriteAsync(packet);\n}\n```\n\nThis example shows a more efficient way to send a large number of buffers. Because this technique uses features unique to the C# language, it is only available to C# programmers. By sending multiple packets at a time, this example enables the system to batch sends, and thus optimize kernel transitions for improved performance.\n\n```csharp\n// More efficient way to send packets.\n// This way enables the system to do batched sends\nIList<IBuffer> packetsToSend = PreparePackets();\nvar outputStream = stream.OutputStream;\n\nint i = 0;\nTask[] pendingTasks = new Tast[packetsToSend.Count];\nforeach (IBuffer packet in packetsToSend)\n{\n    // track all pending writes as tasks, but do not wait on one before peforming the next\n    pendingTasks[i++] = outputStream.WriteAsync(packet).AsTask();\n    // Do not modify any buffer' s contents until the pending writes are complete.\n}\n// Now, wait for all of the pending writes to complete\nawait Task.WaitAll(pendingTasks);\n```\n\nThis example shows another way to send a large number of buffers in a way that's compatible with batched sends. And since it doesn't use any C#-specific features, it is applicable for all languages (though it is demonstrated here in C#). Instead, it uses changed behavior in the **OutputStream** member of the [**StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882) and [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319) classes that is new in Windows 10.\n\n```csharp\n// More efficient way to send packets in Windows 10, using the new behavior of OutputStream.FlushAsync().\nint i = 0;\nIList<IBuffer> packetsToSend = PreparePackets();\nvar outputStream = socket.OutputStream;\n\nvar pendingWrites = new IAsyncOperationWithProgress<uint,uint> [packetsToSend.Count];\n\nforeach (IBuffer packet in packetsToSend)\n{\n    pendingWrites[i++] = outputStream.WriteAsync(packet);\n    // Do not modify any buffer' s contents until the pending writes are complete.\n}\n\n// Wait for all pending writes to complete. This step enables batched sends on the output stream.\nawait outputStream.FlushAsync();\n```\n\nIn earlier versions of Windows, **FlushAsync** returned immediately, and did not guarantee that all operations on the stream had completed yet. In Windows 10, the behavior has changed. **FlushAsync** is now guaranteed to return after all operations on the output stream have completed.\n\nThere are some important limitations imposed by using batched writes in your code.\n\n-   You cannot modify the contents of the **IBuffer** instances being written until the asynchronous write is complete.\n-   The **FlushAsync** pattern only works on **StreamSocket.OutputStream** and **DatagramSocket.OutputStream**.\n-   The **FlushAsync** pattern only works in Windows 10 and onward.\n-   In other cases, use **Task.WaitAll** instead of the **FlushAsync** pattern.\n\n## Port sharing for DatagramSocket\n\nWindows 10 introduces a new [**DatagramSocketControl**](https://msdn.microsoft.com/library/windows/apps/hh701190) property, [**MulticastOnly**](https://msdn.microsoft.com/library/windows/apps/dn895368), which enables you to specify that the **DatagramSocket** in question is able to coexist with other Win32 or WinRT multicast sockets bound to the same address/port.\n\n## Providing a client certificate with the StreamSocket class\n\nThe [**Windows.Networking.StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882) class supports using SSL/TLS to authenticate the server the app is talking to. In certain cases, the app also needs to authenticate itself to the server using a TLS client certificate. In Windows 10, you can provide a client certificate on the [**StreamSocket.Control**](https://msdn.microsoft.com/library/windows/apps/br226893) object (this must be set before the TLS handshake is started). If the server requests the client certificate, Windows will respond with the certificate provided.\n\nHere is a code snippet showing how to implement this:\n\n```csharp\nvar socket = new StreamSocket();\nWindows.Security.Cryptography.Certificates.Certificate certificate = await GetClientCert();\nsocket.Control.ClientCertificate = certificate;\nawait socket.ConnectAsync(destination, SocketProtectionLevel.Tls12);\n```\n\n## Exceptions in Windows.Networking.Sockets\n\nThe constructor for the [**HostName**](https://msdn.microsoft.com/library/windows/apps/br207113) class used with sockets can throw an exception if the string passed is not a valid hostname (contains characters that are not allowed in a host name). If an app gets input from the user for the **HostName**, the constructor should be in a try/catch block. If an exception is thrown, the app can notify the user and request a new hostname.\n\nThe [**Windows.Networking.Sockets**](https://msdn.microsoft.com/library/windows/apps/br226960) namespace has convenient helper methods and enumerations for handling errors when using sockets and WebSockets. This can be useful for handling specific network exceptions differently in your app.\n\nAn error encountered on [**DatagramSocket**](https://msdn.microsoft.com/library/windows/apps/br241319), [**StreamSocket**](https://msdn.microsoft.com/library/windows/apps/br226882), or [**StreamSocketListener**](https://msdn.microsoft.com/library/windows/apps/br226906) operation is returned as an **HRESULT** value. The [**SocketError.GetStatus**](https://msdn.microsoft.com/library/windows/apps/hh701462) method is used to convert a network error from a socket operation to a [**SocketErrorStatus**](https://msdn.microsoft.com/library/windows/apps/hh701457) enumeration value. Most of the **SocketErrorStatus** enumeration values correspond to an error returned by the native Windows sockets operation. An app can filter on specific **SocketErrorStatus** enumeration values to modify app behavior depending on the cause of the exception.\n\nAn error encountered on a [**MessageWebSocket**](https://msdn.microsoft.com/library/windows/apps/br226842) or [**StreamWebSocket**](https://msdn.microsoft.com/library/windows/apps/br226923) operation is returned as an **HRESULT** value. The [**WebSocketError.GetStatus**](https://msdn.microsoft.com/library/windows/apps/hh701529) method is used to convert a network error from a WebSocket operation to a [**WebErrorStatus**](https://msdn.microsoft.com/library/windows/apps/hh747818) enumeration value. Most of the **WebErrorStatus** enumeration values correspond to an error returned by the native HTTP client operation. An app can filter on specific **WebErrorStatus** enumeration values to modify app behavior depending on the cause of the exception.\n\nFor parameter validation errors, an app can also use the **HRESULT** from the exception to learn more detailed information on the error that caused the exception. Possible **HRESULT** values are listed in the *Winerror.h* header file. For most parameter validation errors, the **HRESULT** returned is **E\\_INVALIDARG**.\n\n## The Winsock API\n\nYou can use [Winsock](https://msdn.microsoft.com/library/windows/desktop/ms740673) in your UWP app, as well. The supported Winsock API is based on that of Windows Phone 8.1Microsoft Silverlight and continues to support most of the types, properties and methods (some APIs that are considered obsolete have been removed). You can find more information on Winsock programming [here](https://msdn.microsoft.com/library/windows/desktop/ms740673).\n\n\n"}