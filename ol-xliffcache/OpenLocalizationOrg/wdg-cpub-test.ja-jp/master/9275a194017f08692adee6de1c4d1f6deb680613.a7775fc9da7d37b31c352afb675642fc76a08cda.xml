{"nodes":[{"pos":[85,194],"content":"This article describes how to create Universal Windows Platform (UWP) apps that play audio in the background.","needQuote":true,"needEscape":true,"nodes":[{"content":"This article describes how to create Universal Windows Platform (UWP) apps that play audio in the background.","pos":[0,109]}]},{"pos":[202,218],"content":"Background Audio","needQuote":true,"needEscape":true,"nodes":[{"content":"Background Audio","pos":[0,16]}]},{"content":"Background Audio","pos":[226,242]},{"content":"\\[ Updated for UWP apps on Windows 10.","pos":[244,282]},{"content":"For Windows 8.x articles, see the <bpt id=\"p1\">[</bpt>archive<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=619132)</ept> \\]","pos":[283,378],"source":" For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]"},{"content":"This article describes how to create Universal Windows Platform (UWP) apps that play audio in the background.","pos":[381,490]},{"content":"This means that even after the user has minimized your app, returned to the home screen, or has navigated away from your app in some other way, your app can continue to play audio.","pos":[491,671]},{"content":"This article discusses the components of a background audio app and how they work together.","pos":[672,763]},{"content":"Scenarios for background audio playback include:","pos":[765,813]},{"pos":[819,1003],"content":"<bpt id=\"p1\">**</bpt>Long-running playlists:<ept id=\"p1\">**</ept> The user briefly brings up a foreground app to select and start a playlist, after which the user expects the playlist to continue playing in the background.","source":"**Long-running playlists:** The user briefly brings up a foreground app to select and start a playlist, after which the user expects the playlist to continue playing in the background."},{"content":"<bpt id=\"p1\">**</bpt>Using task switcher:<ept id=\"p1\">**</ept> The user briefly brings up a foreground app to start playing audio, then switches to another open app using the task switcher.","pos":[1009,1160],"source":"**Using task switcher:** The user briefly brings up a foreground app to start playing audio, then switches to another open app using the task switcher."},{"content":"The user expects the audio to continue playing in the background.","pos":[1161,1226]},{"content":"The background audio implementation described in this article will allow your app to run universally on all Windows devices including Mobile, Desktop, and Xbox.","pos":[1228,1388]},{"content":"Note","pos":[1392,1396]},{"content":"The <bpt id=\"p1\">[</bpt>Background audio UWP sample<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=619485)</ept> implements the code discussed in this overview.","pos":[1401,1529],"source":"The [Background audio UWP sample](http://go.microsoft.com/fwlink/?LinkId=619485) implements the code discussed in this overview."},{"content":"You can download the sample to see the code in context or to use as a starting point for your own app.","pos":[1530,1632]},{"content":"Background audio architecture","pos":[1640,1669]},{"content":"An app performing background playback consists of two processes.","pos":[1671,1735]},{"content":"The first process is the main app, which contains the app UI and client logic, running in the foreground.","pos":[1736,1841]},{"content":"The second process is the background playback task, which implements <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IBackgroundTask<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br224794)</ept> like all UWP app background tasks.","pos":[1842,2025],"source":" The second process is the background playback task, which implements [**IBackgroundTask**](https://msdn.microsoft.com/library/windows/apps/br224794) like all UWP app background tasks."},{"content":"The background task contains the audio playback logic and background services.","pos":[2026,2104]},{"content":"The background task communicates with the system through the System Media Transport Controls.","pos":[2105,2198]},{"content":"The following diagram is an overview of how the system is designed.","pos":[2200,2267]},{"content":"windows 10 background audio architecture","pos":[2271,2311]},{"content":"MediaPlayer","pos":[2363,2374]},{"content":"The <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>Windows.Media.Playback<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn640562)</ept> namespace contains APIs used to play audio in the background.","pos":[2376,2528],"source":"The [**Windows.Media.Playback**](https://msdn.microsoft.com/library/windows/apps/dn640562) namespace contains APIs used to play audio in the background."},{"content":"There is a single instance of <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>MediaPlayer<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn652535)</ept> per app through which playback occurs.","pos":[2529,2673],"source":" There is a single instance of [**MediaPlayer**](https://msdn.microsoft.com/library/windows/apps/dn652535) per app through which playback occurs."},{"content":"Your background audio app calls methods and sets properties on the <bpt id=\"p1\">**</bpt>MediaPlayer<ept id=\"p1\">**</ept> class to set the current track, start playback, pause, fast forward, rewind, and so on.","pos":[2674,2844],"source":" Your background audio app calls methods and sets properties on the **MediaPlayer** class to set the current track, start playback, pause, fast forward, rewind, and so on."},{"content":"The media player object instance is always accessed through the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>BackgroundMediaPlayer.Current<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn652528)</ept> property.","pos":[2845,3012],"source":" The media player object instance is always accessed through the [**BackgroundMediaPlayer.Current**](https://msdn.microsoft.com/library/windows/apps/dn652528) property."},{"content":"MediaPlayer Proxy and Stub","pos":[3017,3043]},{"pos":[3045,3234],"content":"When <bpt id=\"p1\">**</bpt>BackgroundMediaPlayer.Current<ept id=\"p1\">**</ept> is accessed from your app's background process, the <bpt id=\"p2\">**</bpt>MediaPlayer<ept id=\"p2\">**</ept> instance is activated in the background task host and can be manipulated directly.","source":"When **BackgroundMediaPlayer.Current** is accessed from your app's background process, the **MediaPlayer** instance is activated in the background task host and can be manipulated directly."},{"content":"When <bpt id=\"p1\">**</bpt>BackgroundMediaPlayer.Current<ept id=\"p1\">**</ept> is accessed from the foreground application, the <bpt id=\"p2\">**</bpt>MediaPlayer<ept id=\"p2\">**</ept> instance that is returned is actually a proxy that communicates with a stub in the background process.","pos":[3236,3442],"source":"When **BackgroundMediaPlayer.Current** is accessed from the foreground application, the **MediaPlayer** instance that is returned is actually a proxy that communicates with a stub in the background process."},{"content":"This stub communicates with the actual <bpt id=\"p1\">**</bpt>MediaPlayer<ept id=\"p1\">**</ept> instance, which is also hosted in the background process.","pos":[3443,3555],"source":" This stub communicates with the actual **MediaPlayer** instance, which is also hosted in the background process."},{"content":"Both the foreground and background process can access most of the properties of the <bpt id=\"p1\">**</bpt>MediaPlayer<ept id=\"p1\">**</ept> instance, with the exception of <bpt id=\"p2\">[</bpt><bpt id=\"p3\">**</bpt>MediaPlayer.Source<ept id=\"p3\">**</ept><ept id=\"p2\">](https://msdn.microsoft.com/library/windows/apps/dn987010)</ept> and <bpt id=\"p4\">[</bpt><bpt id=\"p5\">**</bpt>MediaPlayer.SystemMediaTransportControls<ept id=\"p5\">**</ept><ept id=\"p4\">](https://msdn.microsoft.com/library/windows/apps/dn926635)</ept> which can only be accessed from the background process.","pos":[3557,3936],"source":"Both the foreground and background process can access most of the properties of the **MediaPlayer** instance, with the exception of [**MediaPlayer.Source**](https://msdn.microsoft.com/library/windows/apps/dn987010) and [**MediaPlayer.SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn926635) which can only be accessed from the background process."},{"content":"The foreground app and the background process can both receive notifications of media-specific events like <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>MediaOpened<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn652609)</ept>, <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>MediaEnded<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn652603)</ept>, and <bpt id=\"p5\">[</bpt><bpt id=\"p6\">**</bpt>MediaFailed<ept id=\"p6\">**</ept><ept id=\"p5\">](https://msdn.microsoft.com/library/windows/apps/dn652606)</ept>.","pos":[3937,4277],"source":" The foreground app and the background process can both receive notifications of media-specific events like [**MediaOpened**](https://msdn.microsoft.com/library/windows/apps/dn652609), [**MediaEnded**](https://msdn.microsoft.com/library/windows/apps/dn652603), and [**MediaFailed**](https://msdn.microsoft.com/library/windows/apps/dn652606)."},{"content":"Playback Lists","pos":[4282,4296]},{"content":"A common scenario for background audio applications is to play multiple items in a row.","pos":[4298,4385]},{"content":"This is most easily accomplished in your background process by using a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>MediaPlaybackList<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn930955)</ept> object, which can be set as a source on the <bpt id=\"p3\">**</bpt>MediaPlayer<ept id=\"p3\">**</ept> by assigning it to the <bpt id=\"p4\">[</bpt><bpt id=\"p5\">**</bpt>MediaPlayer.Source<ept id=\"p5\">**</ept><ept id=\"p4\">](https://msdn.microsoft.com/library/windows/apps/dn987010)</ept> property.","pos":[4386,4714],"source":" This is most easily accomplished in your background process by using a [**MediaPlaybackList**](https://msdn.microsoft.com/library/windows/apps/dn930955) object, which can be set as a source on the **MediaPlayer** by assigning it to the [**MediaPlayer.Source**](https://msdn.microsoft.com/library/windows/apps/dn987010) property."},{"pos":[4716,4836],"content":"It is not possible to access a <bpt id=\"p1\">**</bpt>MediaPlaybackList<ept id=\"p1\">**</ept> from the foreground process that was set in the background process.","source":"It is not possible to access a **MediaPlaybackList** from the foreground process that was set in the background process."},{"content":"System Media Transport Controls","pos":[4841,4872]},{"content":"A user may control audio playback without directly using your app's UI through means such as Bluetooth devices, SmartGlass, and the System Media Transport Controls.","pos":[4874,5038]},{"content":"Your background task uses the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SystemMediaTransportControls<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn278677)</ept> class to subscribe to these user-initiated system events.","pos":[5039,5219],"source":" Your background task uses the [**SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn278677) class to subscribe to these user-initiated system events."},{"content":"To get a <bpt id=\"p1\">**</bpt>SystemMediaTransportControls<ept id=\"p1\">**</ept> instance from within the background process, use the <bpt id=\"p2\">[</bpt><bpt id=\"p3\">**</bpt>MediaPlayer.SystemMediaTransportControls<ept id=\"p3\">**</ept><ept id=\"p2\">](https://msdn.microsoft.com/library/windows/apps/dn926635)</ept> property.","pos":[5221,5430],"source":"To get a **SystemMediaTransportControls** instance from within the background process, use the [**MediaPlayer.SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn926635) property."},{"content":"Foreground apps get an instance of the class by calling <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SystemMediaTransportControls.GetForCurrentView<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn278708)</ept>, but the instance returned is a foreground-only instance that does not relate to the background task.","pos":[5431,5699],"source":" Foreground apps get an instance of the class by calling [**SystemMediaTransportControls.GetForCurrentView**](https://msdn.microsoft.com/library/windows/apps/dn278708), but the instance returned is a foreground-only instance that does not relate to the background task."},{"content":"Sending Messages Between Tasks","pos":[5704,5734]},{"content":"There are times when you will want to communicate between the two processes of a background audio app.","pos":[5736,5838]},{"content":"For example, you might want the background task to notify the foreground task when a new track starts playing, and then send the new song title to the foreground task to display on the screen.","pos":[5839,6031]},{"content":"A simple communication mechanism raises events in both the foreground and background processes.","pos":[6033,6128]},{"content":"The <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SendMessageToForeground<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn652533)</ept> and <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SendMessageToBackground<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn652532)</ept> methods each invoke events in the corresponding process.","pos":[6129,6369],"source":" The [**SendMessageToForeground**](https://msdn.microsoft.com/library/windows/apps/dn652533) and [**SendMessageToBackground**](https://msdn.microsoft.com/library/windows/apps/dn652532) methods each invoke events in the corresponding process."},{"content":"Messages can be received by subscribing to the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>MessageReceivedFromBackground<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn652530)</ept> and <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>MessageReceivedFromForeground<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn652531)</ept> events.","pos":[6370,6616],"source":" Messages can be received by subscribing to the [**MessageReceivedFromBackground**](https://msdn.microsoft.com/library/windows/apps/dn652530) and [**MessageReceivedFromForeground**](https://msdn.microsoft.com/library/windows/apps/dn652531) events."},{"content":"Data can be passed as an argument to the send message methods that are then passed into the message received event handlers.","pos":[6618,6742]},{"content":"Pass data using the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ValueSet<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn636131)</ept> class.","pos":[6743,6842],"source":" Pass data using the [**ValueSet**](https://msdn.microsoft.com/library/windows/apps/dn636131) class."},{"content":"This class is a dictionary that contains a string as a key and other value types as values.","pos":[6843,6934]},{"content":"You can pass simple value types such as integers, strings, and booleans.","pos":[6935,7007]},{"content":"Note","pos":[7011,7015]},{"content":"Apps should only call <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SendMessageToForeground<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn652533)</ept> while the foreground app is running.","pos":[7020,7166],"source":"Apps should only call [**SendMessageToForeground**](https://msdn.microsoft.com/library/windows/apps/dn652533) while the foreground app is running."},{"content":"Attempting to call this method while the foreground app is not running will throw an exception.","pos":[7167,7262]},{"content":"An app is responsible for communicating the foreground app state to the background process.","pos":[7263,7354]},{"content":"This can be done using app lifecycle events, state values kept  in local storage, and messages between processes.","pos":[7355,7468]},{"content":"Background Task Life Cycle","pos":[7474,7500]},{"content":"The lifetime of a background task is closely tied to your app's current playback status.","pos":[7502,7590]},{"content":"For example, when the user pauses audio playback, the system may terminate or cancel your app depending on the circumstances.","pos":[7591,7716]},{"content":"After a period of time without audio playback, the system may automatically shut down the background task.","pos":[7717,7823]},{"content":"The <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IBackgroundTask.Run<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br224811)</ept> method is called the first time your app accesses either <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>BackgroundMediaPlayer.Current<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn652528)</ept> from code running in the foreground app or when you register a handler for the <bpt id=\"p5\">[</bpt><bpt id=\"p6\">**</bpt>MessageReceivedFromBackground<ept id=\"p6\">**</ept><ept id=\"p5\">](https://msdn.microsoft.com/library/windows/apps/dn652530)</ept> event, whichever occurs first.","pos":[7825,8267],"source":"The [**IBackgroundTask.Run**](https://msdn.microsoft.com/library/windows/apps/br224811) method is called the first time your app accesses either [**BackgroundMediaPlayer.Current**](https://msdn.microsoft.com/library/windows/apps/dn652528) from code running in the foreground app or when you register a handler for the [**MessageReceivedFromBackground**](https://msdn.microsoft.com/library/windows/apps/dn652530) event, whichever occurs first."},{"content":"It is recommended that you register for the message received handler before calling <bpt id=\"p1\">**</bpt>BackgroundMediaPlayer.Current<ept id=\"p1\">**</ept> for the first time so that the foreground app doesn't miss any messages sent from the background process.","pos":[8268,8491],"source":" It is recommended that you register for the message received handler before calling **BackgroundMediaPlayer.Current** for the first time so that the foreground app doesn't miss any messages sent from the background process."},{"content":"To keep the background task alive, your app must request a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>BackgroundTaskDeferral<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/hh700499)</ept> from within the <bpt id=\"p3\">**</bpt>Run<ept id=\"p3\">**</ept> method and call <bpt id=\"p4\">[</bpt><bpt id=\"p5\">**</bpt>BackgroundTaskDeferral.Complete<ept id=\"p5\">**</ept><ept id=\"p4\">](https://msdn.microsoft.com/library/windows/apps/hh700504)</ept> when the task instance receives the <bpt id=\"p6\">[</bpt><bpt id=\"p7\">**</bpt>Canceled<ept id=\"p7\">**</ept><ept id=\"p6\">](https://msdn.microsoft.com/library/windows/apps/br224798)</ept> or <bpt id=\"p8\">[</bpt><bpt id=\"p9\">**</bpt>Completed<ept id=\"p9\">**</ept><ept id=\"p8\">](https://msdn.microsoft.com/library/windows/apps/br224788)</ept> events.","pos":[8493,8968],"source":"To keep the background task alive, your app must request a [**BackgroundTaskDeferral**](https://msdn.microsoft.com/library/windows/apps/hh700499) from within the **Run** method and call [**BackgroundTaskDeferral.Complete**](https://msdn.microsoft.com/library/windows/apps/hh700504) when the task instance receives the [**Canceled**](https://msdn.microsoft.com/library/windows/apps/br224798) or [**Completed**](https://msdn.microsoft.com/library/windows/apps/br224788) events."},{"content":"Do not loop or wait in the <bpt id=\"p1\">**</bpt>Run<ept id=\"p1\">**</ept> method because this consumes resources and may cause your app's background task to be terminated by the system.","pos":[8969,9115],"source":" Do not loop or wait in the **Run** method because this consumes resources and may cause your app's background task to be terminated by the system."},{"content":"Your background task gets the <bpt id=\"p1\">**</bpt>Completed<ept id=\"p1\">**</ept> event when the <bpt id=\"p2\">**</bpt>Run<ept id=\"p2\">**</ept> method is completed and deferral is not requested.","pos":[9117,9234],"source":"Your background task gets the **Completed** event when the **Run** method is completed and deferral is not requested."},{"content":"In some cases, when your app gets the <bpt id=\"p1\">**</bpt>Canceled<ept id=\"p1\">**</ept> event, it can be also followed by the <bpt id=\"p2\">**</bpt>Completed<ept id=\"p2\">**</ept> event.","pos":[9235,9344],"source":" In some cases, when your app gets the **Canceled** event, it can be also followed by the **Completed** event."},{"content":"Your task may receive a <bpt id=\"p1\">**</bpt>Canceled<ept id=\"p1\">**</ept> event while <bpt id=\"p2\">**</bpt>Run<ept id=\"p2\">**</ept> is executing, so be sure to manage this potential concurrence.","pos":[9345,9464],"source":" Your task may receive a **Canceled** event while **Run** is executing, so be sure to manage this potential concurrence."},{"content":"Situations in which the background task can be cancelled include:","pos":[9466,9531]},{"content":"A new app with audio playback capabilities starts on systems that enforce the exclusivity sub-policy.","pos":[9537,9638]},{"content":"See the <bpt id=\"p1\">[</bpt>System policies for background audio task lifetime<ept id=\"p1\">](#system-policies-for-background-audio-task-lifetime)</ept> section below.","pos":[9639,9767],"source":" See the [System policies for background audio task lifetime](#system-policies-for-background-audio-task-lifetime) section below."},{"content":"A background task has been launched but music is not yet playing, and then the foreground app is suspended.","pos":[9773,9880]},{"content":"Other media interruptions, such as incoming phone calls or VoIP calls.","pos":[9886,9956]},{"content":"Situations in which the background task can be terminated without notice include:","pos":[9958,10039]},{"content":"A VoIP call comes in and there is not enough available memory on the system to keep the background task alive.","pos":[10045,10155]},{"content":"A resource policy is violated.","pos":[10161,10191]},{"content":"Task cancellation or completion does not end gracefully.","pos":[10197,10253]},{"content":"System policies for background audio task lifetime","pos":[10258,10308]},{"content":"The following policies help determine how the system manages the lifetime of background audio tasks.","pos":[10310,10410]},{"content":"Exclusivity","pos":[10416,10427]},{"content":"If enabled, this sub-policy limits the number of background audio tasks to be at most 1 at any given time.","pos":[10429,10535]},{"content":"It is enabled on Mobile and other non-Desktop SKUs.","pos":[10536,10587]},{"content":"Inactivity Timeout","pos":[10593,10611]},{"content":"Due to resource constraints, the system may terminate your background task after a period of inactivity.","pos":[10613,10717]},{"content":"A background task is considered “inactive” if both of the following conditions are met:","pos":[10719,10806]},{"content":"The foreground app is not visible (it is suspended or terminated).","pos":[10812,10878]},{"content":"The background media player is not in the playing state.","pos":[10884,10940]},{"content":"If both of these conditions are satisfied, the background media system policy will start a timer.","pos":[10942,11039]},{"content":"If neither condition has changed when the timer expires, the background media system policy will terminate the background task.","pos":[11040,11167]},{"content":"Shared Lifetime","pos":[11173,11188]},{"content":"If enabled, this sub-policy forces the background task to be dependent on the lifetime of the foreground task.","pos":[11190,11300]},{"content":"If the foreground task is shut down, either by the user or the system, the background task will also shut down.","pos":[11301,11412]},{"content":"However, note that this does not mean that the foreground is dependent on the background.","pos":[11414,11503]},{"content":"If the background task is shut down, this does not force the foreground task to shut down.","pos":[11504,11594]},{"content":"The following table lists the which policies are enforced on which device types.","pos":[11596,11676]},{"content":"Sub-policy","pos":[11680,11690]},{"content":"Desktop","pos":[11705,11712]},{"content":"Mobile","pos":[11716,11722]},{"content":"Other","pos":[11727,11732]},{"content":"Exclusivity","pos":[11802,11813]},{"content":"Disabled","pos":[11825,11833]},{"content":"Enabled","pos":[11836,11843]},{"content":"Enabled","pos":[11847,11854]},{"content":"Inactivity Timeout","pos":[11862,11880]},{"content":"Disabled","pos":[11885,11893]},{"content":"Enabled","pos":[11896,11903]},{"content":"Disabled","pos":[11907,11915]},{"content":"Shared Lifetime","pos":[11922,11937]},{"content":"Enabled","pos":[11945,11952]},{"content":"Disabled","pos":[11956,11964]},{"content":"Disabled","pos":[11967,11975]}],"content":"---\nauthor: drewbatgit\nms.assetid: 923D8156-81D3-4A1E-9D02-DB219F600FDB\ndescription: This article describes how to create Universal Windows Platform (UWP) apps that play audio in the background.\ntitle: Background Audio\n---\n\n# Background Audio\n\n\\[ Updated for UWP apps on Windows 10. For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]\n\n\nThis article describes how to create Universal Windows Platform (UWP) apps that play audio in the background. This means that even after the user has minimized your app, returned to the home screen, or has navigated away from your app in some other way, your app can continue to play audio. This article discusses the components of a background audio app and how they work together.\n\nScenarios for background audio playback include:\n\n-   **Long-running playlists:** The user briefly brings up a foreground app to select and start a playlist, after which the user expects the playlist to continue playing in the background.\n\n-   **Using task switcher:** The user briefly brings up a foreground app to start playing audio, then switches to another open app using the task switcher. The user expects the audio to continue playing in the background.\n\nThe background audio implementation described in this article will allow your app to run universally on all Windows devices including Mobile, Desktop, and Xbox.\n\n**Note**  \nThe [Background audio UWP sample](http://go.microsoft.com/fwlink/?LinkId=619485) implements the code discussed in this overview. You can download the sample to see the code in context or to use as a starting point for your own app.\n\n \n\n## Background audio architecture\n\nAn app performing background playback consists of two processes. The first process is the main app, which contains the app UI and client logic, running in the foreground. The second process is the background playback task, which implements [**IBackgroundTask**](https://msdn.microsoft.com/library/windows/apps/br224794) like all UWP app background tasks. The background task contains the audio playback logic and background services. The background task communicates with the system through the System Media Transport Controls.\n\nThe following diagram is an overview of how the system is designed.\n\n![windows 10 background audio architecture](images/backround-audio-architecture-win10.png)\n## MediaPlayer\n\nThe [**Windows.Media.Playback**](https://msdn.microsoft.com/library/windows/apps/dn640562) namespace contains APIs used to play audio in the background. There is a single instance of [**MediaPlayer**](https://msdn.microsoft.com/library/windows/apps/dn652535) per app through which playback occurs. Your background audio app calls methods and sets properties on the **MediaPlayer** class to set the current track, start playback, pause, fast forward, rewind, and so on. The media player object instance is always accessed through the [**BackgroundMediaPlayer.Current**](https://msdn.microsoft.com/library/windows/apps/dn652528) property.\n\n## MediaPlayer Proxy and Stub\n\nWhen **BackgroundMediaPlayer.Current** is accessed from your app's background process, the **MediaPlayer** instance is activated in the background task host and can be manipulated directly.\n\nWhen **BackgroundMediaPlayer.Current** is accessed from the foreground application, the **MediaPlayer** instance that is returned is actually a proxy that communicates with a stub in the background process. This stub communicates with the actual **MediaPlayer** instance, which is also hosted in the background process.\n\nBoth the foreground and background process can access most of the properties of the **MediaPlayer** instance, with the exception of [**MediaPlayer.Source**](https://msdn.microsoft.com/library/windows/apps/dn987010) and [**MediaPlayer.SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn926635) which can only be accessed from the background process. The foreground app and the background process can both receive notifications of media-specific events like [**MediaOpened**](https://msdn.microsoft.com/library/windows/apps/dn652609), [**MediaEnded**](https://msdn.microsoft.com/library/windows/apps/dn652603), and [**MediaFailed**](https://msdn.microsoft.com/library/windows/apps/dn652606).\n\n## Playback Lists\n\nA common scenario for background audio applications is to play multiple items in a row. This is most easily accomplished in your background process by using a [**MediaPlaybackList**](https://msdn.microsoft.com/library/windows/apps/dn930955) object, which can be set as a source on the **MediaPlayer** by assigning it to the [**MediaPlayer.Source**](https://msdn.microsoft.com/library/windows/apps/dn987010) property.\n\nIt is not possible to access a **MediaPlaybackList** from the foreground process that was set in the background process.\n\n## System Media Transport Controls\n\nA user may control audio playback without directly using your app's UI through means such as Bluetooth devices, SmartGlass, and the System Media Transport Controls. Your background task uses the [**SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn278677) class to subscribe to these user-initiated system events.\n\nTo get a **SystemMediaTransportControls** instance from within the background process, use the [**MediaPlayer.SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn926635) property. Foreground apps get an instance of the class by calling [**SystemMediaTransportControls.GetForCurrentView**](https://msdn.microsoft.com/library/windows/apps/dn278708), but the instance returned is a foreground-only instance that does not relate to the background task.\n\n## Sending Messages Between Tasks\n\nThere are times when you will want to communicate between the two processes of a background audio app. For example, you might want the background task to notify the foreground task when a new track starts playing, and then send the new song title to the foreground task to display on the screen.\n\nA simple communication mechanism raises events in both the foreground and background processes. The [**SendMessageToForeground**](https://msdn.microsoft.com/library/windows/apps/dn652533) and [**SendMessageToBackground**](https://msdn.microsoft.com/library/windows/apps/dn652532) methods each invoke events in the corresponding process. Messages can be received by subscribing to the [**MessageReceivedFromBackground**](https://msdn.microsoft.com/library/windows/apps/dn652530) and [**MessageReceivedFromForeground**](https://msdn.microsoft.com/library/windows/apps/dn652531) events.\n\nData can be passed as an argument to the send message methods that are then passed into the message received event handlers. Pass data using the [**ValueSet**](https://msdn.microsoft.com/library/windows/apps/dn636131) class. This class is a dictionary that contains a string as a key and other value types as values. You can pass simple value types such as integers, strings, and booleans.\n\n**Note**  \nApps should only call [**SendMessageToForeground**](https://msdn.microsoft.com/library/windows/apps/dn652533) while the foreground app is running. Attempting to call this method while the foreground app is not running will throw an exception. An app is responsible for communicating the foreground app state to the background process. This can be done using app lifecycle events, state values kept  in local storage, and messages between processes. \n\n## Background Task Life Cycle\n\nThe lifetime of a background task is closely tied to your app's current playback status. For example, when the user pauses audio playback, the system may terminate or cancel your app depending on the circumstances. After a period of time without audio playback, the system may automatically shut down the background task.\n\nThe [**IBackgroundTask.Run**](https://msdn.microsoft.com/library/windows/apps/br224811) method is called the first time your app accesses either [**BackgroundMediaPlayer.Current**](https://msdn.microsoft.com/library/windows/apps/dn652528) from code running in the foreground app or when you register a handler for the [**MessageReceivedFromBackground**](https://msdn.microsoft.com/library/windows/apps/dn652530) event, whichever occurs first. It is recommended that you register for the message received handler before calling **BackgroundMediaPlayer.Current** for the first time so that the foreground app doesn't miss any messages sent from the background process.\n\nTo keep the background task alive, your app must request a [**BackgroundTaskDeferral**](https://msdn.microsoft.com/library/windows/apps/hh700499) from within the **Run** method and call [**BackgroundTaskDeferral.Complete**](https://msdn.microsoft.com/library/windows/apps/hh700504) when the task instance receives the [**Canceled**](https://msdn.microsoft.com/library/windows/apps/br224798) or [**Completed**](https://msdn.microsoft.com/library/windows/apps/br224788) events. Do not loop or wait in the **Run** method because this consumes resources and may cause your app's background task to be terminated by the system.\n\nYour background task gets the **Completed** event when the **Run** method is completed and deferral is not requested. In some cases, when your app gets the **Canceled** event, it can be also followed by the **Completed** event. Your task may receive a **Canceled** event while **Run** is executing, so be sure to manage this potential concurrence.\n\nSituations in which the background task can be cancelled include:\n\n-   A new app with audio playback capabilities starts on systems that enforce the exclusivity sub-policy. See the [System policies for background audio task lifetime](#system-policies-for-background-audio-task-lifetime) section below.\n\n-   A background task has been launched but music is not yet playing, and then the foreground app is suspended.\n\n-   Other media interruptions, such as incoming phone calls or VoIP calls.\n\nSituations in which the background task can be terminated without notice include:\n\n-   A VoIP call comes in and there is not enough available memory on the system to keep the background task alive.\n\n-   A resource policy is violated.\n\n-   Task cancellation or completion does not end gracefully.\n\n## System policies for background audio task lifetime\n\nThe following policies help determine how the system manages the lifetime of background audio tasks.\n\n### Exclusivity\n\nIf enabled, this sub-policy limits the number of background audio tasks to be at most 1 at any given time. It is enabled on Mobile and other non-Desktop SKUs.\n\n### Inactivity Timeout\n\nDue to resource constraints, the system may terminate your background task after a period of inactivity.\n\nA background task is considered “inactive” if both of the following conditions are met:\n\n-   The foreground app is not visible (it is suspended or terminated).\n\n-   The background media player is not in the playing state.\n\nIf both of these conditions are satisfied, the background media system policy will start a timer. If neither condition has changed when the timer expires, the background media system policy will terminate the background task.\n\n### Shared Lifetime\n\nIf enabled, this sub-policy forces the background task to be dependent on the lifetime of the foreground task. If the foreground task is shut down, either by the user or the system, the background task will also shut down.\n\nHowever, note that this does not mean that the foreground is dependent on the background. If the background task is shut down, this does not force the foreground task to shut down.\n\nThe following table lists the which policies are enforced on which device types.\n\n| Sub-policy             | Desktop  | Mobile   | Other    |\n|------------------------|----------|----------|----------|\n| **Exclusivity**        | Disabled | Enabled  | Enabled  |\n| **Inactivity Timeout** | Disabled | Enabled  | Disabled |\n| **Shared Lifetime**    | Enabled  | Disabled | Disabled |\n\n \n\n \n\n \n\n\n\n\n"}