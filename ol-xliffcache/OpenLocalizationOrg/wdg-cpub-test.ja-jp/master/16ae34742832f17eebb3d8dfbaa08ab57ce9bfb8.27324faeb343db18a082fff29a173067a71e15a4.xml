{"nodes":[{"content":"Avoiding Floating Point Errors in Custom Build Environments","pos":[0,59]},{"content":"This information is intended for developers and build engineers who compile kernel-mode drivers for Windows.","pos":[208,316]},{"content":"In Microsoft Visual Studio Professional 2012, the default architecture for the Visual C++ (VC++) compiler changed from IA32 to the Streaming SIMD Extensions 2 (SSE2) instruction set.","pos":[317,499]},{"content":"As a result of this change, SSE2 floating point (FP) instructions injected into the binary at compile time can generate floating-point errors if not accounted for.","pos":[500,663]},{"content":"The issue can be encountered by those who use the Microsoft VC++ compiler, or a custom build environment to develop Windows drivers.","pos":[664,796]},{"content":"However, the issue does not affect developers who use the Microsoft Visual Studio development environment, or who use the MSbuild utility to build drivers with an unmodified toolset.","pos":[797,979]},{"pos":[1242,1309],"content":"Floating point errors can cause data corruption or computer crashes"},{"pos":[1640,1903],"content":"If you compile a driver <bpt id=\"p1\">*</bpt>without<ept id=\"p1\">*</ept> using the WDK, Visual Studio, and the recommended platform toolset for Windows drivers (<bpt id=\"p2\">**</bpt>WindowsKernelModeDriver8.0<ept id=\"p2\">**</ept>), the driver might not manage floating point operations correctly, even if the driver compiles without errors.","source":"If you compile a driver *without* using the WDK, Visual Studio, and the recommended platform toolset for Windows drivers (**WindowsKernelModeDriver8.0**), the driver might not manage floating point operations correctly, even if the driver compiles without errors."},{"content":"The Visual Studio Professional 2012 VC++ compiler emits code that uses the SSE2 instruction set by setting the <bpt id=\"p1\">**</bpt>/arch:sse2<ept id=\"p1\">**</ept> compiler option.","pos":[1905,2047],"source":"The Visual Studio Professional 2012 VC++ compiler emits code that uses the SSE2 instruction set by setting the **/arch:sse2** compiler option."},{"content":"Starting with Visual Studio Professional 2012, this is the default option for x86 VC++ compiler code generation.","pos":[2048,2160]},{"content":"Specifically, the default value changes from <bpt id=\"p1\">**</bpt>/arch:ia32<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>/arch:sse2<ept id=\"p2\">**</ept>.","pos":[2161,2239],"source":" Specifically, the default value changes from **/arch:ia32** to **/arch:sse2**."},{"content":"For applications this change generates code that performs better and uses less processor time during execution.","pos":[2241,2352]},{"content":"However, for kernel-mode drivers this change will not manage the floating point (FP) state properly.","pos":[2353,2453]},{"content":"This is due to the VC++ compiler introducing FP instruction sequences in places where the context has not been saved.","pos":[2454,2571]},{"content":"Any binary floating-point system can represent only a finite number of floating-point values in exact form, with the rest being approximations.","pos":[2572,2715]},{"content":"The floating-point control state, such as, rounding mode or precision, is what keeps FP operations in sync with each other.","pos":[2716,2839]},{"content":"When the state is undefined, this leads to FP calculation errors.","pos":[2840,2905]},{"content":"These calculation errors are hard to detect because in most cases application state corruption is the only sign of this issue.","pos":[2906,3032]},{"content":"This corruption can manifest itself in many ways, ranging from random crashes to data corruption.","pos":[3033,3130]},{"pos":[3213,3221],"content":"Solution"},{"content":"To avoid these problem with floating-point calculations, add the <bpt id=\"p1\">**</bpt>/kernel<ept id=\"p1\">**</ept> flag to the C++ compiler and linker command lines to prevent generating SSE2 instructions.","pos":[3313,3480],"source":"To avoid these problem with floating-point calculations, add the **/kernel** flag to the C++ compiler and linker command lines to prevent generating SSE2 instructions."},{"content":"The <bpt id=\"p1\">**</bpt>/kernel<ept id=\"p1\">**</ept> flag changes the default <bpt id=\"p2\">**</bpt>/arch:sse2<ept id=\"p2\">**</ept> value back to <bpt id=\"p3\">**</bpt>/arch:ia32<ept id=\"p3\">**</ept>.","pos":[3481,3566],"source":" The **/kernel** flag changes the default **/arch:sse2** value back to **/arch:ia32**."},{"content":"In addition, if you build a driver using the WDK and the Visual Studio Professional 2012 development environment, or use MSBuild, in a Visual Studio Command prompt window, the Microsoft provided platform toolset (<bpt id=\"p1\">**</bpt>WindowsKernelModeDriver8.0<ept id=\"p1\">**</ept>) sets the <bpt id=\"p2\">**</bpt>/kernel<ept id=\"p2\">**</ept> flag.","pos":[3568,3839],"source":"In addition, if you build a driver using the WDK and the Visual Studio Professional 2012 development environment, or use MSBuild, in a Visual Studio Command prompt window, the Microsoft provided platform toolset (**WindowsKernelModeDriver8.0**) sets the **/kernel** flag."},{"content":"As a result, floating-point generation errors are avoided.","pos":[3840,3898]},{"pos":[4090,4105],"content":"Recommendations"},{"content":"Here are the recommended solutions based on the type of development environment you use:","pos":[4225,4313]},{"content":"<bpt id=\"p1\">**</bpt>Microsoft tool set (MSBuild)<ept id=\"p1\">**</ept> - No work required.","pos":[4319,4371],"source":"**Microsoft tool set (MSBuild)** - No work required."},{"content":"Use <bpt id=\"p1\">**</bpt>WindowsKernelModeDriver8.0<ept id=\"p1\">**</ept> as the platform toolset the <bpt id=\"p2\">**</bpt>/kernel<ept id=\"p2\">**</ept> is automatically added where appropriate.","pos":[4372,4488],"source":" Use **WindowsKernelModeDriver8.0** as the platform toolset the **/kernel** is automatically added where appropriate."},{"pos":[4493,4587],"content":"<bpt id=\"p1\">**</bpt>Microsoft VC++ Compiler<ept id=\"p1\">**</ept> - Add the <bpt id=\"p2\">**</bpt>/kernel<ept id=\"p2\">**</ept> flag to prevent compiler from emitting SSE2.","source":"**Microsoft VC++ Compiler** - Add the **/kernel** flag to prevent compiler from emitting SSE2."},{"pos":[4592,4721],"content":"<bpt id=\"p1\">**</bpt>Custom Tooling/Non-Microsoft Compiler<ept id=\"p1\">**</ept> - You must manually account for the assembly instructions used in the resulting binary.","source":"**Custom Tooling/Non-Microsoft Compiler** - You must manually account for the assembly instructions used in the resulting binary."},{"pos":[4729,5711],"content":"<bpt id=\"p1\">[</bpt>Send comments about this topic to Microsoft<ept id=\"p1\">]</ept><bpt id=\"p2\">(mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback%20[VsDriver\\vsdriver]:%20Avoiding%20Floating%20Point%20Errors%20in%20Custom%20Build%20Environments%20%20RELEASE:%20%289/30/2015%29&amp;body=%0A%0APRIVACY%20STATEMENT%0A%0AWe%20use%20your%20feedback%20to%20improve%20the%20documentation.%20We%20don't%20use%20your%20email%20address%20for%20any%20other%20purpose,%20and%20we'll%20remove%20your%20email%20address%20from%20our%20system%20after%20the%20issue%20that%20you're%20reporting%20is%20fixed.%20While%20we're%20working%20to%20fix%20this%20issue,%20we%20might%20send%20you%20an%20email%20message%20to%20ask%20for%20more%20info.%20Later,%20we%20might%20also%20send%20you%20an%20email%20message%20to%20let%20you%20know%20that%20we've%20addressed%20your%20feedback.%0A%0AFor%20more%20info%20about%20Microsoft's%20privacy%20policy,%20see%20http://privacy.microsoft.com/en-us/default. \"</bpt>Send comments about this topic to Microsoft<ept id=\"p2\">\")</ept>","source":"[Send comments about this topic to Microsoft](mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback%20[VsDriver\\vsdriver]:%20Avoiding%20Floating%20Point%20Errors%20in%20Custom%20Build%20Environments%20%20RELEASE:%20%289/30/2015%29&body=%0A%0APRIVACY%20STATEMENT%0A%0AWe%20use%20your%20feedback%20to%20improve%20the%20documentation.%20We%20don't%20use%20your%20email%20address%20for%20any%20other%20purpose,%20and%20we'll%20remove%20your%20email%20address%20from%20our%20system%20after%20the%20issue%20that%20you're%20reporting%20is%20fixed.%20While%20we're%20working%20to%20fix%20this%20issue,%20we%20might%20send%20you%20an%20email%20message%20to%20ask%20for%20more%20info.%20Later,%20we%20might%20also%20send%20you%20an%20email%20message%20to%20let%20you%20know%20that%20we've%20addressed%20your%20feedback.%0A%0AFor%20more%20info%20about%20Microsoft's%20privacy%20policy,%20see%20http://privacy.microsoft.com/en-us/default. \"Send comments about this topic to Microsoft\")"}],"content":"Avoiding Floating Point Errors in Custom Build Environments\n==================================================================================================================================================\n\nThis information is intended for developers and build engineers who compile kernel-mode drivers for Windows. In Microsoft Visual Studio Professional 2012, the default architecture for the Visual C++ (VC++) compiler changed from IA32 to the Streaming SIMD Extensions 2 (SSE2) instruction set. As a result of this change, SSE2 floating point (FP) instructions injected into the binary at compile time can generate floating-point errors if not accounted for. The issue can be encountered by those who use the Microsoft VC++ compiler, or a custom build environment to develop Windows drivers. However, the issue does not affect developers who use the Microsoft Visual Studio development environment, or who use the MSbuild utility to build drivers with an unmodified toolset.\n\n<span id=\"Floating_point_errors_can_cause_data_corruption_or_computer_crashes_\"></span><span id=\"floating_point_errors_can_cause_data_corruption_or_computer_crashes_\"></span><span id=\"FLOATING_POINT_ERRORS_CAN_CAUSE_DATA_CORRUPTION_OR_COMPUTER_CRASHES_\"></span>Floating point errors can cause data corruption or computer crashes\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n\nIf you compile a driver *without* using the WDK, Visual Studio, and the recommended platform toolset for Windows drivers (**WindowsKernelModeDriver8.0**), the driver might not manage floating point operations correctly, even if the driver compiles without errors.\n\nThe Visual Studio Professional 2012 VC++ compiler emits code that uses the SSE2 instruction set by setting the **/arch:sse2** compiler option. Starting with Visual Studio Professional 2012, this is the default option for x86 VC++ compiler code generation. Specifically, the default value changes from **/arch:ia32** to **/arch:sse2**.\n\nFor applications this change generates code that performs better and uses less processor time during execution. However, for kernel-mode drivers this change will not manage the floating point (FP) state properly. This is due to the VC++ compiler introducing FP instruction sequences in places where the context has not been saved. Any binary floating-point system can represent only a finite number of floating-point values in exact form, with the rest being approximations. The floating-point control state, such as, rounding mode or precision, is what keeps FP operations in sync with each other. When the state is undefined, this leads to FP calculation errors. These calculation errors are hard to detect because in most cases application state corruption is the only sign of this issue. This corruption can manifest itself in many ways, ranging from random crashes to data corruption.\n\n<span id=\"Solution\"></span><span id=\"solution\"></span><span id=\"SOLUTION\"></span>Solution\n-----------------------------------------------------------------------------------------\n\nTo avoid these problem with floating-point calculations, add the **/kernel** flag to the C++ compiler and linker command lines to prevent generating SSE2 instructions. The **/kernel** flag changes the default **/arch:sse2** value back to **/arch:ia32**.\n\nIn addition, if you build a driver using the WDK and the Visual Studio Professional 2012 development environment, or use MSBuild, in a Visual Studio Command prompt window, the Microsoft provided platform toolset (**WindowsKernelModeDriver8.0**) sets the **/kernel** flag. As a result, floating-point generation errors are avoided.\n\n``` syntax\nmsbuild myProject.vcxproj /p:PlatformToolset=WindowsKernelModeDriver8.0\n```\n\n<span id=\"Recommendations\"></span><span id=\"recommendations\"></span><span id=\"RECOMMENDATIONS\"></span>Recommendations\n---------------------------------------------------------------------------------------------------------------------\n\nHere are the recommended solutions based on the type of development environment you use:\n\n-   **Microsoft tool set (MSBuild)** - No work required. Use **WindowsKernelModeDriver8.0** as the platform toolset the **/kernel** is automatically added where appropriate.\n-   **Microsoft VC++ Compiler** - Add the **/kernel** flag to prevent compiler from emitting SSE2.\n-   **Custom Tooling/Non-Microsoft Compiler** - You must manually account for the assembly instructions used in the resulting binary.\n\n \n\n \n\n[Send comments about this topic to Microsoft](mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback%20[VsDriver\\vsdriver]:%20Avoiding%20Floating%20Point%20Errors%20in%20Custom%20Build%20Environments%20%20RELEASE:%20%289/30/2015%29&body=%0A%0APRIVACY%20STATEMENT%0A%0AWe%20use%20your%20feedback%20to%20improve%20the%20documentation.%20We%20don't%20use%20your%20email%20address%20for%20any%20other%20purpose,%20and%20we'll%20remove%20your%20email%20address%20from%20our%20system%20after%20the%20issue%20that%20you're%20reporting%20is%20fixed.%20While%20we're%20working%20to%20fix%20this%20issue,%20we%20might%20send%20you%20an%20email%20message%20to%20ask%20for%20more%20info.%20Later,%20we%20might%20also%20send%20you%20an%20email%20message%20to%20let%20you%20know%20that%20we've%20addressed%20your%20feedback.%0A%0AFor%20more%20info%20about%20Microsoft's%20privacy%20policy,%20see%20http://privacy.microsoft.com/en-us/default. \"Send comments about this topic to Microsoft\")\n\n\n"}