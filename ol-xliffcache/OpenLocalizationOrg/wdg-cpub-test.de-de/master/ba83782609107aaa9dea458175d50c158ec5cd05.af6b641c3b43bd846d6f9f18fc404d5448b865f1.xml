{"nodes":[{"pos":[11,85],"content":"Creating a Simple Windows Runtime component and calling it from JavaScript","needQuote":true,"needEscape":true,"nodes":[{"content":"Creating a Simple Windows Runtime component and calling it from JavaScript","pos":[0,74]}]},{"pos":[99,361],"content":"This walkthrough shows how you can use the .NET Framework with Visual Basic or C# to create your own Windows Runtime types, packaged in a Windows Runtime component, and how to call the component from your Universal Windows app built for Windows using JavaScript.","needQuote":true,"needEscape":true,"nodes":[{"content":"This walkthrough shows how you can use the .NET Framework with Visual Basic or C# to create your own Windows Runtime types, packaged in a Windows Runtime component, and how to call the component from your Universal Windows app built for Windows using JavaScript.","pos":[0,262]}]},{"content":"Walkthrough: Creating a Simple Windows Runtime component and calling it from JavaScript","pos":[418,505]},{"content":"\\[ Updated for UWP apps on Windows 10.","pos":[508,546]},{"content":"For Windows 8.x articles, see the <bpt id=\"p1\">[</bpt>archive<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=619132)</ept> \\]","pos":[547,642],"source":" For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]"},{"content":"\\[Some information relates to pre-released product which may be substantially modified before it's commercially released.","pos":[645,766]},{"content":"Microsoft makes no warranties, express or implied, with respect to the information provided here.\\]","pos":[767,866]},{"content":"This walkthrough shows how you can use the .NET Framework with Visual Basic or C# to create your own Windows Runtime types, packaged in a Windows Runtime component, and how to call the component from your Universal Windows app built for Windows using JavaScript.","pos":[868,1130]},{"content":"Visual Studio makes it easy to add a Windows Runtime component written with C# or Visual Basic to your app, and to create Windows Runtime types that you can call from JavaScript.","pos":[1132,1310]},{"content":"Internally, your Windows Runtime types can use any .NET Framework functionality that's allowed in a Universal Windows app.","pos":[1311,1433]},{"content":"(For more information, see <bpt id=\"p1\">[</bpt>Creating Windows Runtime Components in C# and Visual Basic<ept id=\"p1\">](creating-windows-runtime-components-in-csharp-and-visual-basic.md)</ept> and <bpt id=\"p2\">[</bpt>.NET for Windows Store apps overview<ept id=\"p2\">](https://msdn.microsoft.com/library/windows/apps/xaml/mt185501.aspx)</ept>.) Externally, the members of your type can expose only Windows Runtime types for their parameters and return values.","pos":[1434,1816],"source":" (For more information, see [Creating Windows Runtime Components in C# and Visual Basic](creating-windows-runtime-components-in-csharp-and-visual-basic.md) and [.NET for Windows Store apps overview](https://msdn.microsoft.com/library/windows/apps/xaml/mt185501.aspx).) Externally, the members of your type can expose only Windows Runtime types for their parameters and return values."},{"content":"When you build your solution, Visual Studio builds your .NET Framework Windows Runtime Component project and then executes a build step that creates a Windows metadata (.winmd) file.","pos":[1817,1999]},{"content":"This is your Windows Runtime component, which Visual Studio includes in your app.","pos":[2000,2081]},{"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>  The .NET Framework automatically maps some commonly used .NET Framework types, such as primitive data types and collection types, to their Windows Runtime equivalents.","pos":[2085,2262],"source":"**Note**  The .NET Framework automatically maps some commonly used .NET Framework types, such as primitive data types and collection types, to their Windows Runtime equivalents."},{"content":"These .NET Framework types can be used in the public interface of a Windows Runtime component, and will appear to users of the component as the corresponding Windows Runtime types.","pos":[2263,2443]},{"content":"See <bpt id=\"p1\">[</bpt>Creating Windows Runtime Components in C# and Visual Basic<ept id=\"p1\">](creating-windows-runtime-components-in-csharp-and-visual-basic.md)</ept>.","pos":[2444,2576],"source":" See [Creating Windows Runtime Components in C# and Visual Basic](creating-windows-runtime-components-in-csharp-and-visual-basic.md)."},{"content":"This walkthrough illustrates the following tasks.","pos":[2578,2627]},{"content":"After you've completed the first section, which sets up the Windows app with JavaScript, you can complete the remaining sections in any order.","pos":[2628,2770]},{"content":"Prerequisites:","pos":[2775,2789]},{"content":"Windows 10","pos":[2795,2805]},{"content":"Microsoft Visual Studio 2015 or Microsoft Visual Studio Community 2015","pos":[2810,2880]},{"content":"Creating a simple Windows Runtime class","pos":[2885,2924]},{"content":"This section creates a Universal Windows app built for Windows using JavaScript, and adds a Visual Basic or C# Windows Runtime Component project.","pos":[2927,3072]},{"content":"It shows how to define a managed Windows Runtime type, create an instance of the type from JavaScript, and call static and instance members.","pos":[3073,3213]},{"content":"The visual display of the example app is deliberately dull to keep the focus on the component.","pos":[3214,3308]},{"content":"Feel free to make it prettier.","pos":[3309,3339]},{"content":"In Visual Studio, create a new JavaScript project: On the menu bar, choose <bpt id=\"p1\">**</bpt>File, New, Project<ept id=\"p1\">**</ept>.","pos":[3345,3443],"source":"In Visual Studio, create a new JavaScript project: On the menu bar, choose **File, New, Project**."},{"content":"In the <bpt id=\"p1\">**</bpt>Installed Templates<ept id=\"p1\">**</ept> section of the <bpt id=\"p2\">**</bpt>New Project<ept id=\"p2\">**</ept> dialog box, choose <bpt id=\"p3\">**</bpt>JavaScript<ept id=\"p3\">**</ept>, and then choose <bpt id=\"p4\">**</bpt>Windows<ept id=\"p4\">**</ept>, and then <bpt id=\"p5\">**</bpt>Universal<ept id=\"p5\">**</ept>.","pos":[3444,3593],"source":" In the **Installed Templates** section of the **New Project** dialog box, choose **JavaScript**, and then choose **Windows**, and then **Universal**."},{"content":"(If Windows is not available, make sure you're using Windows 8 or later.) Choose the <bpt id=\"p1\">**</bpt>Blank Application<ept id=\"p1\">**</ept> template and enter SampleApp for the project name.","pos":[3594,3751],"source":" (If Windows is not available, make sure you're using Windows 8 or later.) Choose the **Blank Application** template and enter SampleApp for the project name."},{"content":"Create the component project: In Solution Explorer, open the shortcut menu for the SampleApp solution and choose <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept>, and then choose <bpt id=\"p2\">**</bpt>New Project<ept id=\"p2\">**</ept> to add a new C# or Visual Basic project to the solution.","pos":[3756,3966],"source":"Create the component project: In Solution Explorer, open the shortcut menu for the SampleApp solution and choose **Add**, and then choose **New Project** to add a new C# or Visual Basic project to the solution."},{"content":"In the <bpt id=\"p1\">**</bpt>Installed Templates<ept id=\"p1\">**</ept> section of the <bpt id=\"p2\">**</bpt>Add New Project<ept id=\"p2\">**</ept> dialog box, choose <bpt id=\"p3\">**</bpt>Visual Basic<ept id=\"p3\">**</ept> or <bpt id=\"p4\">**</bpt>Visual C#<ept id=\"p4\">**</ept>, and then choose <bpt id=\"p5\">**</bpt>Windows<ept id=\"p5\">**</ept>, and then <bpt id=\"p6\">**</bpt>Universal<ept id=\"p6\">**</ept>.","pos":[3967,4139],"source":" In the **Installed Templates** section of the **Add New Project** dialog box, choose **Visual Basic** or **Visual C#**, and then choose **Windows**, and then **Universal**."},{"content":"Choose the <bpt id=\"p1\">**</bpt>Windows Runtime Component<ept id=\"p1\">**</ept> template and enter <bpt id=\"p2\">**</bpt>SampleComponent<ept id=\"p2\">**</ept> for the project name.","pos":[4140,4241],"source":" Choose the **Windows Runtime Component** template and enter **SampleComponent** for the project name."},{"content":"Change the name of the class to <bpt id=\"p1\">**</bpt>Example<ept id=\"p1\">**</ept>.","pos":[4246,4290],"source":"Change the name of the class to **Example**."},{"content":"Notice that by default, the class is marked <bpt id=\"p1\">**</bpt>public sealed<ept id=\"p1\">**</ept> (<bpt id=\"p2\">**</bpt>Public NotInheritable<ept id=\"p2\">**</ept> in Visual Basic).","pos":[4291,4397],"source":" Notice that by default, the class is marked **public sealed** (**Public NotInheritable** in Visual Basic)."},{"content":"All the Windows Runtime classes you expose from your component must be sealed.","pos":[4398,4476]},{"pos":[4481,4599],"content":"Add two simple members to the class, a <bpt id=\"p1\">**</bpt>static<ept id=\"p1\">**</ept> method (<bpt id=\"p2\">**</bpt>Shared<ept id=\"p2\">**</ept> method in Visual Basic) and an instance property:","source":"Add two simple members to the class, a **static** method (**Shared** method in Visual Basic) and an instance property:"},{"pos":[5227,5393],"content":"Optional: To enable IntelliSense for the newly added members, in Solution Explorer, open the shortcut menu for the SampleComponent project, and then choose <bpt id=\"p1\">**</bpt>Build<ept id=\"p1\">**</ept>.","source":"Optional: To enable IntelliSense for the newly added members, in Solution Explorer, open the shortcut menu for the SampleComponent project, and then choose **Build**."},{"content":"In Solution Explorer, in the JavaScript project, open the shortcut menu for <bpt id=\"p1\">**</bpt>References<ept id=\"p1\">**</ept>, and then choose <bpt id=\"p2\">**</bpt>Add Reference<ept id=\"p2\">**</ept> to open the <bpt id=\"p3\">**</bpt>Reference Manager<ept id=\"p3\">**</ept>.","pos":[5398,5558],"source":"In Solution Explorer, in the JavaScript project, open the shortcut menu for **References**, and then choose **Add Reference** to open the **Reference Manager**."},{"content":"Choose <bpt id=\"p1\">**</bpt>Projects<ept id=\"p1\">**</ept>, and then choose <bpt id=\"p2\">**</bpt>Solution<ept id=\"p2\">**</ept>.","pos":[5559,5609],"source":" Choose **Projects**, and then choose **Solution**."},{"content":"Select the check box for the SampleComponent project and choose <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> to add a reference.","pos":[5610,5700],"source":" Select the check box for the SampleComponent project and choose **OK** to add a reference."},{"content":"Call the component from JavaScript","pos":[5705,5739]},{"content":"To use the Windows Runtime type from JavaScript, add the following code in the anonymous function in the default.js file (in the js folder of the project) that is provided by the Visual Studio template.","pos":[5742,5944]},{"content":"It should go after the app.oncheckpoint event handler and before the call to app.start.","pos":[5945,6032]},{"content":"Notice that the first letter of each member name is changed from uppercase to lowercase.","pos":[6449,6537]},{"content":"This transformation is part of the support that JavaScript provides to enable the natural use of the Windows Runtime.","pos":[6538,6655]},{"content":"Namespaces and class names are Pascal-cased.","pos":[6656,6700]},{"content":"Member names are camel-cased except for event names, which are all lowercase.","pos":[6701,6778]},{"content":"See <bpt id=\"p1\">[</bpt>Using the Windows Runtime in JavaScript<ept id=\"p1\">](https://msdn.microsoft.com/library/hh710230.aspx)</ept>.","pos":[6779,6875],"source":" See [Using the Windows Runtime in JavaScript](https://msdn.microsoft.com/library/hh710230.aspx)."},{"content":"The rules for camel casing can be confusing.","pos":[6876,6920]},{"content":"A series of initial uppercase letters normally appears as lowercase, but if three uppercase letters are followed by a lowercase letter, only the first two letters appear in lowercase: for example, a member named IDStringKind appears as idStringKind.","pos":[6921,7170]},{"content":"In Visual Studio, you can build your Windows Runtime component project and then use IntelliSense in your JavaScript project to see the correct casing.","pos":[7171,7321]},{"content":"In similar fashion, the .NET Framework provides support to enable the natural use of the Windows Runtime in managed code.","pos":[7323,7444]},{"content":"This is discussed in subsequent sections of this article, and in the articles <bpt id=\"p1\">[</bpt>Creating Windows Runtime Components in C# and Visual Basic<ept id=\"p1\">](creating-windows-runtime-components-in-csharp-and-visual-basic.md)</ept> and <bpt id=\"p2\">[</bpt>.NET Framework Support for Windows Store Apps and Windows Runtime<ept id=\"p2\">](https://msdn.microsoft.com/library/hh694558.aspx)</ept>.","pos":[7445,7773],"source":" This is discussed in subsequent sections of this article, and in the articles [Creating Windows Runtime Components in C# and Visual Basic](creating-windows-runtime-components-in-csharp-and-visual-basic.md) and [.NET Framework Support for Windows Store Apps and Windows Runtime](https://msdn.microsoft.com/library/hh694558.aspx)."},{"content":"Create a simple user interface","pos":[7778,7808]},{"content":"In your JavaScript project, open the default.html file and update the body as shown in the following code.","pos":[7811,7917]},{"content":"This code includes the complete set of controls for the example app and specifies the function names for the click events.","pos":[7918,8040]},{"pos":[8044,8132],"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>  When you first run the app, only the Basics1 and Basics2 button are supported.","source":"**Note**  When you first run the app, only the Basics1 and Basics2 button are supported."},{"content":"In your JavaScript project, in the css folder, open default.css.","pos":[8869,8933]},{"content":"Modify the body section as shown, and add styles to control the layout of buttons and the placement of output text.","pos":[8934,9049]},{"content":"Now add the event listener registration code by adding a then clause to the processAll call in app.onactivated in default.js.","pos":[9305,9430]},{"content":"Replace the existing line of code that calls setPromise and change it to the following code:","pos":[9431,9523]},{"content":"This is a better way to add events to HTML controls than adding a click event handler directly in HTML.","pos":[9824,9927]},{"content":"See <bpt id=\"p1\">[</bpt>Create a \"Hello World\" app (JS)<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/mt280216)</ept>.","pos":[9928,10024],"source":" See [Create a \"Hello World\" app (JS)](https://msdn.microsoft.com/library/windows/apps/mt280216)."},{"content":"Build and run the app","pos":[10029,10050]},{"content":"Before you build, change the target platform for all projects to ARM, x64, or x86, as appropriate for your computer.","pos":[10053,10169]},{"content":"To build and run the solution, choose the F5 key.","pos":[10171,10220]},{"content":"(If you get a run-time error message stating that SampleComponent is undefined, the reference to the class library project is missing.)","pos":[10221,10356]},{"content":"Visual Studio first compiles the class library, and then executes an MSBuild task that runs <bpt id=\"p1\">[</bpt>Winmdexp.exe (Windows Runtime Metadata Export Tool)<ept id=\"p1\">](https://msdn.microsoft.com/library/hh925576.aspx)</ept> to create your Windows Runtime component.","pos":[10358,10595],"source":"Visual Studio first compiles the class library, and then executes an MSBuild task that runs [Winmdexp.exe (Windows Runtime Metadata Export Tool)](https://msdn.microsoft.com/library/hh925576.aspx) to create your Windows Runtime component."},{"content":"The component is included in a .winmd file that contains both the managed code and the Windows metadata that describes the code.","pos":[10596,10724]},{"content":"WinMdExp.exe generates build error messages when you write code that's invalid in a Windows Runtime component, and the error messages are displayed in the Visual Studio IDE.","pos":[10725,10898]},{"content":"Visual Studio adds your component to the app package (.appx file) for your Universal Windows app, and generates the appropriate manifest.","pos":[10899,11036]},{"content":"Choose the Basics 1 button to assign the return value from the static GetAnswer method to the output area, create an instance of the Example class, and display the value of its SampleProperty property in the output area.","pos":[11038,11258]},{"content":"The output is shown here:","pos":[11259,11284]},{"content":"Choose the Basics 2 button to increment the value of the SampleProperty property and to display the new value in the output area.","pos":[11324,11453]},{"content":"Primitive types such as strings and numbers can be used as parameter types and return types, and can be passed between managed code and JavaScript.","pos":[11454,11601]},{"content":"Because numbers in JavaScript are stored in double-precision floating-point format, they are converted to .NET Framework numeric types.","pos":[11602,11737]},{"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>  By default, you can set breakpoints only in your JavaScript code.","pos":[11741,11816],"source":"**Note**  By default, you can set breakpoints only in your JavaScript code."},{"content":"To debug your Visual Basic or C# code, see Creating Windows Runtime Components in C# and Visual Basic.","pos":[11817,11919]},{"content":"To stop debugging and close your app, switch from the app to Visual Studio, and choose Shift+F5.","pos":[11924,12020]},{"content":"Using the Windows Runtime from JavaScript and managed code","pos":[12025,12083]},{"content":"The Windows Runtime can be called from either JavaScript or managed code.","pos":[12086,12159]},{"content":"Windows Runtime objects can be passed back and forth between the two, and events can be handled from either side.","pos":[12160,12273]},{"content":"However, the ways you use Windows Runtime types in the two environments differ in some details, because JavaScript and the .NET Framework support the Windows Runtime differently.","pos":[12274,12452]},{"content":"The following example demonstrates these differences, using the <bpt id=\"p1\">[</bpt>Windows.Foundation.Collections.PropertySet<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/windows.foundation.collections.propertyset.aspx)</ept> class.","pos":[12453,12665],"source":" The following example demonstrates these differences, using the [Windows.Foundation.Collections.PropertySet](https://msdn.microsoft.com/library/windows/apps/windows.foundation.collections.propertyset.aspx) class."},{"content":"In this example, you create an instance of the PropertySet collection in managed code and register an event handler to track changes in the collection.","pos":[12666,12817]},{"content":"Then you add JavaScript code that gets the collection, registers its own event handler, and uses the collection.","pos":[12818,12930]},{"content":"Finally, you add a method that makes changes to the collection from managed code and shows JavaScript handling a managed exception.","pos":[12931,13062]},{"content":"<bpt id=\"p1\">**</bpt>Important<ept id=\"p1\">**</ept>  In this example, the event is being fired on the UI thread.","pos":[13066,13140],"source":"**Important**  In this example, the event is being fired on the UI thread."},{"content":"If you fire the event from a background thread, for example in an async call, you will need to do some extra work in order for JavaScript to handle the event.","pos":[13141,13299]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Raising Events in Windows Runtime Components<ept id=\"p1\">](raising-events-in-windows-runtime-components.md)</ept>.","pos":[13300,13422],"source":" For more information, see [Raising Events in Windows Runtime Components](raising-events-in-windows-runtime-components.md)."},{"content":"In the SampleComponent project, add a new <bpt id=\"p1\">**</bpt>public sealed<ept id=\"p1\">**</ept> class (<bpt id=\"p2\">**</bpt>Public NotInheritable<ept id=\"p2\">**</ept> class in Visual Basic) named PropertySetStats.","pos":[13427,13566],"source":"In the SampleComponent project, add a new **public sealed** class (**Public NotInheritable** class in Visual Basic) named PropertySetStats."},{"content":"The class wraps a PropertySet collection and handles its MapChanged event.","pos":[13567,13641]},{"content":"The event handler tracks the number of changes of each kind that occur, and the DisplayStats method produces a report that is formatted in HTML.","pos":[13642,13786]},{"content":"Notice the additional <bpt id=\"p1\">**</bpt>using<ept id=\"p1\">**</ept> statement (<bpt id=\"p2\">**</bpt>Imports<ept id=\"p2\">**</ept> statement in Visual Basic); be careful to add this to the existing <bpt id=\"p3\">**</bpt>using<ept id=\"p3\">**</ept> statements rather than overwriting them.","pos":[13787,13959],"source":" Notice the additional **using** statement (**Imports** statement in Visual Basic); be careful to add this to the existing **using** statements rather than overwriting them."},{"pos":[16119,16663],"content":"The event handler follows the familiar .NET Framework event pattern, except that the sender of the event (in this case, the PropertySet object) is cast to the IObservableMap<ph id=\"ph1\">&amp;lt;</ph>string, object<ph id=\"ph2\">&amp;gt;</ph> interface (IObservableMap(Of String, Object) in Visual Basic), which is an instantiation of the Windows Runtime interface <bpt id=\"p1\">[</bpt>IObservableMap<ph id=\"ph3\">&amp;lt;</ph>K, V<ph id=\"ph4\">&amp;gt;</ph><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226050.aspx)</ept>. (You can cast the sender to its type if necessary.) Also, the event arguments are presented as an interface rather than as an object.","source":"The event handler follows the familiar .NET Framework event pattern, except that the sender of the event (in this case, the PropertySet object) is cast to the IObservableMap&lt;string, object&gt; interface (IObservableMap(Of String, Object) in Visual Basic), which is an instantiation of the Windows Runtime interface [IObservableMap&lt;K, V&gt;](https://msdn.microsoft.com/library/windows/apps/br226050.aspx). (You can cast the sender to its type if necessary.) Also, the event arguments are presented as an interface rather than as an object."},{"content":"In the default.js file, add the Runtime1 function as shown.","pos":[16665,16724]},{"content":"This code creates a PropertySetStats object, gets its PropertySet collection, and adds its own event handler, the onMapChanged function, to handle the MapChanged event.","pos":[16725,16893]},{"content":"After making changes to the collection, runtime1 calls the DisplayStats method to show a summary of change types.","pos":[16894,17007]},{"content":"The way you handle Windows Runtime events in JavaScript is very different from the way you handle them in .NET Framework code.","pos":[18625,18751]},{"content":"The JavaScript event handler takes only one argument.","pos":[18752,18805]},{"content":"When you view this object in the Visual Studio debugger, the first property is the sender.","pos":[18806,18896]},{"content":"The members of the event argument interface also appear directly on this object.","pos":[18897,18977]},{"content":"To run the app, choose the F5 key.","pos":[18979,19013]},{"content":"If the class is not sealed, you get the error message, \"Exporting unsealed type 'SampleComponent.Example' is not currently supported.","pos":[19014,19147]},{"content":"Please mark it as sealed.\"","pos":[19148,19174]},{"content":"Choose the <bpt id=\"p1\">**</bpt>Runtime 1<ept id=\"p1\">**</ept> button.","pos":[19176,19208],"source":"Choose the **Runtime 1** button."},{"content":"The event handler displays changes as elements are added or changed, and at the end the DisplayStats method is called to produce a summary of counts.","pos":[19209,19358]},{"content":"To stop debugging and close the app, switch back to Visual Studio and choose Shift+F5.","pos":[19359,19445]},{"content":"To add two more items to the PropertySet collection from managed code, add the following code to the PropertySetStats class:","pos":[19447,19571]},{"content":"This code highlights another difference in the way you use Windows Runtime types in the two environments.","pos":[19917,20022]},{"content":"If you type this code yourself, you'll notice that IntelliSense doesn't show the insert method you used in the JavaScript code.","pos":[20023,20150]},{"content":"Instead, it shows the Add method commonly seen on collections in the .NET Framework.","pos":[20151,20235]},{"content":"This is because some commonly used collection interfaces have different names but similar functionality in the Windows Runtime and the .NET Framework.","pos":[20236,20386]},{"content":"When you use these interfaces in managed code, they appear as their .NET Framework equivalents.","pos":[20387,20482]},{"content":"This is discussed in <bpt id=\"p1\">[</bpt>Creating Windows Runtime Components in C# and Visual Basic<ept id=\"p1\">](creating-windows-runtime-components-in-csharp-and-visual-basic.md)</ept>.","pos":[20483,20632],"source":" This is discussed in [Creating Windows Runtime Components in C# and Visual Basic](creating-windows-runtime-components-in-csharp-and-visual-basic.md)."},{"content":"When you use the same interfaces in JavaScript, the only change from the Windows Runtime is that uppercase letters at the beginning of member names become lowercase.","pos":[20633,20798]},{"content":"Finally, to call the AddMore method with exception handling, add the runtime2 function to default.js.","pos":[20800,20901]},{"content":"Add the event handler registration code the same way you did previously.","pos":[21197,21269]},{"content":"To run the app, choose the F5 key.","pos":[21536,21570]},{"content":"Choose <bpt id=\"p1\">**</bpt>Runtime 1<ept id=\"p1\">**</ept> and then <bpt id=\"p2\">**</bpt>Runtime 2<ept id=\"p2\">**</ept>.","pos":[21571,21615],"source":" Choose **Runtime 1** and then **Runtime 2**."},{"content":"The JavaScript event handler reports the first change to the collection.","pos":[21616,21688]},{"content":"The second change, however, has a duplicate key.","pos":[21689,21737]},{"content":"Users of .NET Framework dictionaries expect the Add method to throw an exception, and that is what happens.","pos":[21738,21845]},{"content":"JavaScript handles the .NET Framework exception.","pos":[21846,21894]},{"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>  You can't display the exception's message from JavaScript code.","pos":[21898,21971],"source":"**Note**  You can't display the exception's message from JavaScript code."},{"content":"The message text is replaced by a stack trace.","pos":[21972,22018]},{"content":"For more information, see \"Throwing exceptions\" in Creating Windows Runtime Components in C# and Visual Basic.","pos":[22019,22129]},{"content":"By contrast, when JavaScript called the insert method with a duplicate key, the value of the item was changed.","pos":[22131,22241]},{"content":"This difference in behavior is due to the different ways that JavaScript and the .NET Framework support the Windows Runtime, as explained in <bpt id=\"p1\">[</bpt>Creating Windows Runtime Components in C# and Visual Basic<ept id=\"p1\">](creating-windows-runtime-components-in-csharp-and-visual-basic.md)</ept>.","pos":[22242,22511],"source":" This difference in behavior is due to the different ways that JavaScript and the .NET Framework support the Windows Runtime, as explained in [Creating Windows Runtime Components in C# and Visual Basic](creating-windows-runtime-components-in-csharp-and-visual-basic.md)."},{"content":"Returning managed types from your component","pos":[22516,22559]},{"content":"As discussed previously, you can pass native Windows Runtime types back and forth freely between your JavaScript code and your C# or Visual Basic code.","pos":[22562,22713]},{"content":"Most of the time, the type names and member names will be the same in both cases (except that the member names start with lowercase letters in JavaScript).","pos":[22714,22869]},{"content":"However, in the preceding section, the PropertySet class appeared to have different members in managed code.","pos":[22870,22978]},{"content":"(For example, in JavaScript you called the insert method, and in the .NET Framework code you called the Add method.) This section explores the way those differences affect .NET Framework types passed to JavaScript.","pos":[22979,23193]},{"content":"In addition to returning Windows Runtime types that you created in your component or passed to your component from JavaScript, you can return a managed type, created in managed code, to JavaScript as if it were the corresponding Windows Runtime type.","pos":[23195,23445]},{"content":"Even in the first, simple example of a runtime class, the parameters and return types of the members were Visual Basic or C# primitive types, which are .NET Framework types.","pos":[23446,23619]},{"content":"To demonstrate this for collections, add the following code to the Example class, to create a method that returns a generic dictionary of strings, indexed by integers:","pos":[23620,23787]},{"content":"Notice that the dictionary must be returned as an interface that is implemented by <bpt id=\"p1\">[</bpt>Dictionary<ph id=\"ph1\">&amp;lt;</ph>TKey, TValue<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p1\">](https://msdn.microsoft.com/library/xfhwa508.aspx)</ept>, and that maps to a Windows Runtime interface.","pos":[24493,24705],"source":"Notice that the dictionary must be returned as an interface that is implemented by [Dictionary&lt;TKey, TValue&gt;](https://msdn.microsoft.com/library/xfhwa508.aspx), and that maps to a Windows Runtime interface."},{"content":"In this case, the interface is IDictionary<ph id=\"ph1\">&amp;lt;</ph>int, string<ph id=\"ph2\">&amp;gt;</ph> (IDictionary(Of Integer, String) in Visual Basic).","pos":[24706,24818],"source":" In this case, the interface is IDictionary&lt;int, string&gt; (IDictionary(Of Integer, String) in Visual Basic)."},{"content":"When the Windows Runtime type IMap<ph id=\"ph1\">&amp;lt;</ph>int, string<ph id=\"ph2\">&amp;gt;</ph> is passed to managed code, it appears as IDictionary<ph id=\"ph3\">&amp;lt;</ph>int, string<ph id=\"ph4\">&amp;gt;</ph>, and the reverse is true when the managed type is passed to JavaScript.","pos":[24819,25016],"source":" When the Windows Runtime type IMap&lt;int, string&gt; is passed to managed code, it appears as IDictionary&lt;int, string&gt;, and the reverse is true when the managed type is passed to JavaScript."},{"content":"<bpt id=\"p1\">**</bpt>Important<ept id=\"p1\">**</ept>  When a managed type implements multiple interfaces, JavaScript uses the interface that appears first in the list.","pos":[25018,25146],"source":"**Important**  When a managed type implements multiple interfaces, JavaScript uses the interface that appears first in the list."},{"content":"For example, if you return Dictionary<ph id=\"ph1\">&amp;lt;</ph>int, string<ph id=\"ph2\">&amp;gt;</ph> to JavaScript code, it appears as IDictionary<ph id=\"ph3\">&amp;lt;</ph>int, string<ph id=\"ph4\">&amp;gt;</ph> no matter which interface you specify as the return type.","pos":[25147,25326],"source":" For example, if you return Dictionary&lt;int, string&gt; to JavaScript code, it appears as IDictionary&lt;int, string&gt; no matter which interface you specify as the return type."},{"content":"This means that if the first interface doesn't include a member that appears on later interfaces, that member isn't visible to JavaScript.","pos":[25327,25465]},{"content":"To test the new method and use the dictionary, add the returns1 and returns2 functions to default.js:","pos":[25470,25571]},{"content":"Add the event registration code to the same then block as the other event registration code:","pos":[26342,26434]},{"content":"There are a few interesting things to observe about this JavaScript code.","pos":[26701,26774]},{"content":"First of all, it includes a showMap function to display the contents of the dictionary in HTML.","pos":[26775,26870]},{"content":"In the code for showMap, notice the iteration pattern.","pos":[26871,26925]},{"content":"In the .NET Framework, there's no First method on the generic IDictionary interface, and the size is returned by a Count property rather than by a Size method.","pos":[26926,27085]},{"content":"To JavaScript, IDictionary<ph id=\"ph1\">&amp;lt;</ph>int, string<ph id=\"ph2\">&amp;gt;</ph> appears to be the Windows Runtime type IMap<ph id=\"ph3\">&amp;lt;</ph>int, string<ph id=\"ph4\">&amp;gt;</ph>.","pos":[27086,27195],"source":" To JavaScript, IDictionary&lt;int, string&gt; appears to be the Windows Runtime type IMap&lt;int, string&gt;."},{"content":"(See the <bpt id=\"p1\">[</bpt>IMap<ph id=\"ph1\">&amp;lt;</ph>K,V<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br226042.aspx)</ept> interface.)","pos":[27196,27297],"source":" (See the [IMap&lt;K,V&gt;](https://msdn.microsoft.com/library/windows/apps/br226042.aspx) interface.)"},{"content":"In the returns2 function, as in earlier examples, JavaScript calls the Insert method (insert in JavaScript) to add items to the dictionary.","pos":[27299,27438]},{"content":"To run the app, choose the F5 key.","pos":[27440,27474]},{"content":"To create and display the initial contents of the dictionary, choose the <bpt id=\"p1\">**</bpt>Returns 1<ept id=\"p1\">**</ept> button.","pos":[27475,27569],"source":" To create and display the initial contents of the dictionary, choose the **Returns 1** button."},{"content":"To add two more entries to the dictionary, choose the <bpt id=\"p1\">**</bpt>Returns 2<ept id=\"p1\">**</ept> button.","pos":[27570,27645],"source":" To add two more entries to the dictionary, choose the **Returns 2** button."},{"content":"Notice that the entries are displayed in order of insertion, as you would expect from Dictionary<ph id=\"ph1\">&amp;lt;</ph>TKey, TValue<ph id=\"ph2\">&amp;gt;</ph>.","pos":[27646,27763],"source":" Notice that the entries are displayed in order of insertion, as you would expect from Dictionary&lt;TKey, TValue&gt;."},{"content":"If you want them sorted, you can return a SortedDictionary<ph id=\"ph1\">&amp;lt;</ph>int, string<ph id=\"ph2\">&amp;gt;</ph> from GetMapOfNames.","pos":[27764,27861],"source":" If you want them sorted, you can return a SortedDictionary&lt;int, string&gt; from GetMapOfNames."},{"content":"(The PropertySet class used in earlier examples has a different internal organization from Dictionary<ph id=\"ph1\">&amp;lt;</ph>TKey, TValue<ph id=\"ph2\">&amp;gt;</ph>.)","pos":[27862,27985],"source":" (The PropertySet class used in earlier examples has a different internal organization from Dictionary&lt;TKey, TValue&gt;.)"},{"content":"Of course, JavaScript is not a strongly typed language, so using strongly typed generic collections can lead to some surprising results.","pos":[27987,28123]},{"content":"Choose the <bpt id=\"p1\">**</bpt>Returns 2<ept id=\"p1\">**</ept> button again.","pos":[28124,28162],"source":" Choose the **Returns 2** button again."},{"content":"JavaScript obligingly coerces the \"7\" to a numeric 7, and the numeric 7 that's stored in ct to a string.","pos":[28163,28267]},{"content":"And it coerces the string \"forty\" to zero.","pos":[28268,28310]},{"content":"But that's only the beginning.","pos":[28311,28341]},{"content":"Choose the <bpt id=\"p1\">**</bpt>Returns 2<ept id=\"p1\">**</ept> button a few more times.","pos":[28342,28391],"source":" Choose the **Returns 2** button a few more times."},{"content":"In managed code, the Add method would generate duplicate key exceptions, even if the values were cast to the correct types.","pos":[28392,28515]},{"content":"In contrast, the Insert method updates the value associated with an existing key and returns a Boolean value that indicates whether a new key was added to the dictionary.","pos":[28516,28686]},{"content":"This is why the value associated with the key 7 keeps changing.","pos":[28687,28750]},{"content":"Another unexpected behavior: If you pass an unassigned JavaScript variable as a string argument, what you get is the string \"undefined\".","pos":[28752,28888]},{"content":"In short, be careful when you pass .NET Framework collection types to your JavaScript code.","pos":[28889,28980]},{"pos":[28984,29194],"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>  If you have large quantities of text to concatenate, you can do it more efficiently by moving the code into a .NET Framework method and using the StringBuilder class, as shown in the showMap function.","source":"**Note**  If you have large quantities of text to concatenate, you can do it more efficiently by moving the code into a .NET Framework method and using the StringBuilder class, as shown in the showMap function."},{"content":"Although you can't expose your own generic types from a Windows Runtime component, you can return .NET Framework generic collections for Windows Runtime classes by using code such as the following:","pos":[29196,29393]},{"content":"List<ph id=\"ph1\">&amp;lt;</ph>T<ph id=\"ph2\">&amp;gt;</ph> implements IList<ph id=\"ph3\">&amp;lt;</ph>T<ph id=\"ph4\">&amp;gt;</ph>, which appears as the Windows Runtime type IVector<ph id=\"ph5\">&amp;lt;</ph>T<ph id=\"ph6\">&amp;gt;</ph> in JavaScript.","pos":[29837,29951],"source":"List&lt;T&gt; implements IList&lt;T&gt;, which appears as the Windows Runtime type IVector&lt;T&gt; in JavaScript."},{"content":"Declaring events","pos":[29956,29972]},{"content":"You can declare events by using the standard .NET Framework event pattern or other patterns used by the Windows Runtime.","pos":[29975,30095]},{"content":"The .NET Framework supports equivalence between the System.EventHandler<ph id=\"ph1\">&amp;lt;</ph>TEventArgs<ph id=\"ph2\">&amp;gt;</ph> delegate and the Windows Runtime EventHandler<ph id=\"ph3\">&amp;lt;</ph>T<ph id=\"ph4\">&amp;gt;</ph> delegate, so using EventHandler<ph id=\"ph5\">&amp;lt;</ph>TEventArgs<ph id=\"ph6\">&amp;gt;</ph> is a good way to implement the standard .NET Framework pattern.","pos":[30096,30354],"source":" The .NET Framework supports equivalence between the System.EventHandler&lt;TEventArgs&gt; delegate and the Windows Runtime EventHandler&lt;T&gt; delegate, so using EventHandler&lt;TEventArgs&gt; is a good way to implement the standard .NET Framework pattern."},{"content":"To see how this works, add the following pair of classes to the SampleComponent project:","pos":[30355,30443]},{"content":"When you expose an event in the Windows Runtime, the event argument class inherits from System.Object.","pos":[31674,31776]},{"content":"It doesn't inherit from System.EventArgs, as it would in the .NET Framework, because EventArgs is not a Windows Runtime type.","pos":[31777,31902]},{"content":"If you declare custom event accessors for your event (<bpt id=\"p1\">**</bpt>Custom<ept id=\"p1\">**</ept> keyword in Visual Basic), you must use the Windows Runtime event pattern.","pos":[31904,32042],"source":"If you declare custom event accessors for your event (**Custom** keyword in Visual Basic), you must use the Windows Runtime event pattern."},{"content":"See <bpt id=\"p1\">[</bpt>Custom events and event accessors in Windows Runtime Components<ept id=\"p1\">](custom-events-and-event-accessors-in-windows-runtime-components.md)</ept>.","pos":[32043,32181],"source":" See [Custom events and event accessors in Windows Runtime Components](custom-events-and-event-accessors-in-windows-runtime-components.md)."},{"content":"To handle the Test event, add the events1 function to default.js.","pos":[32183,32248]},{"content":"The events1 function creates an event handler function for the Test event, and immediately invokes the OnTest method to raise the event.","pos":[32249,32385]},{"content":"If you place a breakpoint in the body of the event handler, you can see that the object passed to the single parameter includes the source object and both members of TestEventArgs.","pos":[32386,32566]},{"content":"Add the event registration code to the same then block as the other event registration code:","pos":[32898,32990]},{"content":"Exposing asynchronous operations","pos":[33133,33165]},{"content":"The .NET Framework has a rich set of tools for asynchronous processing and parallel processing, based on the Task and generic <bpt id=\"p1\">[</bpt>Task<ph id=\"ph1\">&amp;lt;</ph>TResult<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p1\">](https://msdn.microsoft.com/library/dd321424.aspx)</ept> classes.","pos":[33168,33374],"source":"The .NET Framework has a rich set of tools for asynchronous processing and parallel processing, based on the Task and generic [Task&lt;TResult&gt;](https://msdn.microsoft.com/library/dd321424.aspx) classes."},{"content":"To expose task-based asynchronous processing in a Windows Runtime component, use the Windows Runtime interfaces <bpt id=\"p1\">[</bpt>IAsyncAction<ept id=\"p1\">](https://msdn.microsoft.com/library/br205781.aspx)</ept>, <bpt id=\"p2\">[</bpt>IAsyncActionWithProgress<ph id=\"ph1\">&amp;lt;</ph>TProgress<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p2\">](https://msdn.microsoft.com/library/br205784.aspx)</ept>, <bpt id=\"p3\">[</bpt>IAsyncOperation<ph id=\"ph3\">&amp;lt;</ph>TResult<ph id=\"ph4\">&amp;gt;</ph><ept id=\"p3\">](https://msdn.microsoft.com/library/br205802.aspx)</ept>, and <bpt id=\"p4\">[</bpt>IAsyncOperationWithProgress<ph id=\"ph5\">&amp;lt;</ph>TResult, TProgress<ph id=\"ph6\">&amp;gt;</ph><ept id=\"p4\">](https://msdn.microsoft.com/library/br205807.aspx)</ept>.","pos":[33375,33842],"source":" To expose task-based asynchronous processing in a Windows Runtime component, use the Windows Runtime interfaces [IAsyncAction](https://msdn.microsoft.com/library/br205781.aspx), [IAsyncActionWithProgress&lt;TProgress&gt;](https://msdn.microsoft.com/library/br205784.aspx), [IAsyncOperation&lt;TResult&gt;](https://msdn.microsoft.com/library/br205802.aspx), and [IAsyncOperationWithProgress&lt;TResult, TProgress&gt;](https://msdn.microsoft.com/library/br205807.aspx)."},{"content":"(In the Windows Runtime, operations return results, but actions do not.)","pos":[33843,33915]},{"content":"This section demonstrates a cancelable asynchronous operation that reports progress and returns results.","pos":[33917,34021]},{"content":"The GetPrimesInRangeAsync method uses the <bpt id=\"p1\">[</bpt>AsyncInfo<ept id=\"p1\">](https://msdn.microsoft.com/library/system.runtime.interopservices.windowsruntime.asyncinfo.aspx)</ept> class to generate a task and to connect its cancellation and progress-reporting features to a WinJS.Promise object.","pos":[34022,34288],"source":" The GetPrimesInRangeAsync method uses the [AsyncInfo](https://msdn.microsoft.com/library/system.runtime.interopservices.windowsruntime.asyncinfo.aspx) class to generate a task and to connect its cancellation and progress-reporting features to a WinJS.Promise object."},{"content":"Begin by adding the following <bpt id=\"p1\">**</bpt>using<ept id=\"p1\">**</ept> statements (<bpt id=\"p2\">**</bpt>Imports<ept id=\"p2\">**</ept> in Visual Basic) to the Example class:","pos":[34289,34391],"source":" Begin by adding the following **using** statements (**Imports** in Visual Basic) to the Example class:"},{"content":"Now add the GetPrimesInRangeAsync method to the Example class:","pos":[34605,34667]},{"content":"GetPrimesInRangeAsync is a very simple prime number finder, and that's by design.","pos":[37758,37839]},{"content":"The focus here is on implementing an asynchronous operation, so simplicity is important, and a slow implementation is an advantage when we're demonstrating cancellation.","pos":[37840,38009]},{"content":"GetPrimesInRangeAsync finds primes by brute force: It divides a candidate by all the integers that are less than or equal to its square root, rather than using only the prime numbers.","pos":[38010,38193]},{"content":"Stepping through this code:","pos":[38194,38221]},{"content":"Before starting an asynchronous operation, perform housekeeping activities such as validating parameters and throwing exceptions for invalid input.","pos":[38227,38374]},{"content":"The key to this implementation is the <bpt id=\"p1\">[</bpt>AsyncInfo.Run<ph id=\"ph1\">&amp;lt;</ph>TResult, TProgress<ph id=\"ph2\">&amp;gt;</ph>(Func<ph id=\"ph3\">&amp;lt;</ph>CancellationToken, IProgress<ph id=\"ph4\">&amp;lt;</ph>TProgress<ph id=\"ph5\">&amp;gt;</ph>, Task<ph id=\"ph6\">&amp;lt;</ph>TResult<ph id=\"ph7\">&amp;gt;</ph><ept id=\"p1\">](https://msdn.microsoft.com/library/hh779740.aspx)</ept><ph id=\"ph8\">&amp;gt;</ph>) method, and the delegate that is the method's only parameter.","pos":[38379,38650],"source":"The key to this implementation is the [AsyncInfo.Run&lt;TResult, TProgress&gt;(Func&lt;CancellationToken, IProgress&lt;TProgress&gt;, Task&lt;TResult&gt;](https://msdn.microsoft.com/library/hh779740.aspx)&gt;) method, and the delegate that is the method's only parameter."},{"content":"The delegate must accept a cancellation token and an interface for reporting progress, and must return a started task that uses those parameters.","pos":[38651,38796]},{"content":"When JavaScript calls the GetPrimesInRangeAsync method, the following steps occur (not necessarily in the order given here):","pos":[38797,38921]},{"pos":[38931,39124],"content":"The <bpt id=\"p1\">[</bpt>WinJS.Promise<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br211867.aspx)</ept> object supplies functions to process the returned results, react to cancellation, and handle progress reports.","source":"The [WinJS.Promise](https://msdn.microsoft.com/library/windows/apps/br211867.aspx) object supplies functions to process the returned results, react to cancellation, and handle progress reports."},{"content":"The AsyncInfo.Run method creates a cancellation source and an object that implements the IProgress<ph id=\"ph1\">&amp;lt;</ph>T<ph id=\"ph2\">&amp;gt;</ph> interface.","pos":[39133,39251],"source":"The AsyncInfo.Run method creates a cancellation source and an object that implements the IProgress&lt;T&gt; interface."},{"content":"To the delegate, it passes both a <bpt id=\"p1\">[</bpt>CancellationToken<ept id=\"p1\">](https://msdn.microsoft.com/library/system.threading.cancellationtoken.aspx)</ept> token from the cancellation source, and the <bpt id=\"p2\">[</bpt>IProgress<ph id=\"ph1\">&amp;lt;</ph>T<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p2\">](https://msdn.microsoft.com/library/hh138298.aspx)</ept> interface.","pos":[39252,39507],"source":" To the delegate, it passes both a [CancellationToken](https://msdn.microsoft.com/library/system.threading.cancellationtoken.aspx) token from the cancellation source, and the [IProgress&lt;T&gt;](https://msdn.microsoft.com/library/hh138298.aspx) interface."},{"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>  If the Promise object doesn't supply a function to react to cancellation, AsyncInfo.Run still passes a cancelable token, and cancellation can still occur.","pos":[39519,39683],"source":"**Note**  If the Promise object doesn't supply a function to react to cancellation, AsyncInfo.Run still passes a cancelable token, and cancellation can still occur."},{"content":"If the Promise object doesn't supply a function to handle progress updates, AsyncInfo.Run still supplies an object that implements IProgress<ph id=\"ph1\">&amp;lt;</ph>T<ph id=\"ph2\">&amp;gt;</ph>, but its reports are ignored.","pos":[39684,39863],"source":" If the Promise object doesn't supply a function to handle progress updates, AsyncInfo.Run still supplies an object that implements IProgress&lt;T&gt;, but its reports are ignored."},{"content":"The delegate uses the <bpt id=\"p1\">[</bpt>Task.Run<ph id=\"ph1\">&amp;lt;</ph>TResult<ph id=\"ph2\">&amp;gt;</ph>(Func<ph id=\"ph3\">&amp;lt;</ph>TResult<ph id=\"ph4\">&amp;gt;</ph>, CancellationToken<ept id=\"p1\">](https://msdn.microsoft.com/library/hh160376.aspx)</ept>) method to create a started task that uses the token and the progress interface.","pos":[39873,40090],"source":"The delegate uses the [Task.Run&lt;TResult&gt;(Func&lt;TResult&gt;, CancellationToken](https://msdn.microsoft.com/library/hh160376.aspx)) method to create a started task that uses the token and the progress interface."},{"content":"The delegate for the started task is provided by a lambda function that computes the desired result.","pos":[40091,40191]},{"content":"More about that in a moment.","pos":[40192,40220]},{"pos":[40229,40597],"content":"The AsyncInfo.Run method creates an object that implements the <bpt id=\"p1\">[</bpt>IAsyncOperationWithProgress<ph id=\"ph1\">&amp;lt;</ph>TResult, TProgress<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br206594.aspx)</ept> interface, connects the Windows Runtime cancellation mechanism with the token source, and connects the Promise object's progress-reporting function with the IProgress<ph id=\"ph3\">&amp;lt;</ph>T<ph id=\"ph4\">&amp;gt;</ph> interface.","source":"The AsyncInfo.Run method creates an object that implements the [IAsyncOperationWithProgress&lt;TResult, TProgress&gt;](https://msdn.microsoft.com/library/windows/apps/br206594.aspx) interface, connects the Windows Runtime cancellation mechanism with the token source, and connects the Promise object's progress-reporting function with the IProgress&lt;T&gt; interface."},{"content":"The IAsyncOperationWithProgress<ph id=\"ph1\">&amp;lt;</ph>TResult, TProgress<ph id=\"ph2\">&amp;gt;</ph> interface is returned to JavaScript.","pos":[40606,40700],"source":"The IAsyncOperationWithProgress&lt;TResult, TProgress&gt; interface is returned to JavaScript."},{"content":"The lambda function that is represented by the started task doesn't take any arguments.","pos":[40706,40793]},{"content":"Because it's a lambda function, it has access to the token and the IProgress interface.","pos":[40794,40881]},{"content":"Each time a candidate number is evaluated, the lambda function:","pos":[40882,40945]},{"content":"Checks to see whether the next percentage point of progress has been reached.","pos":[40955,41032]},{"content":"If it has, the lambda function calls the IProgress<ph id=\"ph1\">&amp;lt;</ph>T<ph id=\"ph2\">&amp;gt;</ph>.Report method, and the percentage is passed through to the function that the Promise object specified for reporting progress.","pos":[41033,41218],"source":" If it has, the lambda function calls the IProgress&lt;T&gt;.Report method, and the percentage is passed through to the function that the Promise object specified for reporting progress."},{"content":"Uses the cancellation token to throw an exception if the operation has been canceled.","pos":[41227,41312]},{"content":"If the <bpt id=\"p1\">[</bpt>IAsyncInfo.Cancel<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/windows.foundation.iasyncinfo.cancel.aspx)</ept> method (which the IAsyncOperationWithProgress<ph id=\"ph1\">&amp;lt;</ph>TResult, TProgress<ph id=\"ph2\">&amp;gt;</ph> interface inherits) has been called, the connection that the AsyncInfo.Run method set up ensures that the cancellation token is notified.","pos":[41313,41640],"source":" If the [IAsyncInfo.Cancel](https://msdn.microsoft.com/library/windows/apps/windows.foundation.iasyncinfo.cancel.aspx) method (which the IAsyncOperationWithProgress&lt;TResult, TProgress&gt; interface inherits) has been called, the connection that the AsyncInfo.Run method set up ensures that the cancellation token is notified."},{"content":"When the lambda function returns the list of prime numbers, the list is passed to the function that the WinJS.Promise object specified for processing the results.","pos":[41645,41807]},{"content":"To create the JavaScript promise and set up the cancellation mechanism, add the asyncRun and asyncCancel functions to default.js.","pos":[41809,41938]},{"content":"Don't forget the event registration code the same as you did previously.","pos":[42871,42943]},{"content":"By calling the asynchronous GetPrimesInRangeAsync method, the asyncRun function creates a WinJS.Promise object.","pos":[43180,43291]},{"content":"The object's then method takes three functions that process the returned results, react to errors (including cancellation), and handle progress reports.","pos":[43292,43444]},{"content":"In this example, the returned results are printed in the output area.","pos":[43445,43514]},{"content":"Cancellation or completion resets the buttons that launch and cancel the operation.","pos":[43515,43598]},{"content":"Progress reporting updates the progress control.","pos":[43599,43647]},{"content":"The asyncCancel function just calls the cancel method of the WinJS.Promise object.","pos":[43649,43731]},{"content":"To run the app, choose the F5 key.","pos":[43733,43767]},{"content":"To start the asynchronous operation, choose the <bpt id=\"p1\">**</bpt>Async<ept id=\"p1\">**</ept> button.","pos":[43768,43833],"source":" To start the asynchronous operation, choose the **Async** button."},{"content":"What happens next depends on how fast your computer is.","pos":[43834,43889]},{"content":"If the progress bar zips to completion before you have time to blink, increase the size of the starting number that is passed to GetPrimesInRangeAsync by one or more factors of ten.","pos":[43890,44071]},{"content":"You can fine-tune the duration of the operation by increasing or decreasing the count of numbers to test, but adding zeros in the middle of the starting number will have a bigger impact.","pos":[44072,44258]},{"content":"To cancel the operation, choose the <bpt id=\"p1\">**</bpt>Cancel Async<ept id=\"p1\">**</ept> button.","pos":[44259,44319],"source":" To cancel the operation, choose the **Cancel Async** button."},{"content":"Related topics","pos":[44324,44338]},{"content":".NET for Windows Store Apps Overview","pos":[44343,44379]},{"content":".NET for UWP apps","pos":[44452,44469]},{"content":"Walkthrough: Creating a Simple Windows Runtime Component and calling it from JavaScript","pos":[44542,44629]}],"content":"---\ntitle: Creating a Simple Windows Runtime component and calling it from JavaScript\ndescription: This walkthrough shows how you can use the .NET Framework with Visual Basic or C# to create your own Windows Runtime types, packaged in a Windows Runtime component, and how to call the component from your Universal Windows app built for Windows using JavaScript.\nms.assetid: 1565D86C-BF89-4EF3-81FE-35367DB8D671\n---\n\n# Walkthrough: Creating a Simple Windows Runtime component and calling it from JavaScript\n\n\n\\[ Updated for UWP apps on Windows 10. For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]\n\n\n\\[Some information relates to pre-released product which may be substantially modified before it's commercially released. Microsoft makes no warranties, express or implied, with respect to the information provided here.\\]\n\nThis walkthrough shows how you can use the .NET Framework with Visual Basic or C# to create your own Windows Runtime types, packaged in a Windows Runtime component, and how to call the component from your Universal Windows app built for Windows using JavaScript.\n\nVisual Studio makes it easy to add a Windows Runtime component written with C# or Visual Basic to your app, and to create Windows Runtime types that you can call from JavaScript. Internally, your Windows Runtime types can use any .NET Framework functionality that's allowed in a Universal Windows app. (For more information, see [Creating Windows Runtime Components in C# and Visual Basic](creating-windows-runtime-components-in-csharp-and-visual-basic.md) and [.NET for Windows Store apps overview](https://msdn.microsoft.com/library/windows/apps/xaml/mt185501.aspx).) Externally, the members of your type can expose only Windows Runtime types for their parameters and return values. When you build your solution, Visual Studio builds your .NET Framework Windows Runtime Component project and then executes a build step that creates a Windows metadata (.winmd) file. This is your Windows Runtime component, which Visual Studio includes in your app.\n\n> **Note**  The .NET Framework automatically maps some commonly used .NET Framework types, such as primitive data types and collection types, to their Windows Runtime equivalents. These .NET Framework types can be used in the public interface of a Windows Runtime component, and will appear to users of the component as the corresponding Windows Runtime types. See [Creating Windows Runtime Components in C# and Visual Basic](creating-windows-runtime-components-in-csharp-and-visual-basic.md).\n\nThis walkthrough illustrates the following tasks. After you've completed the first section, which sets up the Windows app with JavaScript, you can complete the remaining sections in any order.\n\n## Prerequisites:\n\n-   Windows 10\n-   Microsoft Visual Studio 2015 or Microsoft Visual Studio Community 2015\n\n## Creating a simple Windows Runtime class\n\n\nThis section creates a Universal Windows app built for Windows using JavaScript, and adds a Visual Basic or C# Windows Runtime Component project. It shows how to define a managed Windows Runtime type, create an instance of the type from JavaScript, and call static and instance members. The visual display of the example app is deliberately dull to keep the focus on the component. Feel free to make it prettier.\n\n1.  In Visual Studio, create a new JavaScript project: On the menu bar, choose **File, New, Project**. In the **Installed Templates** section of the **New Project** dialog box, choose **JavaScript**, and then choose **Windows**, and then **Universal**. (If Windows is not available, make sure you're using Windows 8 or later.) Choose the **Blank Application** template and enter SampleApp for the project name.\n2.  Create the component project: In Solution Explorer, open the shortcut menu for the SampleApp solution and choose **Add**, and then choose **New Project** to add a new C# or Visual Basic project to the solution. In the **Installed Templates** section of the **Add New Project** dialog box, choose **Visual Basic** or **Visual C#**, and then choose **Windows**, and then **Universal**. Choose the **Windows Runtime Component** template and enter **SampleComponent** for the project name.\n3.  Change the name of the class to **Example**. Notice that by default, the class is marked **public sealed** (**Public NotInheritable** in Visual Basic). All the Windows Runtime classes you expose from your component must be sealed.\n4.  Add two simple members to the class, a **static** method (**Shared** method in Visual Basic) and an instance property:\n\n    > [!div class=\"tabbedCodeSnippets\"]\n    > ```cpp \n    > namespace SampleComponent\n    > {\n    >     public sealed class Example\n    >     {\n    >         public static string GetAnswer() \n    >         { \n    >             return \"The answer is 42.\"; \n    >         }\n    > \n    >         public int SampleProperty { get; set; }\n    >     }\n    > }\n    > ```\n    > ```vb\n    > Public NotInheritable Class Example\n    >     Public Shared Function GetAnswer() As String\n    >         Return \"The answer is 42.\"\n    >     End Function\n    > \n    >     Public Property SampleProperty As Integer\n    > End Class\n    > ```\n\n5.  Optional: To enable IntelliSense for the newly added members, in Solution Explorer, open the shortcut menu for the SampleComponent project, and then choose **Build**.\n6.  In Solution Explorer, in the JavaScript project, open the shortcut menu for **References**, and then choose **Add Reference** to open the **Reference Manager**. Choose **Projects**, and then choose **Solution**. Select the check box for the SampleComponent project and choose **OK** to add a reference.\n\n## Call the component from JavaScript\n\n\nTo use the Windows Runtime type from JavaScript, add the following code in the anonymous function in the default.js file (in the js folder of the project) that is provided by the Visual Studio template. It should go after the app.oncheckpoint event handler and before the call to app.start.\n\n```javascript\nvar ex;\n\nfunction basics1() {\n   document.getElementById('output').innerHTML =\n        SampleComponent.Example.getAnswer();\n\n    ex = new SampleComponent.Example();\n\n   document.getElementById('output').innerHTML += \"<br/>\" + \n       ex.sampleProperty;\n\n}\n\nfunction basics2() {\n    ex.sampleProperty += 1;\n    document.getElementById('output').innerHTML += \"<br/>\" +\n        ex.sampleProperty;\n}\n```\n\nNotice that the first letter of each member name is changed from uppercase to lowercase. This transformation is part of the support that JavaScript provides to enable the natural use of the Windows Runtime. Namespaces and class names are Pascal-cased. Member names are camel-cased except for event names, which are all lowercase. See [Using the Windows Runtime in JavaScript](https://msdn.microsoft.com/library/hh710230.aspx). The rules for camel casing can be confusing. A series of initial uppercase letters normally appears as lowercase, but if three uppercase letters are followed by a lowercase letter, only the first two letters appear in lowercase: for example, a member named IDStringKind appears as idStringKind. In Visual Studio, you can build your Windows Runtime component project and then use IntelliSense in your JavaScript project to see the correct casing.\n\nIn similar fashion, the .NET Framework provides support to enable the natural use of the Windows Runtime in managed code. This is discussed in subsequent sections of this article, and in the articles [Creating Windows Runtime Components in C# and Visual Basic](creating-windows-runtime-components-in-csharp-and-visual-basic.md) and [.NET Framework Support for Windows Store Apps and Windows Runtime](https://msdn.microsoft.com/library/hh694558.aspx).\n\n## Create a simple user interface\n\n\nIn your JavaScript project, open the default.html file and update the body as shown in the following code. This code includes the complete set of controls for the example app and specifies the function names for the click events.\n\n> **Note**  When you first run the app, only the Basics1 and Basics2 button are supported.\n\n```html\n<body>\n            <div id=\"buttons\">\n            <button id=\"button1\" >Basics 1</button>\n            <button id=\"button2\" >Basics 2</button>\n\n            <button id=\"runtimeButton1\">Runtime 1</button>\n            <button id=\"runtimeButton2\">Runtime 2</button>\n\n            <button id=\"returnsButton1\">Returns 1</button>\n            <button id=\"returnsButton2\">Returns 2</button>\n\n            <button id=\"events1Button\">Events 1</button>\n\n            <button id=\"btnAsync\">Async</button>\n            <button id=\"btnCancel\" disabled=\"disabled\">Cancel Async</button>\n            <progress id=\"primeProg\" value=\"25\" max=\"100\" style=\"color: yellow;\"></progress>\n        </div>\n        <div id=\"output\">\n        </div>\n</body>\n```\n\nIn your JavaScript project, in the css folder, open default.css. Modify the body section as shown, and add styles to control the layout of buttons and the placement of output text.\n\n```css\nbody\n{\n    -ms-grid-columns: 1fr;\n    -ms-grid-rows: 1fr 14fr;\n    display: -ms-grid;\n}\n\n#buttons {\n    -ms-grid-rows: 1fr;\n    -ms-grid-columns: auto;\n    -ms-grid-row-align: start;\n}\n#output {\n    -ms-grid-row: 2;\n    -ms-grid-column: 1;\n}\n```\n\nNow add the event listener registration code by adding a then clause to the processAll call in app.onactivated in default.js. Replace the existing line of code that calls setPromise and change it to the following code:\n\n```javascript\nargs.setPromise(WinJS.UI.processAll().then(function () {\n    var button1 = document.getElementById(\"button1\");\n    button1.addEventListener(\"click\", basics1, false);\n    var button2 = document.getElementById(\"button2\");\n    button2.addEventListener(\"click\", basics2, false);\n}));\n```\n\nThis is a better way to add events to HTML controls than adding a click event handler directly in HTML. See [Create a \"Hello World\" app (JS)](https://msdn.microsoft.com/library/windows/apps/mt280216).\n\n## Build and run the app\n\n\nBefore you build, change the target platform for all projects to ARM, x64, or x86, as appropriate for your computer.\n\nTo build and run the solution, choose the F5 key. (If you get a run-time error message stating that SampleComponent is undefined, the reference to the class library project is missing.)\n\nVisual Studio first compiles the class library, and then executes an MSBuild task that runs [Winmdexp.exe (Windows Runtime Metadata Export Tool)](https://msdn.microsoft.com/library/hh925576.aspx) to create your Windows Runtime component. The component is included in a .winmd file that contains both the managed code and the Windows metadata that describes the code. WinMdExp.exe generates build error messages when you write code that's invalid in a Windows Runtime component, and the error messages are displayed in the Visual Studio IDE. Visual Studio adds your component to the app package (.appx file) for your Universal Windows app, and generates the appropriate manifest.\n\nChoose the Basics 1 button to assign the return value from the static GetAnswer method to the output area, create an instance of the Example class, and display the value of its SampleProperty property in the output area. The output is shown here:\n\n``` syntax\n\"The answer is 42.\"\n0\n```\n\nChoose the Basics 2 button to increment the value of the SampleProperty property and to display the new value in the output area. Primitive types such as strings and numbers can be used as parameter types and return types, and can be passed between managed code and JavaScript. Because numbers in JavaScript are stored in double-precision floating-point format, they are converted to .NET Framework numeric types.\n\n> **Note**  By default, you can set breakpoints only in your JavaScript code. To debug your Visual Basic or C# code, see Creating Windows Runtime Components in C# and Visual Basic.\n\n \n\nTo stop debugging and close your app, switch from the app to Visual Studio, and choose Shift+F5.\n\n## Using the Windows Runtime from JavaScript and managed code\n\n\nThe Windows Runtime can be called from either JavaScript or managed code. Windows Runtime objects can be passed back and forth between the two, and events can be handled from either side. However, the ways you use Windows Runtime types in the two environments differ in some details, because JavaScript and the .NET Framework support the Windows Runtime differently. The following example demonstrates these differences, using the [Windows.Foundation.Collections.PropertySet](https://msdn.microsoft.com/library/windows/apps/windows.foundation.collections.propertyset.aspx) class. In this example, you create an instance of the PropertySet collection in managed code and register an event handler to track changes in the collection. Then you add JavaScript code that gets the collection, registers its own event handler, and uses the collection. Finally, you add a method that makes changes to the collection from managed code and shows JavaScript handling a managed exception.\n\n> **Important**  In this example, the event is being fired on the UI thread. If you fire the event from a background thread, for example in an async call, you will need to do some extra work in order for JavaScript to handle the event. For more information, see [Raising Events in Windows Runtime Components](raising-events-in-windows-runtime-components.md).\n\n \n\nIn the SampleComponent project, add a new **public sealed** class (**Public NotInheritable** class in Visual Basic) named PropertySetStats. The class wraps a PropertySet collection and handles its MapChanged event. The event handler tracks the number of changes of each kind that occur, and the DisplayStats method produces a report that is formatted in HTML. Notice the additional **using** statement (**Imports** statement in Visual Basic); be careful to add this to the existing **using** statements rather than overwriting them.\n\n> [!div class=\"tabbedCodeSnippets\"]\n> ```csharp\n> using Windows.Foundation.Collections;\n> \n> namespace SampleComponent\n> {\n>     public sealed class PropertySetStats\n>     {\n>         private PropertySet _ps;\n>         public PropertySetStats()\n>         {\n>             _ps = new PropertySet();\n>             _ps.MapChanged += this.MapChangedHandler;\n>         }\n> \n>         public PropertySet PropertySet { get { return _ps; } }\n> \n>         int[] counts = { 0, 0, 0, 0 };\n>         private void MapChangedHandler(IObservableMap<string, object> sender,\n>             IMapChangedEventArgs<string> args)\n>         {\n>             counts[(int)args.CollectionChange] += 1;\n>         }\n> \n>         public string DisplayStats()\n>         {\n>             StringBuilder report = new StringBuilder(\"<br/>Number of changes:<ul>\");\n>             for (int i = 0; i < counts.Length; i++)\n>             {\n>                 report.Append(\"<li>\" + (CollectionChange)i + \": \" + counts[i] + \"</li>\");\n>             }\n>             return report.ToString() + \"</ul>\";\n>         }\n>     }\n> }\n> ```\n> ```vb\n> Imports System.Text\n> \n> Public NotInheritable Class PropertySetStats\n>     Private _ps As PropertySet\n>     Public Sub New()\n>         _ps = New PropertySet()\n>         AddHandler _ps.MapChanged, AddressOf Me.MapChangedHandler\n>     End Sub\n> \n>     Public ReadOnly Property PropertySet As PropertySet\n>         Get\n>             Return _ps\n>         End Get\n>     End Property\n> \n>     Dim counts() As Integer = {0, 0, 0, 0}\n>     Private Sub MapChangedHandler(ByVal sender As IObservableMap(Of String, Object),\n>         ByVal args As IMapChangedEventArgs(Of String))\n> \n>         counts(CInt(args.CollectionChange)) += 1\n>     End Sub\n> \n>     Public Function DisplayStats() As String\n>         Dim report As New StringBuilder(\"<br/>Number of changes:<ul>\")\n>         For i As Integer = 0 To counts.Length - 1\n>             report.Append(\"<li>\" &amp; CType(i, CollectionChange).ToString() &amp;\n>                           \": \" &amp; counts(i) &amp; \"</li>\")\n>         Next\n>         Return report.ToString() &amp; \"</ul>\"\n>     End Function\n> End Class\n> ```\n\nThe event handler follows the familiar .NET Framework event pattern, except that the sender of the event (in this case, the PropertySet object) is cast to the IObservableMap&lt;string, object&gt; interface (IObservableMap(Of String, Object) in Visual Basic), which is an instantiation of the Windows Runtime interface [IObservableMap&lt;K, V&gt;](https://msdn.microsoft.com/library/windows/apps/br226050.aspx). (You can cast the sender to its type if necessary.) Also, the event arguments are presented as an interface rather than as an object.\n\nIn the default.js file, add the Runtime1 function as shown. This code creates a PropertySetStats object, gets its PropertySet collection, and adds its own event handler, the onMapChanged function, to handle the MapChanged event. After making changes to the collection, runtime1 calls the DisplayStats method to show a summary of change types.\n\n```javascript\nvar propertysetstats;\n\nfunction runtime1() {\n    document.getElementById('output').innerHTML = \"\";\n\n    propertysetstats = new SampleComponent.PropertySetStats();\n    var propertyset = propertysetstats.propertySet;\n\n    propertyset.addEventListener(\"mapchanged\", onMapChanged);\n\n    propertyset.insert(\"FirstProperty\", \"First property value\");\n    propertyset.insert(\"SuperfluousProperty\", \"Unnecessary property value\");\n    propertyset.insert(\"AnotherProperty\", \"A property value\");\n\n    propertyset.insert(\"SuperfluousProperty\", \"Altered property value\")\n    propertyset.remove(\"SuperfluousProperty\");\n\n    document.getElementById('output').innerHTML +=\n        propertysetstats.displayStats();\n}\n\nfunction onMapChanged(change) {\n    var result\n    switch (change.collectionChange) {\n        case Windows.Foundation.Collections.CollectionChange.reset:\n            result = \"All properties cleared\";\n            break;\n        case Windows.Foundation.Collections.CollectionChange.itemInserted:\n            result = \"Inserted \" + change.key + \": '\" + \n                change.target.lookup(change.key) + \"'\";\n            break;\n        case Windows.Foundation.Collections.CollectionChange.itemRemoved:\n            result = \"Removed \" + change.key;\n            break;\n        case Windows.Foundation.Collections.CollectionChange.itemChanged:\n            result = \"Changed \" + change.key + \" to '\" +\n                change.target.lookup(change.key) + \"'\";\n            break;\n        default:\n            break;\n     }\n\n     document.getElementById('output').innerHTML +=\n         \"<br/>\" + result;\n}\n```\n\nThe way you handle Windows Runtime events in JavaScript is very different from the way you handle them in .NET Framework code. The JavaScript event handler takes only one argument. When you view this object in the Visual Studio debugger, the first property is the sender. The members of the event argument interface also appear directly on this object.\n\nTo run the app, choose the F5 key. If the class is not sealed, you get the error message, \"Exporting unsealed type 'SampleComponent.Example' is not currently supported. Please mark it as sealed.\"\n\nChoose the **Runtime 1** button. The event handler displays changes as elements are added or changed, and at the end the DisplayStats method is called to produce a summary of counts. To stop debugging and close the app, switch back to Visual Studio and choose Shift+F5.\n\nTo add two more items to the PropertySet collection from managed code, add the following code to the PropertySetStats class:\n\n> [!div class=\"tabbedCodeSnippets\"]\n> ```csharp\n> public void AddMore()\n> {\n>     _ps.Add(\"NewProperty\", \"New property value\");\n>     _ps.Add(\"AnotherProperty\", \"A property value\");\n> }\n> ```\n> ```vb\n> Public Sub AddMore()\n>     _ps.Add(\"NewProperty\", \"New property value\")\n>     _ps.Add(\"AnotherProperty\", \"A property value\")\n> End Sub\n> ```\n\nThis code highlights another difference in the way you use Windows Runtime types in the two environments. If you type this code yourself, you'll notice that IntelliSense doesn't show the insert method you used in the JavaScript code. Instead, it shows the Add method commonly seen on collections in the .NET Framework. This is because some commonly used collection interfaces have different names but similar functionality in the Windows Runtime and the .NET Framework. When you use these interfaces in managed code, they appear as their .NET Framework equivalents. This is discussed in [Creating Windows Runtime Components in C# and Visual Basic](creating-windows-runtime-components-in-csharp-and-visual-basic.md). When you use the same interfaces in JavaScript, the only change from the Windows Runtime is that uppercase letters at the beginning of member names become lowercase.\n\nFinally, to call the AddMore method with exception handling, add the runtime2 function to default.js.\n\n```javascript\nfunction runtime2() {\n   try {\n      propertysetstats.addMore();\n    }\n   catch(ex) {\n       document.getElementById('output').innerHTML +=\n          \"<br/><b>\" + ex + \"<br/>\";\n   }\n\n   document.getElementById('output').innerHTML +=\n       propertysetstats.displayStats();\n}\n```\n\nAdd the event handler registration code the same way you did previously.\n\n```javascript\nvar runtimeButton1 = document.getElementById(\"runtimeButton1\");\nruntimeButton1.addEventListener(\"click\", runtime1, false);\nvar runtimeButton2 = document.getElementById(\"runtimeButton2\");\nruntimeButton2.addEventListener(\"click\", runtime2, false);\n```\n\nTo run the app, choose the F5 key. Choose **Runtime 1** and then **Runtime 2**. The JavaScript event handler reports the first change to the collection. The second change, however, has a duplicate key. Users of .NET Framework dictionaries expect the Add method to throw an exception, and that is what happens. JavaScript handles the .NET Framework exception.\n\n> **Note**  You can't display the exception's message from JavaScript code. The message text is replaced by a stack trace. For more information, see \"Throwing exceptions\" in Creating Windows Runtime Components in C# and Visual Basic.\n\nBy contrast, when JavaScript called the insert method with a duplicate key, the value of the item was changed. This difference in behavior is due to the different ways that JavaScript and the .NET Framework support the Windows Runtime, as explained in [Creating Windows Runtime Components in C# and Visual Basic](creating-windows-runtime-components-in-csharp-and-visual-basic.md).\n\n## Returning managed types from your component\n\n\nAs discussed previously, you can pass native Windows Runtime types back and forth freely between your JavaScript code and your C# or Visual Basic code. Most of the time, the type names and member names will be the same in both cases (except that the member names start with lowercase letters in JavaScript). However, in the preceding section, the PropertySet class appeared to have different members in managed code. (For example, in JavaScript you called the insert method, and in the .NET Framework code you called the Add method.) This section explores the way those differences affect .NET Framework types passed to JavaScript.\n\nIn addition to returning Windows Runtime types that you created in your component or passed to your component from JavaScript, you can return a managed type, created in managed code, to JavaScript as if it were the corresponding Windows Runtime type. Even in the first, simple example of a runtime class, the parameters and return types of the members were Visual Basic or C# primitive types, which are .NET Framework types. To demonstrate this for collections, add the following code to the Example class, to create a method that returns a generic dictionary of strings, indexed by integers:\n\n> [!div class=\"tabbedCodeSnippets\"]\n> ```csharp\n> public static IDictionary<int, string> GetMapOfNames()\n> {\n>     Dictionary<int, string> retval = new Dictionary<int, string>();\n>     retval.Add(1, \"one\");\n>     retval.Add(2, \"two\");\n>     retval.Add(3, \"three\");\n>     retval.Add(42, \"forty-two\");\n>     retval.Add(100, \"one hundred\");\n>     return retval;\n> }\n> ```\n> ```vb\n> Public Shared Function GetMapOfNames() As IDictionary(Of Integer, String)\n>     Dim retval As New Dictionary(Of Integer, String)\n>     retval.Add(1, \"one\")\n>     retval.Add(2, \"two\")\n>     retval.Add(3, \"three\")\n>     retval.Add(42, \"forty-two\")\n>     retval.Add(100, \"one hundred\")\n>     Return retval\n> End Function\n> ```\n\nNotice that the dictionary must be returned as an interface that is implemented by [Dictionary&lt;TKey, TValue&gt;](https://msdn.microsoft.com/library/xfhwa508.aspx), and that maps to a Windows Runtime interface. In this case, the interface is IDictionary&lt;int, string&gt; (IDictionary(Of Integer, String) in Visual Basic). When the Windows Runtime type IMap&lt;int, string&gt; is passed to managed code, it appears as IDictionary&lt;int, string&gt;, and the reverse is true when the managed type is passed to JavaScript.\n\n**Important**  When a managed type implements multiple interfaces, JavaScript uses the interface that appears first in the list. For example, if you return Dictionary&lt;int, string&gt; to JavaScript code, it appears as IDictionary&lt;int, string&gt; no matter which interface you specify as the return type. This means that if the first interface doesn't include a member that appears on later interfaces, that member isn't visible to JavaScript.\n\n \n\nTo test the new method and use the dictionary, add the returns1 and returns2 functions to default.js:\n\n```javascript\nvar names;\n\nfunction returns1() {\n    names = SampleComponent.Example.getMapOfNames();\n    document.getElementById('output').innerHTML = showMap(names);\n}\n\nvar ct = 7;\n\nfunction returns2() {\n    if (!names.hasKey(17)) {\n        names.insert(43, \"forty-three\");\n        names.insert(17, \"seventeen\");\n    }\n    else {\n        var err = names.insert(\"7\", ct++);\n        names.insert(\"forty\", \"forty\");\n    }\n    document.getElementById('output').innerHTML = showMap(names);\n}\n\nfunction showMap(map) {\n    var item = map.first();\n    var retval = \"<ul>\";\n\n    for (var i = 0, len = map.size; i < len; i++) {\n        retval += \"<li>\" + item.current.key + \": \" + item.current.value + \"</li>\";\n        item.moveNext();\n    }\n    return retval + \"</ul>\";\n}\n```\n\nAdd the event registration code to the same then block as the other event registration code:\n\n```javascript\nvar returnsButton1 = document.getElementById(\"returnsButton1\");\nreturnsButton1.addEventListener(\"click\", returns1, false);\nvar returnsButton2 = document.getElementById(\"returnsButton2\");\nreturnsButton2.addEventListener(\"click\", returns2, false);\n```\n\nThere are a few interesting things to observe about this JavaScript code. First of all, it includes a showMap function to display the contents of the dictionary in HTML. In the code for showMap, notice the iteration pattern. In the .NET Framework, there's no First method on the generic IDictionary interface, and the size is returned by a Count property rather than by a Size method. To JavaScript, IDictionary&lt;int, string&gt; appears to be the Windows Runtime type IMap&lt;int, string&gt;. (See the [IMap&lt;K,V&gt;](https://msdn.microsoft.com/library/windows/apps/br226042.aspx) interface.)\n\nIn the returns2 function, as in earlier examples, JavaScript calls the Insert method (insert in JavaScript) to add items to the dictionary.\n\nTo run the app, choose the F5 key. To create and display the initial contents of the dictionary, choose the **Returns 1** button. To add two more entries to the dictionary, choose the **Returns 2** button. Notice that the entries are displayed in order of insertion, as you would expect from Dictionary&lt;TKey, TValue&gt;. If you want them sorted, you can return a SortedDictionary&lt;int, string&gt; from GetMapOfNames. (The PropertySet class used in earlier examples has a different internal organization from Dictionary&lt;TKey, TValue&gt;.)\n\nOf course, JavaScript is not a strongly typed language, so using strongly typed generic collections can lead to some surprising results. Choose the **Returns 2** button again. JavaScript obligingly coerces the \"7\" to a numeric 7, and the numeric 7 that's stored in ct to a string. And it coerces the string \"forty\" to zero. But that's only the beginning. Choose the **Returns 2** button a few more times. In managed code, the Add method would generate duplicate key exceptions, even if the values were cast to the correct types. In contrast, the Insert method updates the value associated with an existing key and returns a Boolean value that indicates whether a new key was added to the dictionary. This is why the value associated with the key 7 keeps changing.\n\nAnother unexpected behavior: If you pass an unassigned JavaScript variable as a string argument, what you get is the string \"undefined\". In short, be careful when you pass .NET Framework collection types to your JavaScript code.\n\n> **Note**  If you have large quantities of text to concatenate, you can do it more efficiently by moving the code into a .NET Framework method and using the StringBuilder class, as shown in the showMap function.\n\nAlthough you can't expose your own generic types from a Windows Runtime component, you can return .NET Framework generic collections for Windows Runtime classes by using code such as the following:\n\n> [!div class=\"tabbedCodeSnippets\"]\n> ```csharp\n> public static object GetListOfThis(object obj)\n> {\n>     Type target = obj.GetType();\n>     return Activator.CreateInstance(typeof(List<>).MakeGenericType(target));\n> }\n> ```\n> ```vb\n> Public Shared Function GetListOfThis(obj As Object) As Object\n>     Dim target As Type = obj.GetType()\n>     Return Activator.CreateInstance(GetType(List(Of )).MakeGenericType(target))\n> End Function\n> ```\n\nList&lt;T&gt; implements IList&lt;T&gt;, which appears as the Windows Runtime type IVector&lt;T&gt; in JavaScript.\n\n## Declaring events\n\n\nYou can declare events by using the standard .NET Framework event pattern or other patterns used by the Windows Runtime. The .NET Framework supports equivalence between the System.EventHandler&lt;TEventArgs&gt; delegate and the Windows Runtime EventHandler&lt;T&gt; delegate, so using EventHandler&lt;TEventArgs&gt; is a good way to implement the standard .NET Framework pattern. To see how this works, add the following pair of classes to the SampleComponent project:\n\n> [!div class=\"tabbedCodeSnippets\"]\n> ```csharp\n> namespace SampleComponent\n> {\n>     public sealed class Eventful\n>     {\n>         public event EventHandler<TestEventArgs> Test;\n>         public void OnTest(string msg, long number)\n>         {\n>             EventHandler<TestEventArgs> temp = Test;\n>             if (temp != null)\n>             {\n>                 temp(this, new TestEventArgs()\n>                 {\n>                     Value1 = msg,\n>                     Value2 = number\n>                 });\n>             }\n>         }\n>     }\n> \n>     public sealed class TestEventArgs\n>     {\n>         public string Value1 { get; set; }\n>         public long Value2 { get; set; }\n>     }\n> }\n> ```\n> ```vb\n> Public NotInheritable Class Eventful\n>     Public Event Test As EventHandler(Of TestEventArgs)\n>     Public Sub OnTest(ByVal msg As String, ByVal number As Long)\n>         RaiseEvent Test(Me, New TestEventArgs() With {\n>                             .Value1 = msg,\n>                             .Value2 = number\n>                             })\n>     End Sub\n> End Class\n> \n> Public NotInheritable Class TestEventArgs\n>     Public Property Value1 As String\n>     Public Property Value2 As Long\n> End Class\n> ```\n\nWhen you expose an event in the Windows Runtime, the event argument class inherits from System.Object. It doesn't inherit from System.EventArgs, as it would in the .NET Framework, because EventArgs is not a Windows Runtime type.\n\nIf you declare custom event accessors for your event (**Custom** keyword in Visual Basic), you must use the Windows Runtime event pattern. See [Custom events and event accessors in Windows Runtime Components](custom-events-and-event-accessors-in-windows-runtime-components.md).\n\nTo handle the Test event, add the events1 function to default.js. The events1 function creates an event handler function for the Test event, and immediately invokes the OnTest method to raise the event. If you place a breakpoint in the body of the event handler, you can see that the object passed to the single parameter includes the source object and both members of TestEventArgs.\n\n```javascript\nvar ev;\n\nfunction events1() {\n   ev = new SampleComponent.Eventful();\n   ev.addEventListener(\"test\", function (e) {\n       document.getElementById('output').innerHTML = e.value1;\n       document.getElementById('output').innerHTML += \"<br/>\" + e.value2;\n   });\n   ev.onTest(\"Number of feet in a mile:\", 5280);\n}\n```\n\nAdd the event registration code to the same then block as the other event registration code:\n\n```javascript\nvar events1Button = document.getElementById(\"events1Button\");\nevents1Button.addEventListener(\"click\", events1, false);\n```\n\n## Exposing asynchronous operations\n\n\nThe .NET Framework has a rich set of tools for asynchronous processing and parallel processing, based on the Task and generic [Task&lt;TResult&gt;](https://msdn.microsoft.com/library/dd321424.aspx) classes. To expose task-based asynchronous processing in a Windows Runtime component, use the Windows Runtime interfaces [IAsyncAction](https://msdn.microsoft.com/library/br205781.aspx), [IAsyncActionWithProgress&lt;TProgress&gt;](https://msdn.microsoft.com/library/br205784.aspx), [IAsyncOperation&lt;TResult&gt;](https://msdn.microsoft.com/library/br205802.aspx), and [IAsyncOperationWithProgress&lt;TResult, TProgress&gt;](https://msdn.microsoft.com/library/br205807.aspx). (In the Windows Runtime, operations return results, but actions do not.)\n\nThis section demonstrates a cancelable asynchronous operation that reports progress and returns results. The GetPrimesInRangeAsync method uses the [AsyncInfo](https://msdn.microsoft.com/library/system.runtime.interopservices.windowsruntime.asyncinfo.aspx) class to generate a task and to connect its cancellation and progress-reporting features to a WinJS.Promise object. Begin by adding the following **using** statements (**Imports** in Visual Basic) to the Example class:\n\n> [!div class=\"tabbedCodeSnippets\"]\n> ```csharp\n> using System.Runtime.InteropServices.WindowsRuntime;\n> using Windows.Foundation;\n> ```\n> ```vb\n> Imports System.Runtime.InteropServices.WindowsRuntime\n> ```\n> \n> Now add the GetPrimesInRangeAsync method to the Example class:\n> \n> > [!div class=\"tabbedCodeSnippets\"]\n> ```csharp\n> public static IAsyncOperationWithProgress<IList<long>, double> GetPrimesInRangeAsync(long start, long count)\n> {\n>     if (start < 2 || count < 1) throw new ArgumentException();\n> \n>     return AsyncInfo.Run<IList<long>, double>((token, progress) =>\n> \n>         Task.Run<IList<long>>(() =>\n>         {\n>             List<long> primes = new List<long>();\n>             double onePercent = count / 100;\n>             long ctProgress = 0;\n>             double nextProgress = onePercent;\n> \n>             for (long candidate = start; candidate < start + count; candidate++)\n>             {\n>                 ctProgress += 1;\n>                 if (ctProgress >= nextProgress)\n>                 {\n>                     progress.Report(ctProgress / onePercent);\n>                     nextProgress += onePercent;\n>                 }\n>                 bool isPrime = true;\n>                 for (long i = 2, limit = (long)Math.Sqrt(candidate); i <= limit; i++)\n>                 {\n>                     if (candidate % i == 0)\n>                     {\n>                         isPrime = false;\n>                         break;\n>                     }\n>                 }\n>                 if (isPrime) primes.Add(candidate);\n> \n>                 token.ThrowIfCancellationRequested();\n>             }\n>             progress.Report(100.0);\n>             return primes;\n>         }, token)\n>     );\n> }\n> ```\n> ```vb\n> Public Shared Function GetPrimesInRangeAsync(ByVal start As Long, ByVal count As Long) As IAsyncOperationWithProgress(Of IList(Of Long), Double)\n> \n>     If (start < 2 Or count < 1) Then Throw New ArgumentException()\n> \n>     Return AsyncInfo.Run(Of IList(Of Long), Double)( _\n>         Function(token, prog)\n>             Return Task.Run(Of IList(Of Long))( _\n>                 Function()\n>                     Dim primes As New List(Of Long)\n>                     Dim onePercent As Long = count / 100\n>                     Dim ctProgress As Long = 0\n>                     Dim nextProgress As Long = onePercent\n> \n>                     For candidate As Long = start To start + count - 1\n>                         ctProgress += 1\n> \n>                         If ctProgress >= nextProgress Then\n>                             prog.Report(ctProgress / onePercent)\n>                             nextProgress += onePercent\n>                         End If\n> \n>                         Dim isPrime As Boolean = True\n>                         For i As Long = 2 To CLng(Math.Sqrt(candidate))\n>                             If (candidate Mod i) = 0 Then\n>                                 isPrime = False\n>                                 Exit For\n>                             End If\n>                         Next\n> \n>                         If isPrime Then primes.Add(candidate)\n> \n>                         token.ThrowIfCancellationRequested()\n>                     Next\n>                     prog.Report(100.0)\n>                     Return primes\n>                 End Function, token)\n>         End Function)\n> End Function\n> ```\n\nGetPrimesInRangeAsync is a very simple prime number finder, and that's by design. The focus here is on implementing an asynchronous operation, so simplicity is important, and a slow implementation is an advantage when we're demonstrating cancellation. GetPrimesInRangeAsync finds primes by brute force: It divides a candidate by all the integers that are less than or equal to its square root, rather than using only the prime numbers. Stepping through this code:\n\n-   Before starting an asynchronous operation, perform housekeeping activities such as validating parameters and throwing exceptions for invalid input.\n-   The key to this implementation is the [AsyncInfo.Run&lt;TResult, TProgress&gt;(Func&lt;CancellationToken, IProgress&lt;TProgress&gt;, Task&lt;TResult&gt;](https://msdn.microsoft.com/library/hh779740.aspx)&gt;) method, and the delegate that is the method's only parameter. The delegate must accept a cancellation token and an interface for reporting progress, and must return a started task that uses those parameters. When JavaScript calls the GetPrimesInRangeAsync method, the following steps occur (not necessarily in the order given here):\n\n    -   The [WinJS.Promise](https://msdn.microsoft.com/library/windows/apps/br211867.aspx) object supplies functions to process the returned results, react to cancellation, and handle progress reports.\n    -   The AsyncInfo.Run method creates a cancellation source and an object that implements the IProgress&lt;T&gt; interface. To the delegate, it passes both a [CancellationToken](https://msdn.microsoft.com/library/system.threading.cancellationtoken.aspx) token from the cancellation source, and the [IProgress&lt;T&gt;](https://msdn.microsoft.com/library/hh138298.aspx) interface.\n\n        > **Note**  If the Promise object doesn't supply a function to react to cancellation, AsyncInfo.Run still passes a cancelable token, and cancellation can still occur. If the Promise object doesn't supply a function to handle progress updates, AsyncInfo.Run still supplies an object that implements IProgress&lt;T&gt;, but its reports are ignored.\n\n    -   The delegate uses the [Task.Run&lt;TResult&gt;(Func&lt;TResult&gt;, CancellationToken](https://msdn.microsoft.com/library/hh160376.aspx)) method to create a started task that uses the token and the progress interface. The delegate for the started task is provided by a lambda function that computes the desired result. More about that in a moment.\n    -   The AsyncInfo.Run method creates an object that implements the [IAsyncOperationWithProgress&lt;TResult, TProgress&gt;](https://msdn.microsoft.com/library/windows/apps/br206594.aspx) interface, connects the Windows Runtime cancellation mechanism with the token source, and connects the Promise object's progress-reporting function with the IProgress&lt;T&gt; interface.\n    -   The IAsyncOperationWithProgress&lt;TResult, TProgress&gt; interface is returned to JavaScript.\n\n-   The lambda function that is represented by the started task doesn't take any arguments. Because it's a lambda function, it has access to the token and the IProgress interface. Each time a candidate number is evaluated, the lambda function:\n\n    -   Checks to see whether the next percentage point of progress has been reached. If it has, the lambda function calls the IProgress&lt;T&gt;.Report method, and the percentage is passed through to the function that the Promise object specified for reporting progress.\n    -   Uses the cancellation token to throw an exception if the operation has been canceled. If the [IAsyncInfo.Cancel](https://msdn.microsoft.com/library/windows/apps/windows.foundation.iasyncinfo.cancel.aspx) method (which the IAsyncOperationWithProgress&lt;TResult, TProgress&gt; interface inherits) has been called, the connection that the AsyncInfo.Run method set up ensures that the cancellation token is notified.\n-   When the lambda function returns the list of prime numbers, the list is passed to the function that the WinJS.Promise object specified for processing the results.\n\nTo create the JavaScript promise and set up the cancellation mechanism, add the asyncRun and asyncCancel functions to default.js.\n\n```javascript\nvar resultAsync;\nfunction asyncRun() {\n    document.getElementById('output').innerHTML = \"Retrieving prime numbers.\";\n    btnAsync.disabled = \"disabled\";\n    btnCancel.disabled = \"\";\n\n    resultAsync = SampleComponent.Example.getPrimesInRangeAsync(10000000000001, 2500).then(\n        function (primes) {\n            for (i = 0; i < primes.length; i++)\n                document.getElementById('output').innerHTML += \" \" + primes[i];\n\n            btnCancel.disabled = \"disabled\";\n            btnAsync.disabled = \"\";\n        },\n        function () {\n            document.getElementById('output').innerHTML += \" -- getPrimesInRangeAsync was canceled. -- \";\n\n            btnCancel.disabled = \"disabled\";\n            btnAsync.disabled = \"\";\n        },\n        function (prog) {\n            document.getElementById('primeProg').value = prog;\n        }\n    );\n}\n\nfunction asyncCancel() {    \n    resultAsync.cancel();\n}\n```\n\nDon't forget the event registration code the same as you did previously.\n\n```javascript\nvar btnAsync = document.getElementById(\"btnAsync\");\nbtnAsync.addEventListener(\"click\", asyncRun, false);\nvar btnCancel = document.getElementById(\"btnCancel\");\nbtnCancel.addEventListener(\"click\", asyncCancel, false);\n```\n\nBy calling the asynchronous GetPrimesInRangeAsync method, the asyncRun function creates a WinJS.Promise object. The object's then method takes three functions that process the returned results, react to errors (including cancellation), and handle progress reports. In this example, the returned results are printed in the output area. Cancellation or completion resets the buttons that launch and cancel the operation. Progress reporting updates the progress control.\n\nThe asyncCancel function just calls the cancel method of the WinJS.Promise object.\n\nTo run the app, choose the F5 key. To start the asynchronous operation, choose the **Async** button. What happens next depends on how fast your computer is. If the progress bar zips to completion before you have time to blink, increase the size of the starting number that is passed to GetPrimesInRangeAsync by one or more factors of ten. You can fine-tune the duration of the operation by increasing or decreasing the count of numbers to test, but adding zeros in the middle of the starting number will have a bigger impact. To cancel the operation, choose the **Cancel Async** button.\n\n## Related topics\n\n* [.NET for Windows Store Apps Overview](https://msdn.microsoft.com/library/windows/apps/xaml/br230302.aspx)\n* [.NET for UWP apps](https://msdn.microsoft.com/library/windows/apps/xaml/mt185501.aspx)\n* [Walkthrough: Creating a Simple Windows Runtime Component and calling it from JavaScript](walkthrough-creating-a-simple-windows-runtime-component-and-calling-it-from-javascript.md)\n\n"}