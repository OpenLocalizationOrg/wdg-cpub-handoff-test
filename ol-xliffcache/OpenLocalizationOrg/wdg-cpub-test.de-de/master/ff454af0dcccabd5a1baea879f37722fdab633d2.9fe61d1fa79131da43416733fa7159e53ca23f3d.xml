{"nodes":[{"pos":[11,20],"content":"Add sound","needQuote":true,"needEscape":true,"nodes":[{"content":"Add sound","pos":[0,9]}]},{"pos":[34,148],"content":"In this step, we examine how the shooting game sample creates an object for sound playback using the XAudio2 APIs.","needQuote":true,"needEscape":true,"nodes":[{"content":"In this step, we examine how the shooting game sample creates an object for sound playback using the XAudio2 APIs.","pos":[0,114]}]},{"content":"Add sound","pos":[205,214]},{"content":"\\[ Updated for UWP apps on Windows 10.","pos":[217,255]},{"content":"For Windows 8.x articles, see the <bpt id=\"p1\">[</bpt>archive<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=619132)</ept> \\]","pos":[256,351],"source":" For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]"},{"pos":[353,530],"content":"In this step, we examine how the shooting game sample creates an object for sound playback using the <bpt id=\"p1\">[</bpt>XAudio2<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/ee415813)</ept> APIs.","source":"In this step, we examine how the shooting game sample creates an object for sound playback using the [XAudio2](https://msdn.microsoft.com/library/windows/desktop/ee415813) APIs."},{"content":"Objective","pos":[535,544]},{"pos":[551,648],"content":"To add sound output using <bpt id=\"p1\">[</bpt>XAudio2<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/ee415813)</ept>.","source":"To add sound output using [XAudio2](https://msdn.microsoft.com/library/windows/desktop/ee415813)."},{"content":"In the game sample, the audio objects and behaviors are defined in three files:","pos":[650,729]},{"content":"<bpt id=\"p1\">**</bpt>Audio.h/.cpp<ept id=\"p1\">**</ept>.","pos":[735,752],"source":"**Audio.h/.cpp**."},{"content":"This code file defines the <bpt id=\"p1\">**</bpt>Audio<ept id=\"p1\">**</ept> object, which contains the XAudio2 resources for sound playback.","pos":[753,854],"source":" This code file defines the **Audio** object, which contains the XAudio2 resources for sound playback."},{"content":"It also defines the method for suspending and resuming audio playback if the game is paused or deactivated.","pos":[855,962]},{"content":"<bpt id=\"p1\">**</bpt>MediaReader.h/.cpp<ept id=\"p1\">**</ept>.","pos":[967,990],"source":"**MediaReader.h/.cpp**."},{"content":"This code defines the methods for reading audio .wav files from local storage.","pos":[991,1069]},{"content":"<bpt id=\"p1\">**</bpt>SoundEffect.h/.cpp<ept id=\"p1\">**</ept>.","pos":[1074,1097],"source":"**SoundEffect.h/.cpp**."},{"content":"This code defines an object for in-game sound playback.","pos":[1098,1153]},{"content":"Defining the audio engine","pos":[1158,1183]},{"content":"When the game sample starts, it creates an <bpt id=\"p1\">**</bpt>Audio<ept id=\"p1\">**</ept> object that allocates the audio resources for the game.","pos":[1186,1294],"source":"When the game sample starts, it creates an **Audio** object that allocates the audio resources for the game."},{"content":"The code that declares this object looks like this:","pos":[1295,1346]},{"content":"The <bpt id=\"p1\">**</bpt>Audio::MusicEngine<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Audio::SoundEffectEngine<ept id=\"p2\">**</ept> methods return references to <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>IXAudio2<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/desktop/ee415908)</ept> objects that define the mastering voice for each audio type.","pos":[1884,2109],"source":"The **Audio::MusicEngine** and **Audio::SoundEffectEngine** methods return references to [**IXAudio2**](https://msdn.microsoft.com/library/windows/desktop/ee415908) objects that define the mastering voice for each audio type."},{"content":"A mastering voice is the audio device used for playback.","pos":[2110,2166]},{"content":"Sound data buffers cannot be submitted directly to mastering voices, but data submitted to other types of voices must be directed to a mastering voice to be heard.","pos":[2167,2330]},{"content":"Initializing the audio resources","pos":[2335,2367]},{"content":"The sample initializes the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IXAudio2<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/ee415908)</ept> objects for the music and sound effect engines with calls to <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>XAudio2Create<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/desktop/ee419212)</ept>.","pos":[2370,2615],"source":"The sample initializes the [**IXAudio2**](https://msdn.microsoft.com/library/windows/desktop/ee415908) objects for the music and sound effect engines with calls to [**XAudio2Create**](https://msdn.microsoft.com/library/windows/desktop/ee419212)."},{"content":"After the engines have been instantiated, it creates a mastering voice for each with calls to <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IXAudio2::CreateMasteringVoice<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/hh405048)</ept>, as here:","pos":[2616,2817],"source":" After the engines have been instantiated, it creates a mastering voice for each with calls to [**IXAudio2::CreateMasteringVoice**](https://msdn.microsoft.com/library/windows/desktop/hh405048), as here:"},{"content":"As a music or sound effect audio file is loaded, this method calls <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IXAudio2::CreateSourceVoice<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/ee418607)</ept> on the mastering voice, which creates an instance of a source voice for playback.","pos":[3421,3664],"source":"As a music or sound effect audio file is loaded, this method calls [**IXAudio2::CreateSourceVoice**](https://msdn.microsoft.com/library/windows/desktop/ee418607) on the mastering voice, which creates an instance of a source voice for playback."},{"content":"We look at the code for this as soon as we finish reviewing how the game sample loads audio files.","pos":[3665,3763]},{"content":"Reading an audio file","pos":[3768,3789]},{"content":"In the game sample, the code for reading audio format files is defined in <bpt id=\"p1\">**</bpt>MediaReader.cpp<ept id=\"p1\">**</ept>.","pos":[3792,3886],"source":"In the game sample, the code for reading audio format files is defined in **MediaReader.cpp**."},{"content":"The specific method that reads in an encoded .wav audio file, <bpt id=\"p1\">**</bpt>MediaReader::LoadMedia<ept id=\"p1\">**</ept>, looks like this:","pos":[3887,3993],"source":" The specific method that reads in an encoded .wav audio file, **MediaReader::LoadMedia**, looks like this:"},{"pos":[7435,7612],"content":"This method uses the <bpt id=\"p1\">[</bpt>Media Foundation<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/ms694197)</ept> APIs to read in the .wav audio file as a Pulse Code Modulation (PCM) buffer.","source":"This method uses the [Media Foundation](https://msdn.microsoft.com/library/windows/desktop/ms694197) APIs to read in the .wav audio file as a Pulse Code Modulation (PCM) buffer."},{"pos":[7618,7846],"content":"Creates a media source reader (<bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IMFSourceReader<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/dd374655)</ept>) object by calling <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>MFCreateSourceReaderFromURL<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/desktop/dd388110)</ept>.","source":"Creates a media source reader ([**IMFSourceReader**](https://msdn.microsoft.com/library/windows/desktop/dd374655)) object by calling [**MFCreateSourceReaderFromURL**](https://msdn.microsoft.com/library/windows/desktop/dd388110)."},{"content":"Creates a media type (<bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IMFMediaType<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/ms704850)</ept>) for the decoding of the audio file by calling <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>MFCreateMediaType<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/desktop/ms693861)</ept>.","pos":[7851,8085],"source":"Creates a media type ([**IMFMediaType**](https://msdn.microsoft.com/library/windows/desktop/ms704850)) for the decoding of the audio file by calling [**MFCreateMediaType**](https://msdn.microsoft.com/library/windows/desktop/ms693861)."},{"content":"This method specifies that the decoded output is PCM audio, which is an audio type that XAudio2 can use.","pos":[8086,8190]},{"pos":[8195,8360],"content":"Sets the decoded output media type for the reader by calling <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IMFSourceReader::SetCurrentMediaType<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/bb970432)</ept>.","source":"Sets the decoded output media type for the reader by calling [**IMFSourceReader::SetCurrentMediaType**](https://msdn.microsoft.com/library/windows/desktop/bb970432)."},{"content":"Creates a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>WAVEFORMATEX<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/hardware/ff538799)</ept> buffer and copies the results of a call to <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>IMFMediaType::MFCreateWaveFormatExFromMFMediaType<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/desktop/ms702177)</ept> on the <bpt id=\"p5\">[</bpt><bpt id=\"p6\">**</bpt>IMFMediaType<ept id=\"p6\">**</ept><ept id=\"p5\">](https://msdn.microsoft.com/library/windows/desktop/ms704850)</ept> object.","pos":[8365,8710],"source":"Creates a [**WAVEFORMATEX**](https://msdn.microsoft.com/library/windows/hardware/ff538799) buffer and copies the results of a call to [**IMFMediaType::MFCreateWaveFormatExFromMFMediaType**](https://msdn.microsoft.com/library/windows/desktop/ms702177) on the [**IMFMediaType**](https://msdn.microsoft.com/library/windows/desktop/ms704850) object."},{"content":"This formats the buffer that holds the audio file after it is loaded.","pos":[8711,8780]},{"pos":[8785,8996],"content":"Gets the duration, in seconds, of the audio stream by calling <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IMFSourceReader::GetPresentationAttribute<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/dd374662)</ept> and then converts the duration to bytes.","source":"Gets the duration, in seconds, of the audio stream by calling [**IMFSourceReader::GetPresentationAttribute**](https://msdn.microsoft.com/library/windows/desktop/dd374662) and then converts the duration to bytes."},{"pos":[9001,9143],"content":"Reads the audio file in as a stream by calling <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IMFSourceReader::ReadSample<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/dd374665)</ept>.","source":"Reads the audio file in as a stream by calling [**IMFSourceReader::ReadSample**](https://msdn.microsoft.com/library/windows/desktop/dd374665)."},{"content":"Copies the contents of the audio sample buffer into an array returned by the method.","pos":[9148,9232]},{"content":"The most important thing in <bpt id=\"p1\">**</bpt>SoundEffect::Initialize<ept id=\"p1\">**</ept> is the creation of the source voice object, <bpt id=\"p2\">**</bpt>m\\_sourceVoice<ept id=\"p2\">**</ept>, from the mastering voice.","pos":[9234,9379],"source":"The most important thing in **SoundEffect::Initialize** is the creation of the source voice object, **m\\_sourceVoice**, from the mastering voice."},{"content":"We use the source voice for the actual play back of the sound data buffer obtained from <bpt id=\"p1\">**</bpt>MediaReader::LoadMedia<ept id=\"p1\">**</ept>.","pos":[9380,9495],"source":" We use the source voice for the actual play back of the sound data buffer obtained from **MediaReader::LoadMedia**."},{"pos":[9497,9589],"content":"The sample game calls this method when it initializes the <bpt id=\"p1\">**</bpt>SoundEffect<ept id=\"p1\">**</ept> object, like this:","source":"The sample game calls this method when it initializes the **SoundEffect** object, like this:"},{"pos":[10192,10414],"content":"This method is passed the results of calls to <bpt id=\"p1\">**</bpt>Audio::SoundEffectEngine<ept id=\"p1\">**</ept> (or <bpt id=\"p2\">**</bpt>Audio::MusicEngine<ept id=\"p2\">**</ept>), <bpt id=\"p3\">**</bpt>MediaReader::GetOutputWaveFormatEx<ept id=\"p3\">**</ept>, and the buffer returned by a call to <bpt id=\"p4\">**</bpt>MediaReader::LoadMedia<ept id=\"p4\">**</ept>, as seen here.","source":"This method is passed the results of calls to **Audio::SoundEffectEngine** (or **Audio::MusicEngine**), **MediaReader::GetOutputWaveFormatEx**, and the buffer returned by a call to **MediaReader::LoadMedia**, as seen here."},{"pos":[10765,10885],"content":"<bpt id=\"p1\">**</bpt>SoundEffect::Initialize<ept id=\"p1\">**</ept> is called from the <bpt id=\"p2\">**</bpt>Simple3DGame:Initialize<ept id=\"p2\">**</ept> method that initializes the main game object.","source":"**SoundEffect::Initialize** is called from the **Simple3DGame:Initialize** method that initializes the main game object."},{"content":"Now that the sample game has an audio file in memory, let's see how it plays it back during game play!","pos":[10887,10989]},{"content":"Playing back an audio file","pos":[10994,11020]},{"content":"To play the sound, this method uses the source voice object <bpt id=\"p1\">**</bpt>m\\_sourceVoice<ept id=\"p1\">**</ept> to start the playback of the sound data buffer <bpt id=\"p2\">**</bpt>m\\_soundData<ept id=\"p2\">**</ept>.","pos":[11842,11985],"source":"To play the sound, this method uses the source voice object **m\\_sourceVoice** to start the playback of the sound data buffer **m\\_soundData**."},{"content":"It creates an <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>XAUDIO2\\_BUFFER<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/ee419228)</ept>, to which it provides a reference to the sound data buffer, and then submits it with a call to <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>IXAudio2SourceVoice::SubmitSourceBuffer<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/desktop/ee418473)</ept>.","pos":[11986,12285],"source":" It creates an [**XAUDIO2\\_BUFFER**](https://msdn.microsoft.com/library/windows/desktop/ee419228), to which it provides a reference to the sound data buffer, and then submits it with a call to [**IXAudio2SourceVoice::SubmitSourceBuffer**](https://msdn.microsoft.com/library/windows/desktop/ee418473)."},{"content":"With the sound data queued up, <bpt id=\"p1\">**</bpt>SoundEffect::PlaySound<ept id=\"p1\">**</ept> starts play back by calling <bpt id=\"p2\">[</bpt><bpt id=\"p3\">**</bpt>IXAudio2SourceVoice::Start<ept id=\"p3\">**</ept><ept id=\"p2\">](https://msdn.microsoft.com/library/windows/desktop/ee418471)</ept>.","pos":[12286,12466],"source":" With the sound data queued up, **SoundEffect::PlaySound** starts play back by calling [**IXAudio2SourceVoice::Start**](https://msdn.microsoft.com/library/windows/desktop/ee418471)."},{"pos":[12468,12592],"content":"Now, whenever a collision between the ammo and a target occurs, a call to <bpt id=\"p1\">**</bpt>SoundEffect::PlaySound<ept id=\"p1\">**</ept> causes a noise to play.","source":"Now, whenever a collision between the ammo and a target occurs, a call to **SoundEffect::PlaySound** causes a noise to play."},{"content":"Next steps","pos":[12597,12607]},{"content":"That was a whirlwind tour of Universal Windows Platform (UWP) DirectX game development!","pos":[12610,12697]},{"content":"At this point, you have an idea of what you need to do to make your own game for Windows 8 a great experience.","pos":[12698,12808]},{"content":"Remember, your game can be played on a wide variety of Windows 8 devices and platforms, so design your components: your graphics, your controls, your user interface, and your audio for as wide a set of configurations as you can!","pos":[12809,13037]},{"pos":[13039,13174],"content":"For more info about ways to modify the game sample provided in these documents, see <bpt id=\"p1\">[</bpt>Extending the game sample<ept id=\"p1\">](tutorial-resources.md)</ept>.","source":"For more info about ways to modify the game sample provided in these documents, see [Extending the game sample](tutorial-resources.md)."},{"content":"Complete sample code for this section","pos":[13179,13216]},{"content":"Audio.h","pos":[13219,13226]},{"content":"Audio.cpp","pos":[14101,14110]},{"content":"SoundEffect.h","pos":[16154,16167]},{"content":"SoundEffect.cpp","pos":[16918,16933]}],"content":"---\ntitle: Add sound\ndescription: In this step, we examine how the shooting game sample creates an object for sound playback using the XAudio2 APIs.\nms.assetid: aa05efe2-2baa-8b9f-7418-23f5b6cd2266\n---\n\n# Add sound\n\n\n\\[ Updated for UWP apps on Windows 10. For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]\n\nIn this step, we examine how the shooting game sample creates an object for sound playback using the [XAudio2](https://msdn.microsoft.com/library/windows/desktop/ee415813) APIs.\n\n## Objective\n\n\n-   To add sound output using [XAudio2](https://msdn.microsoft.com/library/windows/desktop/ee415813).\n\nIn the game sample, the audio objects and behaviors are defined in three files:\n\n-   **Audio.h/.cpp**. This code file defines the **Audio** object, which contains the XAudio2 resources for sound playback. It also defines the method for suspending and resuming audio playback if the game is paused or deactivated.\n-   **MediaReader.h/.cpp**. This code defines the methods for reading audio .wav files from local storage.\n-   **SoundEffect.h/.cpp**. This code defines an object for in-game sound playback.\n\n## Defining the audio engine\n\n\nWhen the game sample starts, it creates an **Audio** object that allocates the audio resources for the game. The code that declares this object looks like this:\n\n```cpp\npublic:\n    Audio();\n\n    void Initialize();\n    void CreateDeviceIndependentResources();\n    IXAudio2* MusicEngine();\n    IXAudio2* SoundEffectEngine();\n    void SuspendAudio();\n    void ResumeAudio();\n\nprotected:\n    bool                                m_audioAvailable;\n    Microsoft::WRL::ComPtr<IXAudio2>    m_musicEngine;\n    Microsoft::WRL::ComPtr<IXAudio2>    m_soundEffectEngine;\n    IXAudio2MasteringVoice*             m_musicMasteringVoice;\n    IXAudio2MasteringVoice*             m_soundEffectMasteringVoice;\n};\n```\n\nThe **Audio::MusicEngine** and **Audio::SoundEffectEngine** methods return references to [**IXAudio2**](https://msdn.microsoft.com/library/windows/desktop/ee415908) objects that define the mastering voice for each audio type. A mastering voice is the audio device used for playback. Sound data buffers cannot be submitted directly to mastering voices, but data submitted to other types of voices must be directed to a mastering voice to be heard.\n\n## Initializing the audio resources\n\n\nThe sample initializes the [**IXAudio2**](https://msdn.microsoft.com/library/windows/desktop/ee415908) objects for the music and sound effect engines with calls to [**XAudio2Create**](https://msdn.microsoft.com/library/windows/desktop/ee419212). After the engines have been instantiated, it creates a mastering voice for each with calls to [**IXAudio2::CreateMasteringVoice**](https://msdn.microsoft.com/library/windows/desktop/hh405048), as here:\n\n```cpp\n\nvoid Audio::CreateDeviceIndependentResources()\n{\n    UINT32 flags = 0;\n\n    DX::ThrowIfFailed(\n        XAudio2Create(&m_musicEngine, flags)\n        );\n\n    HRESULT hr = m_musicEngine->CreateMasteringVoice(&m_musicMasteringVoice);\n    if (FAILED(hr))\n    {\n        // Unable to create an audio device\n        m_audioAvailable = false;\n        return;\n    }\n\n    DX::ThrowIfFailed(\n        XAudio2Create(&m_soundEffectEngine, flags)\n        );\n\n    DX::ThrowIfFailed(\n        m_soundEffectEngine->CreateMasteringVoice(&m_soundEffectMasteringVoice)\n        );\n\n    m_audioAvailable = true;\n}\n```\n\nAs a music or sound effect audio file is loaded, this method calls [**IXAudio2::CreateSourceVoice**](https://msdn.microsoft.com/library/windows/desktop/ee418607) on the mastering voice, which creates an instance of a source voice for playback. We look at the code for this as soon as we finish reviewing how the game sample loads audio files.\n\n## Reading an audio file\n\n\nIn the game sample, the code for reading audio format files is defined in **MediaReader.cpp**. The specific method that reads in an encoded .wav audio file, **MediaReader::LoadMedia**, looks like this:\n\n```cpp\nPlatform::Array<byte>^  MediaReader::LoadMedia(_In_ Platform::String^ filename)\n{\n    DX::ThrowIfFailed(\n        MFStartup(MF_VERSION)\n        );\n\n    ComPtr<IMFSourceReader> reader;\n    DX::ThrowIfFailed(\n        MFCreateSourceReaderFromURL(\n            Platform::String::Concat(m_installedLocationPath, filename)->Data(),\n            nullptr,\n            &reader\n            )\n        );\n\n    // Set the decoded output format as PCM\n    // XAudio2 on Windows can process PCM and ADPCM-encoded buffers.\n    // When using MediaFoundation, this sample always decodes into PCM.\n    Microsoft::WRL::ComPtr<IMFMediaType> mediaType;\n    DX::ThrowIfFailed(\n        MFCreateMediaType(&mediaType)\n        );\n\n    DX::ThrowIfFailed(\n        mediaType->SetGUID(MF_MT_MAJOR_TYPE, MFMediaType_Audio)\n        );\n\n    DX::ThrowIfFailed(\n        mediaType->SetGUID(MF_MT_SUBTYPE, MFAudioFormat_PCM)\n        );\n\n    DX::ThrowIfFailed(\n        reader->SetCurrentMediaType(MF_SOURCE_READER_FIRST_AUDIO_STREAM, 0, mediaType.Get())\n        );\n\n    // Get the complete WAVEFORMAT from the Media Type.\n    Microsoft::WRL::ComPtr<IMFMediaType> outputMediaType;\n    DX::ThrowIfFailed(\n        reader->GetCurrentMediaType(MF_SOURCE_READER_FIRST_AUDIO_STREAM, &outputMediaType)\n        );\n\n    UINT32 size = 0;\n    WAVEFORMATEX* waveFormat;\n    DX::ThrowIfFailed(\n        MFCreateWaveFormatExFromMFMediaType(outputMediaType.Get(), &waveFormat, &size)\n        );\n\n    CopyMemory(&m_waveFormat, waveFormat, sizeof(m_waveFormat));\n    CoTaskMemFree(waveFormat);\n\n    // Get the total length of the stream in bytes.\n    PROPVARIANT propVariant;\n    DX::ThrowIfFailed(\n        reader->GetPresentationAttribute(MF_SOURCE_READER_MEDIASOURCE, MF_PD_DURATION, &propVariant)\n        );\n    LONGLONG duration = propVariant.uhVal.QuadPart;\n    unsigned int maxStreamLengthInBytes;\n\n    double durationInSeconds = (duration / static_cast<double>(10000 * 1000));\n    maxStreamLengthInBytes = static_cast<unsigned int>(durationInSeconds * m_waveFormat.nAvgBytesPerSec);\n\n    // Make the length a multiple of 4 bytes.\n    maxStreamLengthInBytes = (maxStreamLengthInBytes + 3) / 4 * 4;\n\n    Platform::Array<byte>^ fileData = ref new Platform::Array<byte>(maxStreamLengthInBytes);\n\n    ComPtr<IMFSample> sample;\n    ComPtr<IMFMediaBuffer> mediaBuffer;\n    DWORD flags = 0;\n\n    int positionInData = 0;\n    bool done = false;\n    while (!done)\n    {\n        DX::ThrowIfFailed(\n            reader->ReadSample(MF_SOURCE_READER_FIRST_AUDIO_STREAM, 0, nullptr, &flags, nullptr, &sample)\n            );\n\n        if (sample != nullptr)\n        {\n            DX::ThrowIfFailed(\n                sample->ConvertToContiguousBuffer(&mediaBuffer)\n                );\n\n            BYTE *audioData = nullptr;\n            DWORD sampleBufferLength = 0;\n            DX::ThrowIfFailed(\n                mediaBuffer->Lock(&audioData, nullptr, &sampleBufferLength)\n                );\n\n            for (DWORD i = 0; i < sampleBufferLength; i++)\n            {\n                fileData[positionInData++] = audioData[i];\n            }\n        }\n        if (flags & MF_SOURCE_READERF_ENDOFSTREAM)\n        {\n            done = true;\n        }\n    }\n\n    // Fix up the array size on match the actual length.\n    Platform::Array<byte>^ realfileData = ref new Platform::Array<byte>((positionInData + 3) / 4 * 4);\n    memcpy(realfileData->Data, fileData->Data, positionInData);\n    return realfileData;\n}\n```\n\nThis method uses the [Media Foundation](https://msdn.microsoft.com/library/windows/desktop/ms694197) APIs to read in the .wav audio file as a Pulse Code Modulation (PCM) buffer.\n\n1.  Creates a media source reader ([**IMFSourceReader**](https://msdn.microsoft.com/library/windows/desktop/dd374655)) object by calling [**MFCreateSourceReaderFromURL**](https://msdn.microsoft.com/library/windows/desktop/dd388110).\n2.  Creates a media type ([**IMFMediaType**](https://msdn.microsoft.com/library/windows/desktop/ms704850)) for the decoding of the audio file by calling [**MFCreateMediaType**](https://msdn.microsoft.com/library/windows/desktop/ms693861). This method specifies that the decoded output is PCM audio, which is an audio type that XAudio2 can use.\n3.  Sets the decoded output media type for the reader by calling [**IMFSourceReader::SetCurrentMediaType**](https://msdn.microsoft.com/library/windows/desktop/bb970432).\n4.  Creates a [**WAVEFORMATEX**](https://msdn.microsoft.com/library/windows/hardware/ff538799) buffer and copies the results of a call to [**IMFMediaType::MFCreateWaveFormatExFromMFMediaType**](https://msdn.microsoft.com/library/windows/desktop/ms702177) on the [**IMFMediaType**](https://msdn.microsoft.com/library/windows/desktop/ms704850) object. This formats the buffer that holds the audio file after it is loaded.\n5.  Gets the duration, in seconds, of the audio stream by calling [**IMFSourceReader::GetPresentationAttribute**](https://msdn.microsoft.com/library/windows/desktop/dd374662) and then converts the duration to bytes.\n6.  Reads the audio file in as a stream by calling [**IMFSourceReader::ReadSample**](https://msdn.microsoft.com/library/windows/desktop/dd374665).\n7.  Copies the contents of the audio sample buffer into an array returned by the method.\n\nThe most important thing in **SoundEffect::Initialize** is the creation of the source voice object, **m\\_sourceVoice**, from the mastering voice. We use the source voice for the actual play back of the sound data buffer obtained from **MediaReader::LoadMedia**.\n\nThe sample game calls this method when it initializes the **SoundEffect** object, like this:\n\n```cpp\nvoid SoundEffect::Initialize(\n    _In_ IXAudio2 *masteringEngine,\n    _In_ WAVEFORMATEX *sourceFormat,\n    _In_ Platform::Array<byte>^ soundData)\n{\n    m_soundData = soundData;\n\n    if (masteringEngine == nullptr)\n    {\n        // Audio is not available, so return.\n        m_audioAvailable = false;\n        return;\n    }\n\n    // Create and reuse a single source voice for the single sound effect in this sample.\n    DX::ThrowIfFailed(\n        masteringEngine->CreateSourceVoice(\n            &m_sourceVoice,\n            sourceFormat\n            )\n        );\n    m_audioAvailable = true;\n}\n```\n\nThis method is passed the results of calls to **Audio::SoundEffectEngine** (or **Audio::MusicEngine**), **MediaReader::GetOutputWaveFormatEx**, and the buffer returned by a call to **MediaReader::LoadMedia**, as seen here.\n\n```cpp\nMediaReader^ mediaReader = ref new MediaReader;\nauto targetHitSound = mediaReader->LoadMedia(\"hit.wav\");\n```\n\n```cpp\nmyTarget->HitSound(ref new SoundEffect());\nmyTarget->HitSound()->Initialize(\n                m_audioController->SoundEffectEngine(),\n                mediaReader->GetOutputWaveFormatEx(),\n                targetHitSound);\n```\n\n**SoundEffect::Initialize** is called from the **Simple3DGame:Initialize** method that initializes the main game object.\n\nNow that the sample game has an audio file in memory, let's see how it plays it back during game play!\n\n## Playing back an audio file\n\n\n```cpp\nvoid SoundEffect::PlaySound(_In_ float volume)\n{\n    XAUDIO2_BUFFER buffer = {0};\n    XAUDIO2_VOICE_STATE state = {0};\n\n    if (!m_audioAvailable)\n    {\n        // Audio is not available, so just return.\n        return;\n    }\n\n    // Interrupt sound effect if currently playing.\n    DX::ThrowIfFailed(\n        m_sourceVoice->Stop()\n        );\n    DX::ThrowIfFailed(\n        m_sourceVoice->FlushSourceBuffers()\n        );\n\n    // Queue in-memory buffer for playback and start the voice.\n    buffer.AudioBytes = m_soundData->Length;\n    buffer.pAudioData = m_soundData->Data;\n    buffer.Flags = XAUDIO2_END_OF_STREAM;\n\n    m_sourceVoice->SetVolume(volume);\n    DX::ThrowIfFailed(\n        m_sourceVoice->SubmitSourceBuffer(&buffer)\n        );\n    DX::ThrowIfFailed(\n        m_sourceVoice->Start()\n        );\n}\n```\n\nTo play the sound, this method uses the source voice object **m\\_sourceVoice** to start the playback of the sound data buffer **m\\_soundData**. It creates an [**XAUDIO2\\_BUFFER**](https://msdn.microsoft.com/library/windows/desktop/ee419228), to which it provides a reference to the sound data buffer, and then submits it with a call to [**IXAudio2SourceVoice::SubmitSourceBuffer**](https://msdn.microsoft.com/library/windows/desktop/ee418473). With the sound data queued up, **SoundEffect::PlaySound** starts play back by calling [**IXAudio2SourceVoice::Start**](https://msdn.microsoft.com/library/windows/desktop/ee418471).\n\nNow, whenever a collision between the ammo and a target occurs, a call to **SoundEffect::PlaySound** causes a noise to play.\n\n## Next steps\n\n\nThat was a whirlwind tour of Universal Windows Platform (UWP) DirectX game development! At this point, you have an idea of what you need to do to make your own game for Windows 8 a great experience. Remember, your game can be played on a wide variety of Windows 8 devices and platforms, so design your components: your graphics, your controls, your user interface, and your audio for as wide a set of configurations as you can!\n\nFor more info about ways to modify the game sample provided in these documents, see [Extending the game sample](tutorial-resources.md).\n\n## Complete sample code for this section\n\n\nAudio.h\n\n```cpp\n//// THIS CODE AND INFORMATION IS PROVIDED \"AS IS\" WITHOUT WARRANTY OF\n//// ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO\n//// THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A\n//// PARTICULAR PURPOSE.\n////\n//// Copyright (c) Microsoft Corporation. All rights reserved\n\n#pragma once\n\nref class Audio\n{\npublic:\n    Audio();\n\n    void Initialize();\n    void CreateDeviceIndependentResources();\n    IXAudio2* MusicEngine();\n    IXAudio2* SoundEffectEngine();\n    void SuspendAudio();\n    void ResumeAudio();\n\nprotected:\n    bool                                m_audioAvailable;\n    Microsoft::WRL::ComPtr<IXAudio2>    m_musicEngine;\n    Microsoft::WRL::ComPtr<IXAudio2>    m_soundEffectEngine;\n    IXAudio2MasteringVoice*             m_musicMasteringVoice;\n    IXAudio2MasteringVoice*             m_soundEffectMasteringVoice;\n};\n```\n\nAudio.cpp\n\n```cpp\n//// THIS CODE AND INFORMATION IS PROVIDED \"AS IS\" WITHOUT WARRANTY OF\n//// ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO\n//// THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A\n//// PARTICULAR PURPOSE.\n////\n//// Copyright (c) Microsoft Corporation. All rights reserved\n\n#include \"pch.h\"\n#include \"Audio.h\"\n#include \"DirectXSample.h\"\n\nusing namespace Microsoft::WRL;\nusing namespace Windows::Foundation;\nusing namespace Windows::UI::Core;\nusing namespace Windows::Graphics::Display;\n\nAudio::Audio():\n    m_audioAvailable(false)\n{\n}\n\nvoid Audio::Initialize()\n{\n}\n\nvoid Audio::CreateDeviceIndependentResources()\n{\n    UINT32 flags = 0;\n\n    DX::ThrowIfFailed(\n        XAudio2Create(&m_musicEngine, flags)\n        );\n\n#if defined(_DEBUG)\n    XAUDIO2_DEBUG_CONFIGURATION debugConfiguration = {0};\n    debugConfiguration.BreakMask = XAUDIO2_LOG_ERRORS;\n    debugConfiguration.TraceMask = XAUDIO2_LOG_ERRORS;\n    m_musicEngine->SetDebugConfiguration(&debugConfiguration);\n#endif\n\n\n    HRESULT hr = m_musicEngine->CreateMasteringVoice(&m_musicMasteringVoice);\n    if (FAILED(hr))\n    {\n        // Unable to create an audio device\n        m_audioAvailable = false;\n        return;\n    }\n\n    DX::ThrowIfFailed(\n        XAudio2Create(&m_soundEffectEngine, flags)\n        );\n\n#if defined(_DEBUG)\n    m_soundEffectEngine->SetDebugConfiguration(&debugConfiguration);\n#endif\n\n    DX::ThrowIfFailed(\n        m_soundEffectEngine->CreateMasteringVoice(&m_soundEffectMasteringVoice)\n        );\n\n    m_audioAvailable = true;\n}\n\nIXAudio2* Audio::MusicEngine()\n{\n    return m_musicEngine.Get();\n}\n\nIXAudio2* Audio::SoundEffectEngine()\n{\n    return m_soundEffectEngine.Get();\n}\n\nvoid Audio::SuspendAudio()\n{\n    if (m_audioAvailable)\n    {\n        m_musicEngine->StopEngine();\n        m_soundEffectEngine->StopEngine();\n    }\n}\n\nvoid Audio::ResumeAudio()\n{\n    if (m_audioAvailable)\n    {\n        DX::ThrowIfFailed(m_musicEngine->StartEngine());\n        DX::ThrowIfFailed(m_soundEffectEngine->StartEngine());\n    }\n}\n```\n\nSoundEffect.h\n\n```cpp\n//// THIS CODE AND INFORMATION IS PROVIDED \"AS IS\" WITHOUT WARRANTY OF\n//// ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO\n//// THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A\n//// PARTICULAR PURPOSE.\n////\n//// Copyright (c) Microsoft Corporation. All rights reserved\n\n#pragma once\n\nref class SoundEffect\n{\npublic:\n    SoundEffect();\n\n    void Initialize(\n        _In_ IXAudio2*              masteringEngine,\n        _In_ WAVEFORMATEX*          sourceFormat,\n        _In_ Platform::Array<byte>^ soundData\n        );\n\n    void PlaySound(_In_ float volume);\n\nprotected:\n    bool                    m_audioAvailable;\n    IXAudio2SourceVoice*    m_sourceVoice;\n    Platform::Array<byte>^  m_soundData;\n};\n```\n\nSoundEffect.cpp\n\n```cpp\n//// THIS CODE AND INFORMATION IS PROVIDED \"AS IS\" WITHOUT WARRANTY OF\n//// ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO\n//// THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A\n//// PARTICULAR PURPOSE.\n////\n//// Copyright (c) Microsoft Corporation. All rights reserved\n\n#include \"pch.h\"\n#include \"SoundEffect.h\"\n#include \"DirectXSample.h\"\n\nSoundEffect::SoundEffect():\n    m_audioAvailable(false)\n{\n}\n//----------------------------------------------------------------------\nvoid SoundEffect::Initialize(\n    _In_ IXAudio2 *masteringEngine,\n    _In_ WAVEFORMATEX *sourceFormat,\n    _In_ Platform::Array<byte>^ soundData)\n{\n    m_soundData = soundData;\n\n    if (masteringEngine == nullptr)\n    {\n        // Audio is not available, so return.\n        m_audioAvailable = false;\n        return;\n    }\n\n    // Create and reuse a single source voice for the single sound effect in this sample.\n    DX::ThrowIfFailed(\n        masteringEngine->CreateSourceVoice(\n            &m_sourceVoice,\n            sourceFormat\n            )\n        );\n    m_audioAvailable = true;\n}\n//----------------------------------------------------------------------\nvoid SoundEffect::PlaySound(_In_ float volume)\n{\n    XAUDIO2_BUFFER buffer = {0};\n    XAUDIO2_VOICE_STATE state = {0};\n\n    if (!m_audioAvailable)\n    {\n        // Audio is not available, so just return.\n        return;\n    }\n\n    // Interrupt sound effect if currently playing.\n    DX::ThrowIfFailed(\n        m_sourceVoice->Stop()\n        );\n    DX::ThrowIfFailed(\n        m_sourceVoice->FlushSourceBuffers()\n        );\n\n    // Queue in-memory buffer for playback and start the voice.\n    buffer.AudioBytes = m_soundData->Length;\n    buffer.pAudioData = m_soundData->Data;\n    buffer.Flags = XAUDIO2_END_OF_STREAM;\n\n    m_sourceVoice->SetVolume(volume);\n    DX::ThrowIfFailed(\n        m_sourceVoice->SubmitSourceBuffer(&buffer)\n        );\n    DX::ThrowIfFailed(\n        m_sourceVoice->Start()\n        );\n}\n```\n\n \n\n \n\n\n\n\n"}