{"nodes":[{"pos":[86,247],"content":"This article describes how to add adaptive streaming of multimedia content with Microsoft PlayReady content protection to a Universal Windows Platform (UWP) app.","needQuote":true,"needEscape":true,"nodes":[{"content":"This article describes how to add adaptive streaming of multimedia content with Microsoft PlayReady content protection to a Universal Windows Platform (UWP) app.","pos":[0,161]}]},{"pos":[255,288],"content":"Adaptive Streaming with PlayReady","needQuote":true,"needEscape":true,"nodes":[{"content":"Adaptive Streaming with PlayReady","pos":[0,33]}]},{"content":"Adaptive Streaming with PlayReady","pos":[296,329]},{"content":"\\[ Updated for UWP apps on Windows 10.","pos":[331,369]},{"content":"For Windows 8.x articles, see the <bpt id=\"p1\">[</bpt>archive<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=619132)</ept> \\]","pos":[370,465],"source":" For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]"},{"content":"This article describes how to add adaptive streaming of multimedia content with Microsoft PlayReady content protection to a Universal Windows Platform (UWP) app.","pos":[467,628]},{"content":"This feature currently supports playback of Dynamic Streaming over HTTP (DASH) content.","pos":[631,718]},{"content":"HLS (Apple's HTTP Live Streaming) is not supported with PlayReady.","pos":[720,786]},{"content":"Smooth Streaming is also currently not supported natively; however, PlayReady is extensible and by using additional code or libraries, PlayReady-protected Smooth Streaming can be supported, leveraging software or even hardware DRM (digital rights management).","pos":[788,1047]},{"content":"This article only deals with the aspects of adaptive streaming specific to PlayReady.","pos":[1049,1134]},{"content":"For information about implementing adaptive streaming in general, see <bpt id=\"p1\">[</bpt>Adaptive Streaming<ept id=\"p1\">](adaptive-streaming.md)</ept>.","pos":[1135,1249],"source":" For information about implementing adaptive streaming in general, see [Adaptive Streaming](adaptive-streaming.md)."},{"content":"This article uses code from the <bpt id=\"p1\">[</bpt>Adaptive streaming sample<ept id=\"p1\">](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/AdaptiveStreaming)</ept> in Microsoft's <bpt id=\"p2\">**</bpt>Windows-universal-samples<ept id=\"p2\">**</ept> repository on GitHub.","pos":[1251,1471],"source":"This article uses code from the [Adaptive streaming sample](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/AdaptiveStreaming) in Microsoft's **Windows-universal-samples** repository on GitHub."},{"content":"Scenario 4 deals with using adaptive streaming with PlayReady.","pos":[1472,1534]},{"content":"You can download the repo in a ZIP file by navigating to the root level of the repository and clicking the <bpt id=\"p1\">**</bpt>Download ZIP<ept id=\"p1\">**</ept> button.","pos":[1535,1666],"source":" You can download the repo in a ZIP file by navigating to the root level of the repository and clicking the **Download ZIP** button."},{"content":"You will need the following using statements:","pos":[1668,1713]},{"pos":[2072,2194],"content":"The <bpt id=\"p1\">**</bpt>LicenseRequest<ept id=\"p1\">**</ept> namespace is from <bpt id=\"p2\">**</bpt>CommonLicenseRequest.cs<ept id=\"p2\">**</ept>, a PlayReady file provided by Microsoft to licensees.","source":"The **LicenseRequest** namespace is from **CommonLicenseRequest.cs**, a PlayReady file provided by Microsoft to licensees."},{"content":"You will need to declare a few global variables:","pos":[2196,2244]},{"content":"You will also want to declare the following constant:","pos":[2449,2502]},{"content":"Setting up the MediaProtectionManager","pos":[2595,2632]},{"content":"To add PlayReady content protection to your UWP app, you will need to set up a <bpt id=\"p1\">[</bpt>MediaProtectionManager<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br207040)</ept> object.","pos":[2634,2803],"source":"To add PlayReady content protection to your UWP app, you will need to set up a [MediaProtectionManager](https://msdn.microsoft.com/library/windows/apps/br207040) object."},{"content":"You do this when initializing your <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>AdaptiveMediaSource<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn946912)</ept> object.","pos":[2804,2930],"source":" You do this when initializing your [**AdaptiveMediaSource**](https://msdn.microsoft.com/library/windows/apps/dn946912) object."},{"pos":[2932,3044],"content":"The following code sets up a <bpt id=\"p1\">[</bpt>MediaProtectionManager<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br207040)</ept>:","source":"The following code sets up a [MediaProtectionManager](https://msdn.microsoft.com/library/windows/apps/br207040):"},{"content":"This code can simply be copied to your app, since it is mandatory for setting up content protection.","pos":[4105,4205]},{"content":"The <bpt id=\"p1\">[</bpt>ComponentLoadFailed<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br207041)</ept> event is fired when the load of binary data fails.","pos":[4207,4341],"source":"The [ComponentLoadFailed](https://msdn.microsoft.com/library/windows/apps/br207041) event is fired when the load of binary data fails."},{"content":"We need to add an event handler to handle this, signaling that the load did not complete:","pos":[4342,4431]},{"content":"Similarly, we need to add an event handler for the <bpt id=\"p1\">[</bpt>ServiceRequested<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br207045)</ept> event, which fires when a service is requested.","pos":[4610,4785],"source":"Similarly, we need to add an event handler for the [ServiceRequested](https://msdn.microsoft.com/library/windows/apps/br207045) event, which fires when a service is requested."},{"content":"This code checks what kind of request it is, and responds appropriately:","pos":[4786,4858]},{"content":"Individualization service requests","pos":[5684,5718]},{"content":"The following code reactively makes a PlayReady individualization service request.","pos":[5720,5802]},{"content":"We pass in the request as a parameter to the function.","pos":[5803,5857]},{"content":"We surround the call in a try/catch block, and if there are no exceptions, we say the request completed successfully:","pos":[5858,5975]},{"pos":[6824,7042],"content":"Alternatively, we may want to proactively make an individualization service request, in which case we call the function below in place of the code calling <ph id=\"ph1\">`ReactiveIndivRequest`</ph> in <ph id=\"ph2\">`ProtectionManager_ServiceRequested`</ph>:","source":"Alternatively, we may want to proactively make an individualization service request, in which case we call the function below in place of the code calling `ReactiveIndivRequest` in `ProtectionManager_ServiceRequested`:"},{"content":"License acquisition service requests","pos":[7281,7317]},{"content":"If instead the request was a <bpt id=\"p1\">[</bpt>PlayReadyLicenseAcquisitionServiceRequest<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn986285)</ept>, we call the below function to request and acquire the PlayReady license.","pos":[7319,7523],"source":"If instead the request was a [PlayReadyLicenseAcquisitionServiceRequest](https://msdn.microsoft.com/library/windows/apps/dn986285), we call the below function to request and acquire the PlayReady license."},{"content":"We tell the MediaProtectionServiceCompletion object that we passed in whether the request was successful or not, and we complete the request:","pos":[7524,7665]},{"content":"Initializing the AdaptiveMediaSource","pos":[10207,10243]},{"content":"Finally, you will need a function to initialize the <bpt id=\"p1\">[</bpt>AdaptiveMediaSource<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn946912)</ept>, created from a given <bpt id=\"p2\">[</bpt>Uri<ept id=\"p2\">](https://msdn.microsoft.com/library/windows/apps/xaml/system.uri.aspx)</ept> and <bpt id=\"p3\">[</bpt>MediaElement<ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/br242926)</ept>.","pos":[10245,10552],"source":"Finally, you will need a function to initialize the [AdaptiveMediaSource](https://msdn.microsoft.com/library/windows/apps/dn946912), created from a given [Uri](https://msdn.microsoft.com/library/windows/apps/xaml/system.uri.aspx) and [MediaElement](https://msdn.microsoft.com/library/windows/apps/br242926)."},{"content":"The <bpt id=\"p1\">**</bpt>Uri<ept id=\"p1\">**</ept> should be the link to the media file (HLS or DASH); the <bpt id=\"p2\">**</bpt>MediaElement<ept id=\"p2\">**</ept> should be defined in your XAML.","pos":[10553,10669],"source":" The **Uri** should be the link to the media file (HLS or DASH); the **MediaElement** should be defined in your XAML."},{"content":"You can call this function in whichever event handles the start of adaptive streaming—for instance, in a button click event.","pos":[11106,11230]}],"content":"---\nauthor: eliotcowley\nms.assetid: BF877F23-1238-4586-9C16-246F3F25AE35\ndescription: This article describes how to add adaptive streaming of multimedia content with Microsoft PlayReady content protection to a Universal Windows Platform (UWP) app.\ntitle: Adaptive Streaming with PlayReady\n---\n\n# Adaptive Streaming with PlayReady\n\n\\[ Updated for UWP apps on Windows 10. For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]\n\nThis article describes how to add adaptive streaming of multimedia content with Microsoft PlayReady content protection to a Universal Windows Platform (UWP) app. \n\nThis feature currently supports playback of Dynamic Streaming over HTTP (DASH) content.\n\nHLS (Apple's HTTP Live Streaming) is not supported with PlayReady.\n\nSmooth Streaming is also currently not supported natively; however, PlayReady is extensible and by using additional code or libraries, PlayReady-protected Smooth Streaming can be supported, leveraging software or even hardware DRM (digital rights management).\n\nThis article only deals with the aspects of adaptive streaming specific to PlayReady. For information about implementing adaptive streaming in general, see [Adaptive Streaming](adaptive-streaming.md).\n\nThis article uses code from the [Adaptive streaming sample](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/AdaptiveStreaming) in Microsoft's **Windows-universal-samples** repository on GitHub. Scenario 4 deals with using adaptive streaming with PlayReady. You can download the repo in a ZIP file by navigating to the root level of the repository and clicking the **Download ZIP** button.\n\nYou will need the following using statements:\n\n```csharp\nusing LicenseRequest;\nusing System;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Runtime.InteropServices;\nusing System.Threading.Tasks;\nusing Windows.Foundation.Collections;\nusing Windows.Media.Protection;\nusing Windows.Media.Protection.PlayReady;\nusing Windows.Media.Streaming.Adaptive;\nusing Windows.UI.Xaml.Controls;\n```\n\nThe **LicenseRequest** namespace is from **CommonLicenseRequest.cs**, a PlayReady file provided by Microsoft to licensees.\n\nYou will need to declare a few global variables:\n\n```csharp\nprivate AdaptiveMediaSource ams = null;\nprivate MediaProtectionManager protectionManager = null;\nprivate string playReadyLicenseUrl = \"\";\nprivate string playReadyChallengeCustomData = \"\";\n```\n\nYou will also want to declare the following constant:\n\n```csharp\nprivate const uint MSPR_E_CONTENT_ENABLING_ACTION_REQUIRED = 0x8004B895;\n```\n\n## Setting up the MediaProtectionManager\n\nTo add PlayReady content protection to your UWP app, you will need to set up a [MediaProtectionManager](https://msdn.microsoft.com/library/windows/apps/br207040) object. You do this when initializing your [**AdaptiveMediaSource**](https://msdn.microsoft.com/library/windows/apps/dn946912) object.\n\nThe following code sets up a [MediaProtectionManager](https://msdn.microsoft.com/library/windows/apps/br207040):\n\n```csharp\nprivate void SetUpProtectionManager(ref MediaElement mediaElement)\n{\n    protectionManager = new MediaProtectionManager();\n\n    protectionManager.ComponentLoadFailed += \n        new ComponentLoadFailedEventHandler(ProtectionManager_ComponentLoadFailed);\n\n    protectionManager.ServiceRequested += \n        new ServiceRequestedEventHandler(ProtectionManager_ServiceRequested);\n\n    PropertySet cpSystems = new PropertySet();\n\n    cpSystems.Add(\n        \"{F4637010-03C3-42CD-B932-B48ADF3A6A54}\", \n        \"Windows.Media.Protection.PlayReady.PlayReadyWinRTTrustedInput\");\n\n    protectionManager.Properties.Add(\"Windows.Media.Protection.MediaProtectionSystemIdMapping\", cpSystems);\n\n    protectionManager.Properties.Add(\n        \"Windows.Media.Protection.MediaProtectionSystemId\", \n        \"{F4637010-03C3-42CD-B932-B48ADF3A6A54}\");\n\n    protectionManager.Properties.Add(\n        \"Windows.Media.Protection.MediaProtectionContainerGuid\", \n        \"{9A04F079-9840-4286-AB92-E65BE0885F95}\");\n\n    mediaElement.ProtectionManager = protectionManager;\n}\n```\n\nThis code can simply be copied to your app, since it is mandatory for setting up content protection.\n\nThe [ComponentLoadFailed](https://msdn.microsoft.com/library/windows/apps/br207041) event is fired when the load of binary data fails. We need to add an event handler to handle this, signaling that the load did not complete:\n\n```csharp\nprivate void ProtectionManager_ComponentLoadFailed(\n    MediaProtectionManager sender, \n    ComponentLoadFailedEventArgs e)\n{\n    e.Completion.Complete(false);\n}\n```\n\nSimilarly, we need to add an event handler for the [ServiceRequested](https://msdn.microsoft.com/library/windows/apps/br207045) event, which fires when a service is requested. This code checks what kind of request it is, and responds appropriately:\n\n```csharp\nprivate async void ProtectionManager_ServiceRequested(\n    MediaProtectionManager sender, \n    ServiceRequestedEventArgs e)\n{\n    if (e.Request is PlayReadyIndividualizationServiceRequest)\n    {\n        PlayReadyIndividualizationServiceRequest IndivRequest = \n            e.Request as PlayReadyIndividualizationServiceRequest;\n\n        bool bResultIndiv = await ReactiveIndivRequest(IndivRequest, e.Completion);\n    }\n    else if (e.Request is PlayReadyLicenseAcquisitionServiceRequest)\n    {\n        PlayReadyLicenseAcquisitionServiceRequest licenseRequest = \n            e.Request as PlayReadyLicenseAcquisitionServiceRequest;\n\n        LicenseAcquisitionRequest(\n            licenseRequest, \n            e.Completion, \n            playReadyLicenseUrl, \n            playReadyChallengeCustomData);\n    }\n}\n```\n\n## Individualization service requests\n\nThe following code reactively makes a PlayReady individualization service request. We pass in the request as a parameter to the function. We surround the call in a try/catch block, and if there are no exceptions, we say the request completed successfully:\n\n```csharp\nasync Task<bool> ReactiveIndivRequest(\n    PlayReadyIndividualizationServiceRequest IndivRequest, \n    MediaProtectionServiceCompletion CompletionNotifier)\n{\n    bool bResult = false;\n    Exception exception = null;\n\n    try\n    {\n        await IndivRequest.BeginServiceRequest();\n    }\n    catch (Exception ex)\n    {\n        exception = ex;\n    }\n    finally\n    {\n        if (exception == null)\n        {\n            bResult = true;\n        }\n        else\n        {\n            COMException comException = exception as COMException;\n            if (comException != null && comException.HResult == MSPR_E_CONTENT_ENABLING_ACTION_REQUIRED)\n            {\n                IndivRequest.NextServiceRequest();\n            }\n        }\n    }\n\n    if (CompletionNotifier != null) CompletionNotifier.Complete(bResult);\n    return bResult;\n}\n```\n\nAlternatively, we may want to proactively make an individualization service request, in which case we call the function below in place of the code calling `ReactiveIndivRequest` in `ProtectionManager_ServiceRequested`:\n\n```csharp\nasync void ProActiveIndivRequest()\n{\n    PlayReadyIndividualizationServiceRequest indivRequest = new PlayReadyIndividualizationServiceRequest();\n    bool bResultIndiv = await ReactiveIndivRequest(indivRequest, null);\n}\n```\n\n## License acquisition service requests\n\nIf instead the request was a [PlayReadyLicenseAcquisitionServiceRequest](https://msdn.microsoft.com/library/windows/apps/dn986285), we call the below function to request and acquire the PlayReady license. We tell the MediaProtectionServiceCompletion object that we passed in whether the request was successful or not, and we complete the request:\n\n```csharp\nasync void LicenseAcquisitionRequest(\n    PlayReadyLicenseAcquisitionServiceRequest licenseRequest, \n    MediaProtectionServiceCompletion CompletionNotifier, \n    string Url, \n    string ChallengeCustomData)\n{\n    bool bResult = false;\n    string ExceptionMessage = string.Empty;\n\n    try\n    {\n        if (!string.IsNullOrEmpty(Url))\n        {\n            if (!string.IsNullOrEmpty(ChallengeCustomData))\n            {\n                System.Text.UTF8Encoding encoding = new System.Text.UTF8Encoding();\n                byte[] b = encoding.GetBytes(ChallengeCustomData);\n                licenseRequest.ChallengeCustomData = Convert.ToBase64String(b, 0, b.Length);\n            }\n\n            PlayReadySoapMessage soapMessage = licenseRequest.GenerateManualEnablingChallenge();\n\n            byte[] messageBytes = soapMessage.GetMessageBody();\n            HttpContent httpContent = new ByteArrayContent(messageBytes);\n\n            IPropertySet propertySetHeaders = soapMessage.MessageHeaders;\n\n            foreach (string strHeaderName in propertySetHeaders.Keys)\n            {\n                string strHeaderValue = propertySetHeaders[strHeaderName].ToString();\n\n                if (strHeaderName.Equals(\"Content-Type\", StringComparison.OrdinalIgnoreCase))\n                {\n                    httpContent.Headers.ContentType = MediaTypeHeaderValue.Parse(strHeaderValue);\n                }\n                else\n                {\n                    httpContent.Headers.Add(strHeaderName.ToString(), strHeaderValue);\n                }\n            }\n\n            CommonLicenseRequest licenseAcquision = new CommonLicenseRequest();\n\n            HttpContent responseHttpContent = \n                await licenseAcquision.AcquireLicense(new Uri(Url), httpContent);\n\n            if (responseHttpContent != null)\n            {\n                Exception exResult = licenseRequest.ProcessManualEnablingResponse(\n                                         await responseHttpContent.ReadAsByteArrayAsync());\n\n                if (exResult != null)\n                {\n                    throw exResult;\n                }\n                bResult = true;\n            }\n            else\n            {\n                ExceptionMessage = licenseAcquision.GetLastErrorMessage();\n            }\n        }\n        else\n        {\n            await licenseRequest.BeginServiceRequest();\n            bResult = true;\n        }\n    }\n    catch (Exception e)\n    {\n        ExceptionMessage = e.Message;\n    }\n\n    CompletionNotifier.Complete(bResult);\n}\n```\n\n## Initializing the AdaptiveMediaSource\n\nFinally, you will need a function to initialize the [AdaptiveMediaSource](https://msdn.microsoft.com/library/windows/apps/dn946912), created from a given [Uri](https://msdn.microsoft.com/library/windows/apps/xaml/system.uri.aspx) and [MediaElement](https://msdn.microsoft.com/library/windows/apps/br242926). The **Uri** should be the link to the media file (HLS or DASH); the **MediaElement** should be defined in your XAML.\n\n```csharp\nasync private void InitializeAdaptiveMediaSource(System.Uri uri, MediaElement m)\n{\n    AdaptiveMediaSourceCreationResult result = await AdaptiveMediaSource.CreateFromUriAsync(uri);\n    if (result.Status == AdaptiveMediaSourceCreationStatus.Success)\n    {\n        ams = result.MediaSource;\n        SetUpProtectionManager(ref m);\n        m.SetMediaStreamSource(ams);\n    }\n    else\n    {\n        // Error handling\n    }\n}\n```\n\nYou can call this function in whichever event handles the start of adaptive streaming—for instance, in a button click event.\n\n \n\n \n\n\n\n\n"}