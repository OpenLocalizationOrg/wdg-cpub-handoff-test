{"nodes":[{"content":"Create an NFC Smart Card app","pos":[2,30]},{"content":"\\[ Updated for UWP apps on Windows 10.","pos":[32,70]},{"content":"For Windows 8.x articles, see the <bpt id=\"p1\">[</bpt>archive<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=619132)</ept> \\]","pos":[71,166],"source":" For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]"},{"pos":[168,228],"content":"<bpt id=\"p1\">**</bpt>Important<ept id=\"p1\">**</ept>  This topic applies to Windows 10 Mobile only.","source":"**Important**  This topic applies to Windows 10 Mobile only."},{"content":"Windows Phone 8.1 supported NFC card emulation apps using a SIM-based secure element, but that model required secure payment apps to be tightly coupled with mobile-network operators (MNO).","pos":[230,418]},{"content":"This limited the variety of possible payment solutions by other merchants or developers that are not coupled with MNOs.","pos":[419,538]},{"content":"In Windows 10 Mobile, we have introduced a new card emulation technology called, Host Card Emulation (HCE).","pos":[539,646]},{"content":"HCE technology allows your app to directly communicate with an NFC card reader.","pos":[647,726]},{"content":"This topic illustrates how Host Card Emulation (HCE) works on Windows 10 Mobile devices and how you can develop an HCE app so that your customers can access your services through their phone instead of a physical card without collaborating with an MNO.","pos":[727,979]},{"content":"What you need to develop an HCE app","pos":[984,1019]},{"content":"To develop an HCE-based card emulation app for Windows 10 Mobile, you will need to get your development environment setup.","pos":[1022,1144]},{"content":"You can get set up by installing Microsoft Visual Studio 2015, which includes the Windows developer tools and the Windows 10 Mobile emulator with NFC emulation support.","pos":[1145,1313]},{"content":"For more information about getting setup, see, <bpt id=\"p1\">[</bpt>Get set up<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn726766)</ept>","pos":[1314,1431],"source":" For more information about getting setup, see, [Get set up](https://msdn.microsoft.com/library/windows/apps/Dn726766)"},{"content":"Optionally, if you want to test with a real Windows 10 Mobile device instead of the included Windows 10 Mobile emulator, you will also need the following items.","pos":[1433,1593]},{"content":"A Windows 10 Mobile device with NFC HCE support.","pos":[1599,1647]},{"content":"Currently, the Lumia 730, 830, 640, and the 640 XL have the hardware to support NFC HCE apps.","pos":[1648,1741]},{"content":"A reader terminal that supports protocols ISO/IEC 14443-4 and ISO/IEC 7816-4","pos":[1746,1822]},{"content":"Windows 10 Mobile implements an HCE service that provides the following functionalities.","pos":[1824,1912]},{"content":"Apps can register the applet identifiers (AIDs) for the cards they would like to emulate.","pos":[1918,2007]},{"content":"Conflict resolution and routing of the Application Protocol Data Unit (APDU) command and response pairs to one of the registered apps based on the external reader card selection and user preference.","pos":[2012,2210]},{"content":"Handling of events and notifications to the apps as a result of user actions.","pos":[2215,2292]},{"content":"Windows 10 supports emulation of smart cards that are based on ISO-DEP (ISO-IEC 14443-4) and communicates using APDUs as defined in the ISO-IEC 7816-4 specification.","pos":[2294,2459]},{"content":"Windows 10 supports ISO/IEC 14443-4 Type A technology for HCE apps.","pos":[2460,2527]},{"content":"Type B, type F, and non-ISO-DEP (eg MIFARE) technologies are routed to the SIM by default.","pos":[2528,2618]},{"content":"Only Windows 10 Mobile devices are enabled with the card emulation feature.","pos":[2620,2695]},{"content":"SIM-based and HCE-based card emulation is not available on other versions of Windows 10.","pos":[2696,2784]},{"content":"The architecture for HCE and SIM based card emulation support is shown in the diagram below.","pos":[2786,2878]},{"content":"App selection and AID routing","pos":[2920,2949]},{"content":"To develop an HCE app, you must understand how Windows 10 Mobile devices route AIDs to a specific app because users can install multiple different HCE apps.","pos":[2951,3107]},{"content":"Each app can register multiple HCE and SIM-based cards.","pos":[3108,3163]},{"content":"Legacy Windows Phone 8.1 apps that are SIM-based will continue to work on Windows 10 Mobile as long as the user chooses the \"SIM Card\" option as their default payment card in the NFC Setting menu.","pos":[3164,3360]},{"content":"This is set by default when turning the device on for the first time.","pos":[3361,3430]},{"content":"When the user taps their Windows 10 Mobile device to a terminal, the data is automatically routed to the proper app installed on the device.","pos":[3432,3572]},{"content":"This routing is based on the applet IDs (AIDs) which are 5-16 byte identifiers.","pos":[3573,3652]},{"content":"During a tap, the external terminal will transmit a SELECT command APDU to specify the AID it would like all subsequent APDU commands to be routed to.","pos":[3653,3803]},{"content":"Subsequent SELECT commands, will change the routing again.","pos":[3804,3862]},{"content":"Based on the AIDs registered by apps and user settings, the APDU traffic is routed to a specific app, which will send a response APDU.","pos":[3863,3997]},{"content":"Be aware that a terminal may want to communicate with several different apps during the same tap.","pos":[3998,4095]},{"content":"So you must ensure your app's background task exits as quickly as possible when deactivated to make room for another app's background task to respond to the APDU.","pos":[4096,4258]},{"content":"We will discuss background tasks later in this topic.","pos":[4259,4312]},{"content":"HCE apps must register themselves with particular AIDs they can handle so they will receive APDUs for an AID.","pos":[4314,4423]},{"content":"Apps decalre AIDs by using AID groups.","pos":[4424,4462]},{"content":"An AID group is conceptually equivalent to an individual physical card.","pos":[4463,4534]},{"content":"For example, one credit card is declared with an AID group and a second credit card from a different bank is declared with a different, second AID group, even though both of them may have the same AID.","pos":[4535,4736]},{"content":"Conflict resolution for payment AID groups","pos":[4741,4783]},{"content":"When an app registers physical cards (AID groups), it can declare the AID group category as either \"Payment\" or \"Other.\"","pos":[4785,4905]},{"content":"While there can be multiple payment AID groups registered at any given time, only one of these payment AID groups may be enabled for Tap and Pay at a time, which is selected by the user.","pos":[4906,5092]},{"content":"This behavior exists because the user expects be in control of consciously choosing a single payment, credit, or debit card to use so they don't pay with a different unintended card when tapping their device to a terminal.","pos":[5093,5315]},{"content":"However, multiple AID groups registered as \"Other\" can be enabled at the same time without user interaction.","pos":[5317,5425]},{"content":"This behavior exists because other types of cards like loyalty, coupons, or transit are expected to just work without any effort or prompting whenever they tap their phone.","pos":[5426,5598]},{"content":"All the AID groups that are registered as \"Payment\" appear in the list of cards in the NFC Settings page, where the user can select their default payment card.","pos":[5600,5759]},{"content":"When a default payment card is selected, the app that registered this payment AID group becomes the default payment app.","pos":[5760,5880]},{"content":"Default payment apps can enable or disable any of their AID groups without user interaction.","pos":[5881,5973]},{"content":"If the user declines the default payment app prompt, then the current default payment app (if any) continues to remain as default.","pos":[5974,6104]},{"content":"The following screenshot shows the NFC Settings page.","pos":[6105,6158]},{"content":"Using the example screenshot above, if the user changes his default payment card to another card that is not registered by \"HCE Application 1,\" the system creates a confirmation prompt for the user’s consent.","pos":[6192,6400]},{"content":"However, if the user changes his default payment card to another card that is registered by \"HCE Application 1,\" the system does not create a confirmation prompt for the user, because \"HCE Application1\" is already the default payment app.","pos":[6401,6639]},{"content":"Conflict resolution for non-payment AID groups","pos":[6644,6690]},{"content":"Non-payment cards categorized as \"Other\" do not appear in the NFC settings page.","pos":[6692,6772]},{"content":"Your app can create, register and enable non-payment AID groups in the same manner as payment AID groups.","pos":[6774,6879]},{"content":"The main difference is that for non-payment AID groups the emulation category is set to \"Other\" as opposed to \"Payment\".","pos":[6880,7000]},{"content":"After registering the AID group with the system, you need to enable the AID group to receive NFC traffic.","pos":[7001,7106]},{"content":"When you try to enable a non-payment AID group to receive traffic, the user is not prompted for a confirmation unless there is a conflict with one of the AIDs already registered in the system by a different app.","pos":[7107,7318]},{"content":"If there is a conflict, the user will be prompted with information about which card and it's associated app will be disabled if the user chooses to enable the newly registered AID group.","pos":[7319,7505]},{"content":"Coexistence with SIM based NFC applications","pos":[7509,7552]},{"content":"In Windows 10 Mobile, the system sets up the NFC controller routing table that is used to make routing decisions at the controller layer.","pos":[7556,7693]},{"content":"The table contains routing information for the following items.","pos":[7694,7757]},{"content":"Individual AID routes.","pos":[7763,7785]},{"content":"Protocol based route (ISO-DEP).","pos":[7790,7821]},{"content":"Technology based routing (NFC-A/B/F).","pos":[7826,7863]},{"content":"When an external reader sends a \"SELECT AID\" command, the NFC controller first checks AID routes in the routing table for a match.","pos":[7865,7995]},{"content":"If there is no match, it will use the protocol-based route as the default route for ISO-DEP (14443-4-A) traffic.","pos":[7996,8108]},{"content":"For any other non-ISO-DEP traffic it will use the technology based routing.","pos":[8109,8184]},{"content":"Windows 10 Mobile provides a menu option \"SIM Card\" in the NFC Settings page to continue to use legacy Windows Phone 8.1 SIM-based apps, which do not register their AIDs with the system.","pos":[8186,8372]},{"content":"If the user selects \"SIM card\" as their default payment card, then the ISO-DEP route is set to UICC, for all other selections in the drop-down menu the ISO-DEP route is to the host.","pos":[8373,8554]},{"content":"The ISO-DEP route is set to \"SIM Card\" for devices that have an SE enabled SIM card when the device is booted for the first time with Windows 10 Mobile.","pos":[8556,8708]},{"content":"When the user installs an HCE enabled app and that app enables any HCE AID group registrations, the ISO-DEP route will be pointed to the host.","pos":[8709,8851]},{"content":"New SIM-based applications need to register the AIDs in the SIM in order for the specific AID routes to be populated in the controller routing table.","pos":[8852,9001]},{"content":"Creating an HCE based app","pos":[9006,9031]},{"content":"Your HCE app has two parts.","pos":[9033,9060]},{"content":"The main foreground app for the user interaction.","pos":[9066,9115]},{"content":"A background task that is triggered by the system to process APDUs for a given AID.","pos":[9120,9203]},{"content":"Because of the extremely tight performance requirements for loading your background task in response to an NFC tap, we recommend that your entire background task be implementing in C++/CX native code (including any dependencies, references, or libraries you depend on) rather than C\\# or managed code.","pos":[9205,9506]},{"content":"While C\\# and managed code normally performs well, there is overhead, like loading the .NET CLR, that can be avoided by writing it in C++/CX.","pos":[9507,9648]},{"content":"Create and register your background task","pos":[9652,9692]},{"content":"You need to create a background task in your HCE app for processing and responding to APDUs routed to it by the system.","pos":[9694,9813]},{"content":"During the first time your app is launched, the foreground registers an HCE background task that implements the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IBackgroundTaskRegistration<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/BR224803)</ept> interface as shown in the following code.","pos":[9814,10059],"source":" During the first time your app is launched, the foreground registers an HCE background task that implements the [**IBackgroundTaskRegistration**](https://msdn.microsoft.com/library/windows/apps/BR224803) interface as shown in the following code."},{"content":"Notice that the task trigger is set to <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardTriggerType<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn608017)</ept>.","pos":[10333,10457],"source":"Notice that the task trigger is set to [**SmartCardTriggerType**](https://msdn.microsoft.com/library/windows/apps/Dn608017)."},{"content":"<bpt id=\"p1\">**</bpt>EmulatorHostApplicationActivated<ept id=\"p1\">**</ept>.","pos":[10458,10495],"source":"**EmulatorHostApplicationActivated**."},{"content":"This means that whenever a SELECT AID command APDU is received by the OS resolving to your app, your background task will be launched.","pos":[10496,10630]},{"content":"Receive and respond to APDUs","pos":[10635,10663]},{"content":"When there is an APDU targeted for your app, the system will launch your background task.","pos":[10665,10754]},{"content":"Your background task receives the APDU passed through the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardEmulatorApduReceivedEventArgs<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn894640)</ept> object’s <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>CommandApdu<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/en-us/library/windows/apps/windows.devices.smartcards.smartcardemulatorapdureceivedeventargs.commandapdu.aspx)</ept> property and responds to the APDU using the <bpt id=\"p5\">[</bpt><bpt id=\"p6\">**</bpt>TryRespondAsync<ept id=\"p6\">**</ept><ept id=\"p5\">](https://msdn.microsoft.com/en-us/library/windows/apps/mt634299.aspx)</ept> method of the same object.","pos":[10755,11242],"source":" Your background task receives the APDU passed through the [**SmartCardEmulatorApduReceivedEventArgs**](https://msdn.microsoft.com/library/windows/apps/Dn894640) object’s [**CommandApdu**](https://msdn.microsoft.com/en-us/library/windows/apps/windows.devices.smartcards.smartcardemulatorapdureceivedeventargs.commandapdu.aspx) property and responds to the APDU using the [**TryRespondAsync**](https://msdn.microsoft.com/en-us/library/windows/apps/mt634299.aspx) method of the same object."},{"content":"Consider keeping your background task for light operations for performance reasons.","pos":[11243,11326]},{"content":"For example, respond to the APDUs immediately and exit your background task when all processing is complete.","pos":[11327,11435]},{"content":"Due to the nature of NFC transactions, users tend to hold their device against the reader for only a very short amount of time.","pos":[11436,11563]},{"content":"Your background task will continue to receive traffic from the reader until your connection is deactivated, in which case you will receive a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardEmulatorConnectionDeactivatedEventArgs<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn894644)</ept> object.","pos":[11564,11824],"source":" Your background task will continue to receive traffic from the reader until your connection is deactivated, in which case you will receive a [**SmartCardEmulatorConnectionDeactivatedEventArgs**](https://msdn.microsoft.com/library/windows/apps/Dn894644) object."},{"content":"Your connection can be deactivated because of the following reasons as indicated in the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardEmulatorConnectionDeactivatedEventArgs.Reason<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/windows.devices.smartcards.smartcardemulatorconnectiondeactivatedeventargs.reason)</ept> property.","pos":[11825,12114],"source":" Your connection can be deactivated because of the following reasons as indicated in the [**SmartCardEmulatorConnectionDeactivatedEventArgs.Reason**](https://msdn.microsoft.com/library/windows/apps/windows.devices.smartcards.smartcardemulatorconnectiondeactivatedeventargs.reason) property."},{"content":"If the connection is deactivated with the <bpt id=\"p1\">**</bpt>ConnectionLost<ept id=\"p1\">**</ept> value, it means that the user pulled their device away from the reader.","pos":[12120,12252],"source":"If the connection is deactivated with the **ConnectionLost** value, it means that the user pulled their device away from the reader."},{"content":"If your app needs the user to tap to the terminal longer, you might want to consider prompting them with feedback.","pos":[12253,12367]},{"content":"You should terminate your background task quickly (by completing your deferral) to ensure if they tap again it won’t be delayed waiting for the previous background task to exit.","pos":[12368,12545]},{"content":"If the connection is deactivated with the <bpt id=\"p1\">**</bpt>ConnectionRedirected<ept id=\"p1\">**</ept>, it means that the terminal sent a new SELECT AID command APDU directed to a different AID.","pos":[12550,12708],"source":"If the connection is deactivated with the **ConnectionRedirected**, it means that the terminal sent a new SELECT AID command APDU directed to a different AID."},{"content":"In this case, your app should exit the background task immediately (by completing your deferral) to allow another background task to run.","pos":[12709,12846]},{"content":"The background task should also register for the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>Canceled event<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/BR224798)</ept> on <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>IBackgroundTaskInstance interface<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/BR224797)</ept>, and likewise quickly exit the background task (by completing your deferral) because this event is fired by the system when it is finished with your background task.","pos":[12848,13242],"source":"The background task should also register for the [**Canceled event**](https://msdn.microsoft.com/library/windows/apps/BR224798) on [**IBackgroundTaskInstance interface**](https://msdn.microsoft.com/library/windows/apps/BR224797), and likewise quickly exit the background task (by completing your deferral) because this event is fired by the system when it is finished with your background task."},{"content":"Below is code that demonstrates an HCE app background task.","pos":[13243,13302]},{"content":"Create and register AID groups","pos":[16438,16468]},{"content":"During the first launch of your application when the card is being provisioned, you will create and register AID groups with the system.","pos":[16470,16606]},{"content":"The system determines the app that an external reader would like to talk to and route APDUs accordingly based on the registered AIDs and user settings.","pos":[16607,16758]},{"content":"Most of the payment cards register for the same AID (which is PPSE AID) along with additional payment network card specific AIDs.","pos":[16760,16889]},{"content":"Each AID group represents a card and when the user enables the card, all AIDs in the group are enabled.","pos":[16890,16993]},{"content":"Similarly, when the user deactivates the card, all AIDs in the group are disabled.","pos":[16994,17076]},{"content":"To register an AID group, you need to create a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardAppletIdGroup<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn910955)</ept> object and set its properties to reflect that this is an HCE-based payment card.","pos":[17078,17292],"source":"To register an AID group, you need to create a [**SmartCardAppletIdGroup**](https://msdn.microsoft.com/library/windows/apps/Dn910955) object and set its properties to reflect that this is an HCE-based payment card."},{"content":"Your display name should be descriptive to the user because it will show up in the NFC settings menu as well as user prompts.","pos":[17293,17418]},{"content":"For HCE payment cards, the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardEmulationCategory<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/en-us/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationcategory.aspx)</ept> property should be set to <bpt id=\"p3\">**</bpt>Payment<ept id=\"p3\">**</ept> and the <bpt id=\"p4\">[</bpt><bpt id=\"p5\">**</bpt>SmartCardEmulationType<ept id=\"p5\">**</ept><ept id=\"p4\">](https://msdn.microsoft.com/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationtype)</ept> property should be set to <bpt id=\"p6\">**</bpt>Host<ept id=\"p6\">**</ept>.","pos":[17419,17848],"source":" For HCE payment cards, the [**SmartCardEmulationCategory**](https://msdn.microsoft.com/en-us/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationcategory.aspx) property should be set to **Payment** and the [**SmartCardEmulationType**](https://msdn.microsoft.com/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationtype) property should be set to **Host**."},{"pos":[18460,18891],"content":"For non-payment HCE cards, the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardEmulationCategory<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/en-us/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationcategory.aspx)</ept> property should be set to <bpt id=\"p3\">**</bpt>Other<ept id=\"p3\">**</ept> and the <bpt id=\"p4\">[</bpt><bpt id=\"p5\">**</bpt>SmartCardEmulationType<ept id=\"p5\">**</ept><ept id=\"p4\">](https://msdn.microsoft.com/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationtype)</ept> property should be set to <bpt id=\"p6\">**</bpt>Host<ept id=\"p6\">**</ept>.","source":"For non-payment HCE cards, the [**SmartCardEmulationCategory**](https://msdn.microsoft.com/en-us/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationcategory.aspx) property should be set to **Other** and the [**SmartCardEmulationType**](https://msdn.microsoft.com/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationtype) property should be set to **Host**."},{"content":"You can include up to 9 AIDs (of length 5-16 bytes each) per AID group.","pos":[19439,19510]},{"content":"Use the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>RegisterAppletIdGroupAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn894656)</ept> method to register your AID group with the system, which will return a <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SmartCardAppletIdGroupRegistration<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/Dn910955registration)</ept> object.","pos":[19512,19800],"source":"Use the [**RegisterAppletIdGroupAsync**](https://msdn.microsoft.com/library/windows/apps/Dn894656) method to register your AID group with the system, which will return a [**SmartCardAppletIdGroupRegistration**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration) object."},{"content":"By default, the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ActivationPolicy<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_activationpolicy)</ept> property of the registration object is set to <bpt id=\"p3\">**</bpt>Disabled<ept id=\"p3\">**</ept>.","pos":[19801,19986],"source":" By default, the [**ActivationPolicy**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_activationpolicy) property of the registration object is set to **Disabled**."},{"content":"This means even though your AIDs are registered with the system, they are not enabled yet and won’t receive traffic.","pos":[19987,20103]},{"content":"You can enable your registered cards (AID groups) by using the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>RequestActivationPolicyChangeAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_requestactivationpolicychangeasync)</ept> method of the<bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SmartCardAppletIdGroupRegistration<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/Dn910955registration)</ept> class as shown below.","pos":[20193,20547],"source":"You can enable your registered cards (AID groups) by using the [**RequestActivationPolicyChangeAsync**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_requestactivationpolicychangeasync) method of the[**SmartCardAppletIdGroupRegistration**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration) class as shown below."},{"content":"Because only a single payment card can be enabled at a time on the system, setting the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ActivationPolicy<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_activationpolicy)</ept> of a payment AID group to <bpt id=\"p3\">**</bpt>Enabled<ept id=\"p3\">**</ept> is the same as setting the default payment card.","pos":[20548,20831],"source":" Because only a single payment card can be enabled at a time on the system, setting the [**ActivationPolicy**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_activationpolicy) of a payment AID group to **Enabled** is the same as setting the default payment card."},{"content":"The user will be prompted to allow this card as a default payment card, regardless of whether there is a default payment card already selected or not.","pos":[20832,20982]},{"content":"This statement is not true if your app is already the default payment application, and is merely changing between it’s own AID groups.","pos":[20983,21117]},{"content":"You can register up to 10 AID groups per app.","pos":[21118,21163]},{"pos":[21259,21468],"content":"You can query your app’s registered AID groups with the OS and check their activation policy using the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>GetAppletIdGroupRegistrationsAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn894654)</ept> method.","source":"You can query your app’s registered AID groups with the OS and check their activation policy using the [**GetAppletIdGroupRegistrationsAsync**](https://msdn.microsoft.com/library/windows/apps/Dn894654) method."},{"content":"Users will be prompted when you change the activation policy of a payment card from <bpt id=\"p1\">**</bpt>Disabled<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>Enabled<ept id=\"p2\">**</ept>, only if your app is not already the default payment app.","pos":[21470,21639],"source":"Users will be prompted when you change the activation policy of a payment card from **Disabled** to **Enabled**, only if your app is not already the default payment app."},{"content":"Users will only be prompted when you change the activation policy of a non-payment card from <bpt id=\"p1\">**</bpt>Disabled<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>Enabled<ept id=\"p2\">**</ept> if there is an AID conflict.","pos":[21640,21789],"source":" Users will only be prompted when you change the activation policy of a non-payment card from **Disabled** to **Enabled** if there is an AID conflict."},{"content":"Event notification when activation policy change","pos":[22039,22087]},{"content":"In your background task, you can register to receive events for when the activation policy of one of your AID group registrations changes outside of your app.","pos":[22091,22249]},{"content":"For example, the user may change the default payment app through the NFC settings menu from one of your cards to another card hosted by another app.","pos":[22250,22398]},{"content":"If your app needs to know about this change for internal setup such as updating live tiles, you can receive event notifications for this change and take action in your app accordingly.","pos":[22399,22583]},{"content":"Foreground override behavior","pos":[22868,22896]},{"content":"You can change the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ActivationPolicy<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_activationpolicy)</ept> of any of your AID group registrations to <bpt id=\"p3\">**</bpt>ForegroundOverride<ept id=\"p3\">**</ept> while your app is in the foreground without prompting the user.","pos":[22898,23155],"source":"You can change the [**ActivationPolicy**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_activationpolicy) of any of your AID group registrations to **ForegroundOverride** while your app is in the foreground without prompting the user."},{"content":"When the user taps their device to a terminal while your app is in the foreground, the traffic is routed to your app even if none of your payment cards were chosen by the user as their default payment card.","pos":[23156,23362]},{"content":"When you change a card’s activation policy to <bpt id=\"p1\">**</bpt>ForegroundOverride<ept id=\"p1\">**</ept>, this change is only temporary until your app leaves the foreground and it will not change the current default payment card set by the user.","pos":[23363,23572],"source":" When you change a card’s activation policy to **ForegroundOverride**, this change is only temporary until your app leaves the foreground and it will not change the current default payment card set by the user."},{"content":"You can change the <bpt id=\"p1\">**</bpt>ActivationPolicy<ept id=\"p1\">**</ept> of your payment or non-payment cards from your foreground app as follows.","pos":[23573,23686],"source":" You can change the **ActivationPolicy** of your payment or non-payment cards from your foreground app as follows."},{"content":"Note that the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>RequestActivationPolicyChangeAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_requestactivationpolicychangeasync)</ept> method can only be called from a foreground app and cannot be called from a background task.","pos":[23687,23939],"source":" Note that the [**RequestActivationPolicyChangeAsync**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_requestactivationpolicychangeasync) method can only be called from a foreground app and cannot be called from a background task."},{"content":"Also, you can register an AID group consisting of a single 0-length AID which will cause the system to route all APDUs regardless of the AID and including any command APDUs sent before a SELECT AID command is received.","pos":[24046,24264]},{"content":"However, such an AID group only works while your app is in the foreground because it can only be set to <bpt id=\"p1\">**</bpt>ForegroundOverride<ept id=\"p1\">**</ept> and cannot be permanently enabled.","pos":[24265,24426],"source":" However, such an AID group only works while your app is in the foreground because it can only be set to **ForegroundOverride** and cannot be permanently enabled."},{"content":"Also, this mechanism works both for <bpt id=\"p1\">**</bpt>Host<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>UICC<ept id=\"p2\">**</ept> values of the <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SmartCardEmulationType<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/Dn894639)</ept> enumeration to either route all traffic to your HCE background task, or to the SIM card.","pos":[24427,24674],"source":" Also, this mechanism works both for **Host** and **UICC** values of the [**SmartCardEmulationType**](https://msdn.microsoft.com/library/windows/apps/Dn894639) enumeration to either route all traffic to your HCE background task, or to the SIM card."},{"content":"Check for NFC and HCE support","pos":[25211,25240]},{"content":"Your app should check whether a device has NFC hardware, supports the card emulation feature, and supports host card emulation prior to offering such features to the user.","pos":[25242,25413]},{"content":"The NFC smart card emulation feature is only enabled on Windows 10 Mobile, so trying to use the smart card emulator APIs in any other versions of Windows 10, will cause errors.","pos":[25415,25591]},{"content":"You can check for smart card API support in the following code snippet.","pos":[25592,25663]},{"content":"You can additionally check to see if the device has NFC hardware capable of some form of card emulation by checking if the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardEmulator.GetDefaultAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn608008)</ept> method returns null.","pos":[25786,26027],"source":"You can additionally check to see if the device has NFC hardware capable of some form of card emulation by checking if the [**SmartCardEmulator.GetDefaultAsync**](https://msdn.microsoft.com/library/windows/apps/Dn608008) method returns null."},{"content":"If it does, then no NFC card emulation is supported on the device.","pos":[26028,26094]},{"content":"Support for HCE and AID-based UICC routing is only available on recently launched devices such as the Lumia 730, 830, 640, and 640 XL.","pos":[26179,26313]},{"content":"Any new NFC capable devices running Windows 10 Mobile and after should support HCE.","pos":[26314,26397]},{"content":"Your app can check for HCE support as follows.","pos":[26398,26444]},{"content":"Lock screen and screen off behavior","pos":[26514,26549]},{"content":"Windows 10 Mobile has device-level card emulation settings, which can be set by the mobile operator or the manufacturer of the device.","pos":[26551,26685]},{"content":"By default, \"tap to pay\" toggle is disabled and the \"enablement policy at device level\" is set to \"Always\", unless the MO or OEM overwrites these values.","pos":[26686,26839]},{"pos":[26841,27072],"content":"Your application can query the value of the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>EnablementPolicy<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn608006)</ept> at device level and take action for each case depending on the desired behavior of your app in each state.","source":"Your application can query the value of the [**EnablementPolicy**](https://msdn.microsoft.com/library/windows/apps/Dn608006) at device level and take action for each case depending on the desired behavior of your app in each state."},{"content":"Your app's background task will be launched even if the phone is locked and/or the screen is off only if the external reader selects an AID that resolves to your app.","pos":[27577,27743]},{"content":"You can respond to the commands from the reader in your background task, but if you need any input from the user or if you want to show a message to the user, you can launch your foreground app with some arguments.","pos":[27744,27958]},{"content":"Your background task can launch your foreground app with the following behavior.","pos":[27959,28039]},{"content":"Under the device lock screen (the user will see your foreground app only after she unlocks the device)","pos":[28045,28147]},{"content":"Above the device lock screen (after the user dismisses your app, the device is still in locked state)","pos":[28152,28253]},{"content":"AID registration and other updates for SIM based apps","pos":[28544,28597]},{"content":"Card emulation apps that use the SIM as the secure element can register with the Windows service to declare the AIDs supported on the SIM.","pos":[28599,28737]},{"content":"This registration is very similar to an HCE-based app registration.","pos":[28738,28805]},{"content":"The only difference is the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardEmulationType<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/Dn894639)</ept>, which should be set to Uicc for SIM-based apps.","pos":[28806,28968],"source":" The only difference is the [**SmartCardEmulationType**](https://msdn.microsoft.com/library/windows/apps/Dn894639), which should be set to Uicc for SIM-based apps."},{"content":"As the result of the payment card registration, the display name of the card will also be populated in the NFC setting menu.","pos":[28969,29093]},{"content":"Important","pos":[29412,29421]},{"content":"The legacy binary SMS intercept support in Windows Phone 8.1 has been removed and replaced with new broader SMS support in Windows 10 Mobile, but any legacy Windows Phone 8.1 apps relying on that must update to use the new Windows 10 Mobile SMS APIs.","pos":[29427,29677]}],"content":"# Create an NFC Smart Card app\n\n\\[ Updated for UWP apps on Windows 10. For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]\n\n**Important**  This topic applies to Windows 10 Mobile only.\n\nWindows Phone 8.1 supported NFC card emulation apps using a SIM-based secure element, but that model required secure payment apps to be tightly coupled with mobile-network operators (MNO). This limited the variety of possible payment solutions by other merchants or developers that are not coupled with MNOs. In Windows 10 Mobile, we have introduced a new card emulation technology called, Host Card Emulation (HCE). HCE technology allows your app to directly communicate with an NFC card reader. This topic illustrates how Host Card Emulation (HCE) works on Windows 10 Mobile devices and how you can develop an HCE app so that your customers can access your services through their phone instead of a physical card without collaborating with an MNO.\n\n## What you need to develop an HCE app\n\n\nTo develop an HCE-based card emulation app for Windows 10 Mobile, you will need to get your development environment setup. You can get set up by installing Microsoft Visual Studio 2015, which includes the Windows developer tools and the Windows 10 Mobile emulator with NFC emulation support. For more information about getting setup, see, [Get set up](https://msdn.microsoft.com/library/windows/apps/Dn726766)\n\nOptionally, if you want to test with a real Windows 10 Mobile device instead of the included Windows 10 Mobile emulator, you will also need the following items.\n\n-   A Windows 10 Mobile device with NFC HCE support. Currently, the Lumia 730, 830, 640, and the 640 XL have the hardware to support NFC HCE apps.\n-   A reader terminal that supports protocols ISO/IEC 14443-4 and ISO/IEC 7816-4\n\nWindows 10 Mobile implements an HCE service that provides the following functionalities.\n\n-   Apps can register the applet identifiers (AIDs) for the cards they would like to emulate.\n-   Conflict resolution and routing of the Application Protocol Data Unit (APDU) command and response pairs to one of the registered apps based on the external reader card selection and user preference.\n-   Handling of events and notifications to the apps as a result of user actions.\n\nWindows 10 supports emulation of smart cards that are based on ISO-DEP (ISO-IEC 14443-4) and communicates using APDUs as defined in the ISO-IEC 7816-4 specification. Windows 10 supports ISO/IEC 14443-4 Type A technology for HCE apps. Type B, type F, and non-ISO-DEP (eg MIFARE) technologies are routed to the SIM by default.\n\nOnly Windows 10 Mobile devices are enabled with the card emulation feature. SIM-based and HCE-based card emulation is not available on other versions of Windows 10.\n\nThe architecture for HCE and SIM based card emulation support is shown in the diagram below. \n\n![](./images/nfc-architecture.png)\n\n## App selection and AID routing\n\nTo develop an HCE app, you must understand how Windows 10 Mobile devices route AIDs to a specific app because users can install multiple different HCE apps. Each app can register multiple HCE and SIM-based cards. Legacy Windows Phone 8.1 apps that are SIM-based will continue to work on Windows 10 Mobile as long as the user chooses the \"SIM Card\" option as their default payment card in the NFC Setting menu. This is set by default when turning the device on for the first time.\n\nWhen the user taps their Windows 10 Mobile device to a terminal, the data is automatically routed to the proper app installed on the device. This routing is based on the applet IDs (AIDs) which are 5-16 byte identifiers. During a tap, the external terminal will transmit a SELECT command APDU to specify the AID it would like all subsequent APDU commands to be routed to. Subsequent SELECT commands, will change the routing again. Based on the AIDs registered by apps and user settings, the APDU traffic is routed to a specific app, which will send a response APDU. Be aware that a terminal may want to communicate with several different apps during the same tap. So you must ensure your app's background task exits as quickly as possible when deactivated to make room for another app's background task to respond to the APDU. We will discuss background tasks later in this topic.\n\nHCE apps must register themselves with particular AIDs they can handle so they will receive APDUs for an AID. Apps decalre AIDs by using AID groups. An AID group is conceptually equivalent to an individual physical card. For example, one credit card is declared with an AID group and a second credit card from a different bank is declared with a different, second AID group, even though both of them may have the same AID.\n\n## Conflict resolution for payment AID groups\n\nWhen an app registers physical cards (AID groups), it can declare the AID group category as either \"Payment\" or \"Other.\" While there can be multiple payment AID groups registered at any given time, only one of these payment AID groups may be enabled for Tap and Pay at a time, which is selected by the user. This behavior exists because the user expects be in control of consciously choosing a single payment, credit, or debit card to use so they don't pay with a different unintended card when tapping their device to a terminal.\n\nHowever, multiple AID groups registered as \"Other\" can be enabled at the same time without user interaction. This behavior exists because other types of cards like loyalty, coupons, or transit are expected to just work without any effort or prompting whenever they tap their phone.\n\nAll the AID groups that are registered as \"Payment\" appear in the list of cards in the NFC Settings page, where the user can select their default payment card. When a default payment card is selected, the app that registered this payment AID group becomes the default payment app. Default payment apps can enable or disable any of their AID groups without user interaction. If the user declines the default payment app prompt, then the current default payment app (if any) continues to remain as default. The following screenshot shows the NFC Settings page.\n\n![](./images/nfc-settings.png)\n\nUsing the example screenshot above, if the user changes his default payment card to another card that is not registered by \"HCE Application 1,\" the system creates a confirmation prompt for the user’s consent. However, if the user changes his default payment card to another card that is registered by \"HCE Application 1,\" the system does not create a confirmation prompt for the user, because \"HCE Application1\" is already the default payment app.\n\n## Conflict resolution for non-payment AID groups\n\nNon-payment cards categorized as \"Other\" do not appear in the NFC settings page.\n\nYour app can create, register and enable non-payment AID groups in the same manner as payment AID groups. The main difference is that for non-payment AID groups the emulation category is set to \"Other\" as opposed to \"Payment\". After registering the AID group with the system, you need to enable the AID group to receive NFC traffic. When you try to enable a non-payment AID group to receive traffic, the user is not prompted for a confirmation unless there is a conflict with one of the AIDs already registered in the system by a different app. If there is a conflict, the user will be prompted with information about which card and it's associated app will be disabled if the user chooses to enable the newly registered AID group.\n\n**Coexistence with SIM based NFC applications**\n\nIn Windows 10 Mobile, the system sets up the NFC controller routing table that is used to make routing decisions at the controller layer. The table contains routing information for the following items.\n\n-   Individual AID routes.\n-   Protocol based route (ISO-DEP).\n-   Technology based routing (NFC-A/B/F).\n\nWhen an external reader sends a \"SELECT AID\" command, the NFC controller first checks AID routes in the routing table for a match. If there is no match, it will use the protocol-based route as the default route for ISO-DEP (14443-4-A) traffic. For any other non-ISO-DEP traffic it will use the technology based routing.\n\nWindows 10 Mobile provides a menu option \"SIM Card\" in the NFC Settings page to continue to use legacy Windows Phone 8.1 SIM-based apps, which do not register their AIDs with the system. If the user selects \"SIM card\" as their default payment card, then the ISO-DEP route is set to UICC, for all other selections in the drop-down menu the ISO-DEP route is to the host.\n\nThe ISO-DEP route is set to \"SIM Card\" for devices that have an SE enabled SIM card when the device is booted for the first time with Windows 10 Mobile. When the user installs an HCE enabled app and that app enables any HCE AID group registrations, the ISO-DEP route will be pointed to the host. New SIM-based applications need to register the AIDs in the SIM in order for the specific AID routes to be populated in the controller routing table.\n\n## Creating an HCE based app\n\nYour HCE app has two parts.\n\n-   The main foreground app for the user interaction.\n-   A background task that is triggered by the system to process APDUs for a given AID.\n\nBecause of the extremely tight performance requirements for loading your background task in response to an NFC tap, we recommend that your entire background task be implementing in C++/CX native code (including any dependencies, references, or libraries you depend on) rather than C\\# or managed code. While C\\# and managed code normally performs well, there is overhead, like loading the .NET CLR, that can be avoided by writing it in C++/CX.\n## Create and register your background task\n\nYou need to create a background task in your HCE app for processing and responding to APDUs routed to it by the system. During the first time your app is launched, the foreground registers an HCE background task that implements the [**IBackgroundTaskRegistration**](https://msdn.microsoft.com/library/windows/apps/BR224803) interface as shown in the following code.\n\n```csharp\nvar taskBuilder = new BackgroundTaskBuilder();\ntaskBuilder.Name = bgTaskName;\ntaskBuilder.TaskEntryPoint = taskEntryPoint;\ntaskBuilder.SetTrigger(new SmartCardTrigger(SmartCardTriggerType.EmulatorHostApplicationActivated));\nbgTask = taskBuilder.Register();\n```\n\nNotice that the task trigger is set to [**SmartCardTriggerType**](https://msdn.microsoft.com/library/windows/apps/Dn608017). **EmulatorHostApplicationActivated**. This means that whenever a SELECT AID command APDU is received by the OS resolving to your app, your background task will be launched.\n\n## Receive and respond to APDUs\n\nWhen there is an APDU targeted for your app, the system will launch your background task. Your background task receives the APDU passed through the [**SmartCardEmulatorApduReceivedEventArgs**](https://msdn.microsoft.com/library/windows/apps/Dn894640) object’s [**CommandApdu**](https://msdn.microsoft.com/en-us/library/windows/apps/windows.devices.smartcards.smartcardemulatorapdureceivedeventargs.commandapdu.aspx) property and responds to the APDU using the [**TryRespondAsync**](https://msdn.microsoft.com/en-us/library/windows/apps/mt634299.aspx) method of the same object. Consider keeping your background task for light operations for performance reasons. For example, respond to the APDUs immediately and exit your background task when all processing is complete. Due to the nature of NFC transactions, users tend to hold their device against the reader for only a very short amount of time. Your background task will continue to receive traffic from the reader until your connection is deactivated, in which case you will receive a [**SmartCardEmulatorConnectionDeactivatedEventArgs**](https://msdn.microsoft.com/library/windows/apps/Dn894644) object. Your connection can be deactivated because of the following reasons as indicated in the [**SmartCardEmulatorConnectionDeactivatedEventArgs.Reason**](https://msdn.microsoft.com/library/windows/apps/windows.devices.smartcards.smartcardemulatorconnectiondeactivatedeventargs.reason) property.\n\n-   If the connection is deactivated with the **ConnectionLost** value, it means that the user pulled their device away from the reader. If your app needs the user to tap to the terminal longer, you might want to consider prompting them with feedback. You should terminate your background task quickly (by completing your deferral) to ensure if they tap again it won’t be delayed waiting for the previous background task to exit.\n-   If the connection is deactivated with the **ConnectionRedirected**, it means that the terminal sent a new SELECT AID command APDU directed to a different AID. In this case, your app should exit the background task immediately (by completing your deferral) to allow another background task to run.\n\nThe background task should also register for the [**Canceled event**](https://msdn.microsoft.com/library/windows/apps/BR224798) on [**IBackgroundTaskInstance interface**](https://msdn.microsoft.com/library/windows/apps/BR224797), and likewise quickly exit the background task (by completing your deferral) because this event is fired by the system when it is finished with your background task. Below is code that demonstrates an HCE app background task.\n\n```csharp\nvoid BgTask::Run(\n    IBackgroundTaskInstance^ taskInstance)\n{\n    m_triggerDetails = static_cast<SmartCardTriggerDetails^>(taskInstance->TriggerDetails);\n    if (m_triggerDetails == nullptr)\n    {\n        // May be not a smart card event that triggered us\n        return;\n    }\n\n    m_emulator = m_triggerDetails->Emulator;\n    m_taskInstance = taskInstance;\n\n    switch (m_triggerDetails->TriggerType)\n    {\n    case SmartCardTriggerType::EmulatorHostApplicationActivated:\n        HandleHceActivation();\n        break;\n\n    case SmartCardTriggerType::EmulatorAppletIdGroupRegistrationChanged:\n        HandleRegistrationChange();\n        break;\n\n    default:\n        break;\n    }\n}\n\nvoid BgTask::HandleHceActivation()\n{\n try\n {\n        auto lock = m_srwLock.LockShared();\n        // Take a deferral to keep this background task alive even after this \"Run\" method returns\n        // You must complete this deferal immediately after you have done processing the current transaction\n        m_deferral = m_taskInstance->GetDeferral();\n\n        DebugLog(L\"*** HCE Activation Background Task Started ***\");\n\n        // Set up a handler for if the background task is cancelled, we must immediately complete our deferral\n        m_taskInstance->Canceled += ref new Windows::ApplicationModel::Background::BackgroundTaskCanceledEventHandler(\n            [this](\n            IBackgroundTaskInstance^ sender,\n            BackgroundTaskCancellationReason reason)\n        {\n            DebugLog(L\"Cancelled\");\n            DebugLog(reason.ToString()->Data());\n            EndTask();\n        });\n\n        if (Windows::Phone::System::SystemProtection::ScreenLocked)\n        {\n            auto denyIfLocked = Windows::Storage::ApplicationData::Current->RoamingSettings->Values->Lookup(\"DenyIfPhoneLocked\");\n            if (denyIfLocked != nullptr &amp;&amp; (bool)denyIfLocked == true)\n            {\n                // The phone is locked, and our current user setting is to deny transactions while locked so let the user know\n                // Denied\n                DoLaunch(Denied, L\"Phone was locked at the time of tap\");\n\n                // We still need to respond to APDUs in a timely manner, even though we will just return failure\n                m_fDenyTransactions = true;\n            }\n        }\n        else\n        {\n            m_fDenyTransactions = false;\n        }\n\n        m_emulator->ApduReceived += ref new TypedEventHandler<SmartCardEmulator^, SmartCardEmulatorApduReceivedEventArgs^>(\n            this, &amp;BgTask::ApduReceived);\n\n        m_emulator->ConnectionDeactivated += ref new TypedEventHandler<SmartCardEmulator^, SmartCardEmulatorConnectionDeactivatedEventArgs^>(\n                [this](\n                SmartCardEmulator^ emulator,\n                SmartCardEmulatorConnectionDeactivatedEventArgs^ eventArgs)\n            {\n                DebugLog(L\"Connection deactivated\");\n                EndTask();\n            });\n\n  m_emulator->Start();\n        DebugLog(L\"Emulator started\");\n }\n catch (Exception^ e)\n {\n        DebugLog((\"Exception in Run: \" + e->ToString())->Data());\n        EndTask();\n }\n}\n```\n## Create and register AID groups\n\nDuring the first launch of your application when the card is being provisioned, you will create and register AID groups with the system. The system determines the app that an external reader would like to talk to and route APDUs accordingly based on the registered AIDs and user settings.\n\nMost of the payment cards register for the same AID (which is PPSE AID) along with additional payment network card specific AIDs. Each AID group represents a card and when the user enables the card, all AIDs in the group are enabled. Similarly, when the user deactivates the card, all AIDs in the group are disabled.\n\nTo register an AID group, you need to create a [**SmartCardAppletIdGroup**](https://msdn.microsoft.com/library/windows/apps/Dn910955) object and set its properties to reflect that this is an HCE-based payment card. Your display name should be descriptive to the user because it will show up in the NFC settings menu as well as user prompts. For HCE payment cards, the [**SmartCardEmulationCategory**](https://msdn.microsoft.com/en-us/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationcategory.aspx) property should be set to **Payment** and the [**SmartCardEmulationType**](https://msdn.microsoft.com/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationtype) property should be set to **Host**.\n\n```csharp\npublic static byte[] AID_PPSE =\n        {\n            // File name \"2PAY.SYS.DDF01\" (14 bytes)\n            (byte)'2', (byte)'P', (byte)'A', (byte)'Y',\n            (byte)'.', (byte)'S', (byte)'Y', (byte)'S',\n            (byte)'.', (byte)'D', (byte)'D', (byte)'F', (byte)'0', (byte)'1'\n        };\n\nvar appletIdGroup = new SmartCardAppletIdGroup(\n                        \"Example DisplayName\", \n                                new List<IBuffer> {AID_PPSE.AsBuffer()},\n                                SmartCardEmulationCategory.Payment,\n                                SmartCardEmulationType.Host);\n```\n\nFor non-payment HCE cards, the [**SmartCardEmulationCategory**](https://msdn.microsoft.com/en-us/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationcategory.aspx) property should be set to **Other** and the [**SmartCardEmulationType**](https://msdn.microsoft.com/library/windows/apps/windows.devices.smartcards.smartcardappletidgroup.smartcardemulationtype) property should be set to **Host**.\n\n```csharp\npublic static byte[] AID_OTHER =\n        {\n            (byte)'1', (byte)'2', (byte)'3', (byte)'4',\n            (byte)'5', (byte)'6', (byte)'7', (byte)'8',\n            (byte)'O', (byte)'T', (byte)'H', (byte)'E', (byte)'R’\n        };\n\nvar appletIdGroup = new SmartCardAppletIdGroup(\n                        \"Example DisplayName\", \n                                new List<IBuffer> {AID_OTHER.AsBuffer()},\n                                SmartCardEmulationCategory.Other,\n                                SmartCardEmulationType.Host);\n```\n\nYou can include up to 9 AIDs (of length 5-16 bytes each) per AID group.\n\nUse the [**RegisterAppletIdGroupAsync**](https://msdn.microsoft.com/library/windows/apps/Dn894656) method to register your AID group with the system, which will return a [**SmartCardAppletIdGroupRegistration**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration) object. By default, the [**ActivationPolicy**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_activationpolicy) property of the registration object is set to **Disabled**. This means even though your AIDs are registered with the system, they are not enabled yet and won’t receive traffic.\n\n```csharp\nreg = await SmartCardEmulator.RegisterAppletIdGroupAsync(appletIdGroup);\n```\n\nYou can enable your registered cards (AID groups) by using the [**RequestActivationPolicyChangeAsync**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_requestactivationpolicychangeasync) method of the[**SmartCardAppletIdGroupRegistration**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration) class as shown below. Because only a single payment card can be enabled at a time on the system, setting the [**ActivationPolicy**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_activationpolicy) of a payment AID group to **Enabled** is the same as setting the default payment card. The user will be prompted to allow this card as a default payment card, regardless of whether there is a default payment card already selected or not. This statement is not true if your app is already the default payment application, and is merely changing between it’s own AID groups. You can register up to 10 AID groups per app.\n\n```csharp\nreg.RequestActivationPolicyChangeAsync(AppletIdGroupActivationPolicy.Enabled);\n```\n\nYou can query your app’s registered AID groups with the OS and check their activation policy using the [**GetAppletIdGroupRegistrationsAsync**](https://msdn.microsoft.com/library/windows/apps/Dn894654) method.\n\nUsers will be prompted when you change the activation policy of a payment card from **Disabled** to **Enabled**, only if your app is not already the default payment app. Users will only be prompted when you change the activation policy of a non-payment card from **Disabled** to **Enabled** if there is an AID conflict.\n\n```csharp\nvar registrations = await SmartCardEmulator.GetAppletIdGroupRegistrationsAsync();\n    foreach (var registration in registrations)\n    {\nregistration.RequestActivationPolicyChangeAsync (AppletIdGroupActivationPolicy.Enabled);\n    }\n```\n\n**Event notification when activation policy change**\n\nIn your background task, you can register to receive events for when the activation policy of one of your AID group registrations changes outside of your app. For example, the user may change the default payment app through the NFC settings menu from one of your cards to another card hosted by another app. If your app needs to know about this change for internal setup such as updating live tiles, you can receive event notifications for this change and take action in your app accordingly.\n\n```csharp\nvar taskBuilder = new BackgroundTaskBuilder();\ntaskBuilder.Name = bgTaskName;\ntaskBuilder.TaskEntryPoint = taskEntryPoint;\ntaskBuilder.SetTrigger(new SmartCardTrigger(SmartCardTriggerType.EmulatorAppletIdGroupRegistrationChanged));\nbgTask = taskBuilder.Register();\n```\n\n## Foreground override behavior\n\nYou can change the [**ActivationPolicy**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_activationpolicy) of any of your AID group registrations to **ForegroundOverride** while your app is in the foreground without prompting the user. When the user taps their device to a terminal while your app is in the foreground, the traffic is routed to your app even if none of your payment cards were chosen by the user as their default payment card. When you change a card’s activation policy to **ForegroundOverride**, this change is only temporary until your app leaves the foreground and it will not change the current default payment card set by the user. You can change the **ActivationPolicy** of your payment or non-payment cards from your foreground app as follows. Note that the [**RequestActivationPolicyChangeAsync**](https://msdn.microsoft.com/library/windows/apps/Dn910955registration_requestactivationpolicychangeasync) method can only be called from a foreground app and cannot be called from a background task.\n\n```csharp\nreg.RequestActivationPolicyChangeAsync(AppletIdGroupActivationPolicy.ForegroundOverride);\n```\n\nAlso, you can register an AID group consisting of a single 0-length AID which will cause the system to route all APDUs regardless of the AID and including any command APDUs sent before a SELECT AID command is received. However, such an AID group only works while your app is in the foreground because it can only be set to **ForegroundOverride** and cannot be permanently enabled. Also, this mechanism works both for **Host** and **UICC** values of the [**SmartCardEmulationType**](https://msdn.microsoft.com/library/windows/apps/Dn894639) enumeration to either route all traffic to your HCE background task, or to the SIM card.\n\n```csharp\npublic static byte[] AID_Foreground =\n        {};\n\nvar appletIdGroup = new SmartCardAppletIdGroup(\n                        \"Example DisplayName\", \n                                new List<IBuffer> {AID_Foreground.AsBuffer()},\n                                SmartCardEmulationCategory.Other,\n                                SmartCardEmulationType.Host);\nreg = await SmartCardEmulator.RegisterAppletIdGroupAsync(appletIdGroup);\nreg.RequestActivationPolicyChangeAsync(AppletIdGroupActivationPolicy.ForegroundOverride);\n```\n\n## Check for NFC and HCE support\n\nYour app should check whether a device has NFC hardware, supports the card emulation feature, and supports host card emulation prior to offering such features to the user.\n\nThe NFC smart card emulation feature is only enabled on Windows 10 Mobile, so trying to use the smart card emulator APIs in any other versions of Windows 10, will cause errors. You can check for smart card API support in the following code snippet.\n\n```csharp\nWindows.Foundation.Metadata.ApiInformation.IsTypePresent(\"Windows.Devices.SmartCards.SmartCardEmulator\");\n```\n\nYou can additionally check to see if the device has NFC hardware capable of some form of card emulation by checking if the [**SmartCardEmulator.GetDefaultAsync**](https://msdn.microsoft.com/library/windows/apps/Dn608008) method returns null. If it does, then no NFC card emulation is supported on the device.\n\n```csharp\nvar smartcardemulator = await SmartCardEmulator.GetDefaultAsync();<\n```\n\nSupport for HCE and AID-based UICC routing is only available on recently launched devices such as the Lumia 730, 830, 640, and 640 XL. Any new NFC capable devices running Windows 10 Mobile and after should support HCE. Your app can check for HCE support as follows.\n\n```csharp\nSmartcardemulator.IsHostCardEmulationSupported();\n```\n\n## Lock screen and screen off behavior\n\nWindows 10 Mobile has device-level card emulation settings, which can be set by the mobile operator or the manufacturer of the device. By default, \"tap to pay\" toggle is disabled and the \"enablement policy at device level\" is set to \"Always\", unless the MO or OEM overwrites these values.\n\nYour application can query the value of the [**EnablementPolicy**](https://msdn.microsoft.com/library/windows/apps/Dn608006) at device level and take action for each case depending on the desired behavior of your app in each state.\n\n```csharp\nSmartCardEmulator emulator = await SmartCardEmulator.GetDefaultAsync();\n\nswitch (emulator.EnablementPolicy)\n{\ncase Never:\n// you can take the user to the NFC settings to turn \"tap and pay\" on\nawait Windows.System.Launcher.LaunchUriAsync(new Uri(\"ms-settings-nfctransactions:\"));\nbreak;\n \n case Always: \nreturn \"Card emulation always on\";\n\n case ScreenOn:\n return \"Card emulation on only when screen is on\";\n\n case ScreenUnlocked:\n return \"Card emulation on only when screen unlocked\"; \n}\n```\n\nYour app's background task will be launched even if the phone is locked and/or the screen is off only if the external reader selects an AID that resolves to your app. You can respond to the commands from the reader in your background task, but if you need any input from the user or if you want to show a message to the user, you can launch your foreground app with some arguments. Your background task can launch your foreground app with the following behavior.\n\n-   Under the device lock screen (the user will see your foreground app only after she unlocks the device)\n-   Above the device lock screen (after the user dismisses your app, the device is still in locked state)\n\n```csharp\n        if (Windows::Phone::System::SystemProtection::ScreenLocked)\n        {\n            // Launch above the lock with some arguments\n            var result = await eventDetails.TryLaunchSelfAsync(\"app-specific arguments\", SmartCardLaunchBehavior.AboveLock);\n        } \n```\n\n## AID registration and other updates for SIM based apps\n\nCard emulation apps that use the SIM as the secure element can register with the Windows service to declare the AIDs supported on the SIM. This registration is very similar to an HCE-based app registration. The only difference is the [**SmartCardEmulationType**](https://msdn.microsoft.com/library/windows/apps/Dn894639), which should be set to Uicc for SIM-based apps. As the result of the payment card registration, the display name of the card will also be populated in the NFC setting menu.\n\n```csharp\nvar appletIdGroup = new SmartCardAppletIdGroup(\n                        \"Example DisplayName\", \n                                new List<IBuffer> {AID_PPSE.AsBuffer()},\n                                SmartCardEmulationCategory.Payment,\n                                SmartCardEmulationType.Uicc);\n```\n\n** Important **  \nThe legacy binary SMS intercept support in Windows Phone 8.1 has been removed and replaced with new broader SMS support in Windows 10 Mobile, but any legacy Windows Phone 8.1 apps relying on that must update to use the new Windows 10 Mobile SMS APIs.\n\n\n"}